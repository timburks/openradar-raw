apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "27064982"
    labels:
        datastore_id: "4927037735174144"
data:
    classification: Bug security
    created: "2016-06-28T22:54:45.77269Z"
    description: "Summary:\r\nInstalling or updating passcode policy policy by pushing passcode payload profiles to the device using MDM fails on OS X devices. We have attached the MDM client crash log on OS X device as well as sample payload sent to the device. \r\n\r\nWhy is this a series issue security wise?\r\nEnforcing passcode restriction using MDM is the most basic security  feature all our enterprise clients use. If the OS X device is unable to enforce those passcode restrictions on the device. it puts those devices at risk.\r\n\r\nSteps to Reproduce:\r\n1) Enroll Mac OS X device in to MDM by installing the MDM profile\r\n2) push a passcode policy profile to the OS X device with restrictions like minlength:3 and requireAlphanumeric:true\r\n3) Delete the main MDM profile from the device using the System preferences app. \r\n4) Above step will remove the passcode profile also, some time this profile will not go away.\r\n5) Reenroll the OS X device by installing MDM profile.\r\n6) try to push passcode profile to the device using install profile command by attaching the passcode payload of type com.apple.mobiledevice.passwordpolicy with restrictions like minlength:3 and requireAlphanumeric:true\r\n   \r\n\r\nExpected Results:\r\nMDM provider should be able to update/install passcode policy profile on OS X devices.\r\n\r\nActual Results:\r\nThe installtion of passcode profile fails with following error on the server side:\r\n\"ErrorDomain\" -> \"ProfileDomainPluginController\"\r\n \"ErrorCode\" -> \"101\"\r\n \"LocalizedDescription\" -> \"The operation couldn’t be completed. (ProfileDomainPluginController error 101.)\"\r\n\r\nDevice logs also shows following error:\r\nJun 28 11:48:48 tests-MacBook-Air ManagedClient[536]: *** Terminating app due to uncaught exception 'NSRangeException', reason: '*** -[__NSCFString substringFromIndex:]: Index 52 out of bounds; string length 50'\r\n\t*** First throw call stack:\r\n\t(\r\n\t\t0   CoreFoundation                      0x00007fff93ecc4f2 __exceptionPreprocess + 178\r\n\t\t1   libobjc.A.dylib                     0x00007fff92149f7e objc_exception_throw + 48\r\n\t\t2   CoreFoundation                      0x00007fff93f334bd +[NSException raise:format:] + 205\r\n\t\t3   Foundation                          0x00007fff93630faa -[NSString substringFromIndex:] + 126\r\n\t\t4   ManagedClient                       0x0000000108f27bb8 ManagedClient + 334776\r\n\t\t5   CoreFoundation                      0x00007fff93e62a54 __NSArrayEnumerate + 596\r\n\t\t6   ManagedClient                       0x0000000108f27a96 ManagedClient + 334486\r\n\t\t7   CoreFoundation                      0x00007fff93e3e28c ____NSDictionaryEnumerate_block_invoke436 + 28\r\n\t\t8   CoreFoundation                      0x00007fff93dfb190 CFBasicHashApply + 128\r\n\t\t9   CoreFoundation                      0x00007fff93e3dfa4 __NSDictionaryEnumerate + 276\r\n\t\t10  ManagedClient                       0x0000000108f279a6 ManagedClient + 334246\r\n\t\t11  ManagedClient                       0x0000000108f26a4e ManagedClient + 330318\r\n\t\t12  ManagedClient                       0x0000000108f3737a ManagedClient + 398202\r\n\t\t13  ManagedClient                       0x0000000108ee762c ManagedClient + 71212\r\n\t\t14  ManagedClient                       0x0000000108ee7810 ManagedClient + 71696\r\n\t\t15  libdispatch.dylib                   0x00007fff9844fa4b dispatch_mig_server + 403\r\n\t\t16  libdispatch.dylib                   0x00007fff9843b40b _dispatch_client_callout + 8\r\n\t\t17  libdispatch.dylib                   0x00007fff9844b675 _dispatch_source_latch_and_call + 2235\r\n\t\t18  libdispatch.dylib                   0x00007fff9843fa83 _dispatch_source_invoke + 983\r\n\t\t19  libdispatch.dylib                   0x00007fff9844e72d _dispatch_main_queue_callback_4CF + 422\r\n\t\t20  CoreFoundation                      0x00007fff93e819e9 __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__ + 9\r\n\t\t21  CoreFoundation                      0x00007fff93e408dd __CFRunLoopRun + 1949\r\n\t\t22  CoreFoundation                      0x00007fff93e3fed8 CFRunLoopRunSpecific + 296\r\n\t\t23  ManagedClient                       0x0000000108ed86ef ManagedClient + 9967\r\n\t\t24  libdyld.dylib                       0x00007fff900a15ad start + 1\r\n\t)\r\n\r\nmdmclient[531]: CPProfileManager.installProfile returning error 101 (The operation couldn‚Äôt be completed. (ProfileDomainPluginController error 101.))\r\n\r\n\r\n\r\n\r\nVersion:\r\nSystem Version: OS X 10.11.5 (15F34)\r\nKernel Version: Darwin 15.5.0\r\nModel Name:\tMacBook Air\r\nModel Identifier:\tMacBookAir6,2\r\nSerial Number (system):\tC02M33ACF6T6\r\n\r\n\r\nNotes:\r\nAddtional observation:\r\n1) If we run following command after deleting all profiles from the device: \r\npwpolicy -v getaccountpolicies\r\n\r\nIt still returns all the passcode restriction enforced by the old MDM profile even after they have been deleted. It seems that passcode policy remains enforced even after the profile are gone. \r\n\r\n2) Even if I send two command in sucession one which tries to deletes  the passcode profile and other trying to install the passcode profile, installation  of passcode profile fails.  \r\n\r\nConfiguration:\r\nInstallation of passcode profile only works for the first time, after that subsequent updates and install fail.\r\n\r\nAttachments:\r\n'System Configuration.rtf', 'MDM payload pushed to device using intall profile command.txt', 'devicelogs.txt' and 'ManagedClient_2016-06-28-114848_tests-MacBook-Air.crash' were successfully uploaded."
    email: umangdinesh@gmail.com
    modified: "2016-06-28T22:54:45.77292Z"
    number: "27064982"
    number_intvalue: 27064982
    originated: 06/28/2016
    parent_number: '&{NULL_VALUE}'
    product: OS X
    product_version: 10.11.5
    reproducible: yes
    resolved: ""
    status: Open
    title: Installing or updating OS X MDM device management passcode policy profile fails
