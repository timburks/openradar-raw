apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "28514083"
    labels:
        datastore_id: "5039109319950336"
data:
    classification: Crash/Hang/Data Loss
    created: "2016-09-28T09:56:41.04504Z"
    description: "Summary:\r\nImplementing drag-drop from an NSCollectionView with a NSFilesPromisePboardType causes some unexpected behaviour when used on macOS Sierra and El Capitan. The implementation that works for macOS Sierra, crashes on El Capitan.\r\n\r\nI've used the SlidesMagic NSCollectionView project from Ray Wenderlich as a base for the attached example project.\r\n\r\nThe project contains various setups that can be used for testing in ViewController.swift, starting here from line 131. I've attached the project, but it can also be found here:\r\n\r\nhttps://github.com/boyvanamstel/NSFilesPromisePboardType-NSCollectionView-crash\r\n\r\nSteps to Reproduce:\r\n1. Setup the NSCollectionView to allow content to be dragged from the grid.\r\n\r\noverride func viewDidLoad() {\r\n  super.viewDidLoad()\r\n  collectionView.setDraggingSourceOperationMask(NSDragOperation.copy, forLocal: false)\r\n}\r\n\r\nextension ViewController : NSCollectionViewDelegate {\r\n\r\n  [...]\r\n\r\n  func collectionView(_ collectionView: NSCollectionView, writeItemsAt indexPaths: Set<IndexPath>, to pasteboard: NSPasteboard) -> Bool {\r\n    pasteboard.clearContents()\r\n    pasteboard.declareTypes([NSFilesPromisePboardType], owner: self)\r\n    pasteboard.setPropertyList([\"jpg\"], forType: NSFilesPromisePboardType)\r\n    return true\r\n  }\r\n\r\n  func collectionView(_ collectionView: NSCollectionView, namesOfPromisedFilesDroppedAtDestination dropURL: URL, forDraggedItemsAt indexPaths: Set<IndexPath>) -> [String] {\r\n\r\n    // Write to file\r\n\r\n    return [dropURL.appendingPathComponent(\"test.jpg\").absoluteString]\r\n  }\r\n\r\n  // Seems redundant, but it's required by El Capitan. It causes a crash when running on El Capitan.\r\n  func collectionView(_ collectionView: NSCollectionView, namesOfPromisedFilesDroppedAtDestination dropURL: URL, forDraggedItemsAt indexes: IndexSet) -> [String] {\r\n\r\n    // Write to file\r\n\r\n    return [dropURL.appendingPathComponent(\"test.jpg\").absoluteString]\r\n  }\r\n\r\n}\r\n\r\n2. Compile the project and deploy it to a Mac running macOS El Capitan and one running macOS Sierra.\r\n\r\n3. Try dragging one of the images from the NSCollectionView onto your Desktop, or a Finder window.\r\n\r\n4. Drop the item.\r\n\r\nExpected Results:\r\n1. The application should indicate that the item is draggable and show its intent to drop.\r\n\r\n2. After dropping, nothing much should happen, but the app should keep running.\r\n\r\nActual Results:\r\nOn Sierra:\r\n\r\nThe app keeps running.\r\n\r\nOn El Capitan:\r\n\r\nThe app crashes, taking Finder with it, with the following crash report:\r\n\r\nProcess:               SlidesMagic [913]\r\nPath:                  /Users/USER/Desktop/SlidesMagic.app/Contents/MacOS/SlidesMagic\r\nIdentifier:            com.razeware.SlidesMagic\r\nVersion:               1.0 (1)\r\nCode Type:             X86-64 (Native)\r\nParent Process:        ??? [1]\r\nResponsible:           SlidesMagic [913]\r\nUser ID:               501\r\n\r\nDate/Time:             2016-09-28 11:35:18.315 +0200\r\nOS Version:            Mac OS X 10.11.6 (15G31)\r\nReport Version:        11\r\nAnonymous UUID:        E2E828C4-F4C1-2EE0-6239-2E04C93C5A34\r\n\r\nSleep/Wake UUID:       FF367448-5269-4753-9E1F-5EA813163500\r\n\r\nTime Awake Since Boot: 7300 seconds\r\n\r\nSystem Integrity Protection: enabled\r\n\r\nCrashed Thread:        0  Dispatch queue: com.apple.main-thread\r\n\r\nException Type:        EXC_BAD_INSTRUCTION (SIGILL)\r\nException Codes:       0x0000000000000001, 0x0000000000000000\r\nException Note:        EXC_CORPSE_NOTIFY\r\n\r\n[...]\r\n\r\nThread 0 Crashed:: Dispatch queue: com.apple.main-thread\r\n0   libswiftFoundation.dylib        0x000000010bf5b353 _TZFV10Foundation8IndexSet36_unconditionallyBridgeFromObjectiveCfGSqCSo10NSIndexSet_S0_ + 307\r\n1   SlidesMagic                     0x000000010b910b15 _TToFC11SlidesMagic14ViewController14collectionViewfTCSo16NSCollectionView40namesOfPromisedFilesDroppedAtDestinationV10Foundation3URL17forDraggedItemsAtVS2_8IndexSet_GSaSS_ + 101\r\n2   com.apple.AppKit                0x00007fff8b5e0f75 -[NSCollectionView namesOfPromisedFilesDroppedAtDestination:] + 100\r\n3   com.apple.AppKit                0x00007fff8b56024d -[NSFilePromiseDragSource getFilenamesAndDropLocation] + 70\r\n4   com.apple.AppKit                0x00007fff8b0b9923 -[NSFilePromiseDragSource pasteboard:provideDataForType:itemIdentifier:] + 79\r\n5   com.apple.AppKit                0x00007fff8b0b83e7 __NSPasteboardProvideData + 331\r\n6   com.apple.CoreFoundation        0x00007fff94f3cc04 __CFPasteboardClientCallBack + 1364\r\n7   com.apple.CoreFoundation        0x00007fff94f18628 __CFMessagePortPerform + 584\r\n8   com.apple.CoreFoundation        0x00007fff94e80019 __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__ + 41\r\n9   com.apple.CoreFoundation        0x00007fff94e7ff89 __CFRunLoopDoSource1 + 473\r\n10  com.apple.CoreFoundation        0x00007fff94e779bb __CFRunLoopRun + 2171\r\n11  com.apple.CoreFoundation        0x00007fff94e76ed8 CFRunLoopRunSpecific + 296\r\n12  com.apple.CoreFoundation        0x00007fff94edc925 CFMessagePortSendRequest + 949\r\n13  com.apple.HIServices            0x00007fff9330e7dc SendDragIPCMessage + 530\r\n14  com.apple.HIServices            0x00007fff93306b29 SendDropMessage + 64\r\n15  com.apple.HIServices            0x00007fff93305807 DragInApplication + 505\r\n16  com.apple.HIServices            0x00007fff933046cf CoreDragStartDragging + 705\r\n17  com.apple.AppKit                0x00007fff8b01f369 -[NSCoreDragManager _dragUntilMouseUp:accepted:] + 1010\r\n18  com.apple.AppKit                0x00007fff8b01c557 -[NSCoreDragManager dragImage:fromWindow:at:offset:event:pasteboard:source:slideBack:] + 1212\r\n19  com.apple.AppKit                0x00007fff8b01c089 -[NSWindow(NSDrag) dragImage:at:offset:event:pasteboard:source:slideBack:] + 135\r\n20  com.apple.AppKit                0x00007fff8b5e1543 -[NSCollectionView _startDragWithItemsAtIndexPaths:event:pasteboard:] + 345\r\n21  com.apple.AppKit                0x00007fff8b5e178a -[NSCollectionView _writeToPasteboardAndBeginDragForIndexPaths:event:] + 182\r\n22  com.apple.AppKit                0x00007fff8b45559f -[NSCollectionViewMouseSession _performDragFromMouseDown:] + 774\r\n23  com.apple.AppKit                0x00007fff8b455c5e -[NSCollectionViewMouseSession handleEvent:] + 927\r\n24  com.apple.AppKit                0x00007fff8b45644d -[NSCollectionViewMouseSession trackWithEvent:] + 132\r\n25  com.apple.AppKit                0x00007fff8b5e0724 -[NSCollectionView mouseDown:] + 213\r\n26  com.apple.AppKit                0x00007fff8aeed634 forwardMethod + 126\r\n27  com.apple.AppKit                0x00007fff8aeed634 forwardMethod + 126\r\n28  com.apple.AppKit                0x00007fff8aeed634 forwardMethod + 126\r\n29  com.apple.AppKit                0x00007fff8afdbc8e -[NSControl mouseDown:] + 1091\r\n30  com.apple.AppKit                0x00007fff8b5303c9 -[NSWindow _handleMouseDownEvent:isDelayedEvent:] + 6322\r\n31  com.apple.AppKit                0x00007fff8b5313ad -[NSWindow _reallySendEvent:isDelayedEvent:] + 212\r\n32  com.apple.AppKit                0x00007fff8af70539 -[NSWindow sendEvent:] + 517\r\n33  com.apple.AppKit                0x00007fff8aef0a38 -[NSApplication sendEvent:] + 2540\r\n34  com.apple.AppKit                0x00007fff8ad57df2 -[NSApplication run] + 796\r\n35  com.apple.AppKit                0x00007fff8ad21368 NSApplicationMain + 1176\r\n36  SlidesMagic                     0x000000010b916cb4 main + 84\r\n37  libdyld.dylib                   0x00007fff975f25ad start + 1\r\n\r\nVersion:\r\nXcode Version 8.0 (8A218a) & 8.1 beta (8T29o)\r\n\r\nNotes:\r\nI have not been able to test compiling the app on macOS El Capitan. The bug seems to be present in the latest beta versions of Xcode and its SDKs.\r\n\r\nConfiguration:\r\nOS X 10.12 Sierra (16A323)\r\nXcode Version 8.0 (8A218a) & 8.1 beta (8T29o)\r\n2,3 GHz Intel Core i7\r\n16 GB 1600 MHz DDR3\r\n\r\nAttachments:\r\n'SlidesMagic-bugreport.zip' and 'SlidesMagic_2016-09-28-113531_Dangers-Mac.crash' were successfully uploaded."
    email: boy@dangercove.com
    modified: "2016-09-28T09:56:41.04534Z"
    number: "28514083"
    number_intvalue: 28514083
    originated: 28-09-2016
    parent_number: '&{NULL_VALUE}'
    product: macOS SDK
    product_version: ""
    reproducible: Always
    resolved: ""
    status: Open
    title: NSFilesPromisePboardType drag from NSCollectionView works on macOS Sierra, causes crash on El Capitan
