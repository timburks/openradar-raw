apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "27739991"
    labels:
        datastore_id: "5047250698895360"
data:
    classification: ""
    created: "2016-09-21T07:01:49.87445Z"
    description: "Chaoqun Zou11-Aug-2016 01:49 PM\r\n\r\nHi, I used an app \"BlueChat\" to capture the logs. (https://github.com/zouchaoqun/BlueChat)\r\n\r\nThe BlueChat app works in both Central and Peripheral roles. In the test I had two devices, one iPhone working as peripheral, one iPad mini working as central and the logs are from the iPad mini (iOS 9.3.4). \r\n(the iPhone is running on iOS 10 beta 5, but if you try iOS 9 it will be the same result) \r\n\r\nI tried two scenarios which are both included in the logs:\r\n\r\n(log entries mentioned below are from BTServer_2016_08_11_12_15_56+0930.log)\r\n\r\nScenario 1: \r\n(1) from iPad mini, use the BlueChat app (central) to connect to the BlueChat app (peripheral) running on iPhone\r\n(2) from iPad mini, write to a characteristic with permission CBAttributePermissionsWriteEncryptionRequired\r\n(3) there should be Pairing popups on both the iPhone and the iPad, choose Pair on both ends\r\n(4) from iPad mini, we can see the didWriteValueForCharacteristic:error: callback is invoked correctly\r\n\r\n{logs}\r\n2016-08-11T12:22:15.546 XpcLeConnection.cpp:57    handleMsg            Notice     XPC        Received XPC message \"CBMsgIdCharacteristicWriteValue\" from session \"com.schneider-electric.BlueChat-central-321-1\"\r\n2016-08-11T12:22:15.546 GattGateway.cpp:437       writeCharacteristic  Notice     ATT        Writing value with response to characteristic handle 0x0045 on device \"400AE3F9-AE8E-06B2-0C68-351B7B83BE74\"\r\n2016-08-11T12:22:15.547 GattCommands.cpp:1159     runCommand           Notice     ATT        Using Write Characteristic value\r\n2016-08-11T12:22:15.601 XpcLeConnection.cpp:95    sendMsg              Notice     XPC        Sending XPC message \"CBMsgIdCharacteristicValueWritten\" to session \"com.schneider-electric.BlueChat-central-321-1\"\r\n{logs}\r\n\r\n\r\nScenario 2 (continuing scenario 1):\r\n(5) on the iPhone, go to Settings -> Bluetooth, forget the iPad mini\r\n(6) from the iPad mini, try to write to the same characteristic again\r\n(7) didWriteValueForCharacteristic:error: callback is NOT invoked (from the logs we can see there is a line saying the encryption was disabled, but no XPC message is sent back to the user app)\r\n\r\n{logs-1}\r\n2016-08-11T12:23:25.862 XpcLeConnection.cpp:57    handleMsg            Notice     XPC        Received XPC message \"CBMsgIdCharacteristicWriteValue\" from session \"com.schneider-electric.BlueChat-central-321-1\"\r\n2016-08-11T12:23:25.864 GattGateway.cpp:437       writeCharacteristic  Notice     ATT        Writing value with response to characteristic handle 0x0045 on device \"400AE3F9-AE8E-06B2-0C68-351B7B83BE74\"\r\n2016-08-11T12:23:25.864 GattCommands.cpp:1159     runCommand           Notice     ATT        Using Write Characteristic value\r\n2016-08-11T12:23:25.913 LeDeviceManager.cpp:469   uuidForDevice        Info       LE         Already tracking address \"Public 9C:35:EB:B8:1C:47\" as device \"400AE3F9-AE8E-06B2-0C68-351B7B83BE74\"\r\nOI_ERROR> LE:224  [65535]\r\n2016-08-11T12:23:26.033 LeSecurityManager.mm:1869 encryptionStatusChangedCb Notice     LE         encryptionStatusChangedCb handle:0x000000014A003190 status=BM3 STATUS 706 address=9C:35:EB:B8:1C:47\r\n2016-08-11T12:23:26.033 LeDeviceManager.cpp:469   uuidForDevice        Info       LE         Already tracking address \"Public 9C:35:EB:B8:1C:47\" as device \"400AE3F9-AE8E-06B2-0C68-351B7B83BE74\"\r\n2016-08-11T12:23:26.033 LeSecurityManager.mm:1492 encryptionStatusChanged Notice     LE         Encryption is now disabled for device \"400AE3F9-AE8E-06B2-0C68-351B7B83BE74\" (9C:35:EB:B8:1C:47)\r\n2016-08-11T12:23:27.098 SystemSettings.cpp:495    ___ZN2BT14SystemSettings18takePowerAssertionEt_block_invoke_2 Notice     Core       Releasing power assertion\r\n{logs-1}\r\n\r\nthen I tried to write again after about 15 seconds and still no callback\r\n{logs-2}\r\n......some log entries omitted......\r\n2016-08-11T12:23:42.352 XpcLeConnection.cpp:57    handleMsg            Notice     XPC        Received XPC message \"CBMsgIdCharacteristicWriteValue\" from session \"com.schneider-electric.BlueChat-central-321-1\"\r\n2016-08-11T12:23:42.352 GattGateway.cpp:437       writeCharacteristic  Notice     ATT        Writing value with response to characteristic handle 0x0045 on device \"400AE3F9-AE8E-06B2-0C68-351B7B83BE74\"\r\n2016-08-11T12:23:45.367 AppManager.cpp:1350       disconnectUnusedDevices Info       Core       Session \"com.schneider-electric.BlueChat-central-321-1\" wants connected device \"400AE3F9-AE8E-06B2-0C68-351B7B83BE74\"\r\n{logs-2}\r\n\r\nthen I tried again after about 1 minute and still no callback\r\n{logs-3}\r\n......some log entries omitted......\r\n2016-08-11T12:24:40.424 AppManager.cpp:1350       disconnectUnusedDevices Info       Core       Session \"com.schneider-electric.BlueChat-central-321-1\" wants connected device \"400AE3F9-AE8E-06B2-0C68-351B7B83BE74\"\r\n2016-08-11T12:24:41.133 XpcLeConnection.cpp:57    handleMsg            Notice     XPC        Received XPC message \"CBMsgIdCharacteristicWriteValue\" from session \"com.schneider-electric.BlueChat-central-321-1\"\r\n2016-08-11T12:24:41.134 GattGateway.cpp:437       writeCharacteristic  Notice     ATT        Writing value with response to characteristic handle 0x0045 on device \"400AE3F9-AE8E-06B2-0C68-351B7B83BE74\"\r\n2016-08-11T12:24:45.429 AppManager.cpp:1350       disconnectUnusedDevices Info       Core       Session \"com.schneider-electric.BlueChat-central-321-1\" wants connected device \"400AE3F9-AE8E-06B2-0C68-351B7B83BE74\"\r\n2016-08-11T12:24:46.342 XpcConnection.cpp:58      handleEvent          Notice     XPC        Closed XPC connection to session \"com.schneider-electric.BlueChat-peripheral-321-0\"\r\n{logs-3}\r\n\r\n'Logs-2016.8.11-12.25.18.zip' was successfully uploaded.\r\nApple Developer Relations11-Aug-2016 06:20 AM\r\n\r\nEngineering has requested the following information in order to further investigate this issue:\r\n\r\nPlease collect Bluetooth logs and attach them to your bug report.\r\n\r\niOS Bluetooth Logging Instructions:\Lhttps://developer.apple.com/services-account/download?path=/iOS/iOS_Logs/Bluetooth_Logging_Instructions__iPhone_and_Apple_Watch.pdf\r\n\r\niOS Bluetooth Logging Profile:\r\nhttps://developer.apple.com/services-account/download?path=/iOS/iOS_Logs/bluetoothwirelessproximity.mobileconfig\r\n\r\n____________________________________\r\nFor a complete list of logging instructions visit:\r\nhttps://developer.apple.com/bug-reporting/profiles-and-logs/\r\nChaoqun Zou09-Aug-2016 11:14 AM\r\n\r\nHi, there is not really related logs for this issue. I am not very sure what you are looking for. Can you please let me know what else do you need?\r\nApple Developer Relations09-Aug-2016 02:45 AM\r\n\r\nPlease attach any relevant crash logs, panic logs, stackshots, baseband logs, etc which may have been generated automatically. If none were, install the appropriate logging profile, reproduce the issue, then attach relevant logs.\r\n\r\nFor a complete list of logging instructions visit:\r\nhttps://developer.apple.com/bug-reporting/profiles-and-logs/\r\n\r\nPlease provide your response or results by updating your bug report.  If uploading files, please compress first.\r\nChaoqun Zou08-Aug-2016 09:30 AM\r\n\r\nSummary:\r\nThis relates to #27579701\r\n\r\nWe are developing a simple BLE peripheral with Just works pairing and we recently found an issue in the pairing. So the issue happens like this:\r\n\r\n(1) Pair the iPhone to the peripheral for the first time and it works fine (our peripheral rejects the read request with Insufficient Authentication correctly and we can see the iOS Pairing popup and Pairing succeeds)\r\n(2) Remove the bonding record of the iPhone from the peripheral (the iPhone still remembers the peripheral)\r\n(3) Use the same iPhone to connect to the device again and our peripheral still rejects the read request with Insufficient Authentication correctly but iOS does not give any error that the read request has failed in the didUpdateValueForCharacteristic (actually didUpdateValueForCharacteristic is not called after the read failure)\r\n\r\nI can reproduce the same problem between two iPhones (tried iOS 9 and 10 beta). e.g. pair two iPhones first, then forget the other party on one phone, when the other phone tries to connect again it can't connect and it does not show the Pairing popup either.\r\n\r\nSteps to Reproduce:\r\n(1) Run BLE test app on two iPhones, one as central the other as peripheral. the test app should include at least one characteristic with GATT_PERMIT_AUTHEN_READ and  GATT_PERMIT_AUTHEN_WRITE\r\n(2) From the central role, connect to the peripheral role and try to read that characteristic\r\n(3) there should be a pairing dialog asking for pairing, pair\r\n(4) verify the central can read and write correctly\r\n(5) on the peripheral go to Settings - Bluetooth and forget the central iPhone\r\n(6) use the central iPhone to connect and read the characteristic again, you will see it can't read, but the didUpdateValueForCharacteristic will never be called\r\n\r\nExpected Results:\r\nIn step (6) didUpdateValueForCharacteristic should be called with an error like CBATTErrorInsufficientEncryption so we know the read has failed.\r\n\r\nActual Results:\r\nIn step (6) didUpdateValueForCharacteristic is never called \r\n\r\nVersion:\r\niOS 9.3.3 iOS 10 beta 4\r\n\r\nNotes:\r\n\r\n\r\nConfiguration:\r\niPhone 5S iPad Pro 9.7\r\n\r\nAttachments:"
    email: max.zou.se@gmail.com
    modified: "2016-09-21T07:01:49.87484Z"
    number: "27739991"
    number_intvalue: 27739991
    originated: 08/08/2016
    parent_number: '&{NULL_VALUE}'
    product: iOS SDK
    product_version: "10"
    reproducible: Always
    resolved: ""
    status: Open
    title: CoreBluetooth CBPeripheralDelegate didUpdateValueForCharacteristic not called after after the peripheral removes the bonding record
