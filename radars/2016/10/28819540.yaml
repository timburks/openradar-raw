apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "28819540"
    labels:
        datastore_id: "5584091546124288"
data:
    classification: Bluetooth
    created: "2016-10-18T08:10:21.84207Z"
    description: "Summary:\r\nIt seems that iPhone acting as BLE Central device doesn't always respond correctly to modification of services at the peripheral side.\r\n\r\nSome extra information from our Android engineer:\r\n\r\nConfiguration:\r\nPersonalNavigationDevice/PND (peripheral role, GATT server) <-> iPhone (central role, GATT client), paired\r\n\r\nDescription:\r\nThe problem seems to happen because iOS does not fetch GATT services even if Service Changed indication is sent to it. So when Android BT service needs to restart, Bluedroid cleans up the existing GATT server. When this clean up happens, Bluedroid sends Service Changed indication to iOS and iOS fetches new services (which are none). It remembers that the Peripheral has no services. When BT service is started again, it sets up new GATT server and this also sends Service Changed indication to iOS. iOS ignores it and thinks there are no services available at the Peripheral.\r\n\r\nIt looks to us that iOS incorrectly handles invalidation of ATT handles caused by GATT service change on PND. Whenever a GATT service is added or removed on PND, \"Service Changed\" (according to BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part G, 7.1]) is sent to iOS to indicate that it needs to re-fetch GATT services and update ATT handles. This is illustrated in the attached HCI dump under frames:\r\n\r\n#389 - Service Changed\r\n#396 - iOS fetching PND Primary services and following up, characteristics\r\n#443 - iOS subscribing to Service Changed indication\r\nWe noticed that sometimes during the operation if a GATT service is removed and then again added back on PND, iOS is not fetching GATT services correctly, which leads to a situation where iOS \"thinks\" there are not services available on PND (due to correct handling of service removal Service Changed indication, but incorrect handling of Service Changed indication during service addition), this is illustrated in the attached HCI dump under frames:\r\n#5643 - Service Changed triggered by GATT service removal on PND\r\n#5648 - iOS performs Primary service search\r\n#5651 - PND replies on Primary service search reporting no services available (apart from the required by GATT)\r\n#5709 - (8 seconds later) Service Changed triggered by GATT service add on PND\r\n#5736 - iOS performs characteristic search for GATT profile, but does not perform Primary service changed\r\nAny attmept to fetch PND GATT services from an application running on iOS reports no services available.\r\nExpected:\r\niOS performs Primary service search on receiving Service Changed indication. So basically, as a reaction of frame #5709 it should do what it does as a reaction of frame #389 or frame #5643.\r\n\r\nSteps to Reproduce:\r\nWe are able to reproduce the problem in the following scenario. \r\n\r\n1. BLE Central (iPhone) is connected to BLE Peripheral (Android-based PND). iPhone has previously discovered two services (7BBB5350-52B1-11E3-8F96-0800200C9A66 and 8ED067D5-C74E-4D0D-B637-53280C0EB5BB) that it needs to communicate with.\r\n2. BLE Peripheral decides to restart these services.\r\n3. BLE Peripheral stops both services that are needed by the iPhone. Then, it starts them again.\r\n4. iPhone app's peripheral manager receives -peripheral:didModifyServices: callback with both services being marked invalidated.\r\n5. iPhone app decides that it cannot continue with the current peripheral connection and cancels it.\r\n6. iPhone app starts to search for new peripherals advertising these services.\r\n7. iPhone discovers a previously disconnected peripheral that already has both services re-initialized and available.\r\n8. iPhone app connects to the peripheral by calling -connectPeripheral:options: method.\r\n9. iPhone app's peripheral manager calls -discoverServices: method.\r\n10. iPhone app's peripheral manager receives -peripheral:didDiscoverServices: callback with 0 services discovered.\r\n\r\nAt this point, iPhone won't see re-created services until its BT switch is toggled off or on, restarting the app doesn't help.\r\n\r\nExpected Results:\r\nAfter the peripheral device invalidates and recreates its advertised services, central device should be able to reconnect to it and see updated services.\r\n\r\nActual Results:\r\nBLE Central device is able to reconnect after the services are invalidated by the peripheral, but the newly added services are not found.\r\n\r\nVersion:\r\niOS 9, 10\r\n\r\nNotes:\r\n\r\nConfiguration:\r\niPhone 6, TomTom GO 6200 (Android 5.1)\r\n\r\nAttachments:\r\n'sysdiagnose_2016.10.10_15-34-05+0200.tar.gz' and 'hci_snoop20161010153157.cfa' were successfully uploaded."
    email: zmicier.zaleznicenka@gmail.com
    modified: "2016-10-18T08:10:21.84235Z"
    number: "28819540"
    number_intvalue: 28819540
    originated: 18-10-2016
    parent_number: '&{NULL_VALUE}'
    product: iOS
    product_version: 9, 10
    reproducible: Yes
    resolved: no
    status: Open
    title: 'CoreBluetooth: central device handles services change at the peripheral incorrectly'
