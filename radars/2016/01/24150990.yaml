apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "24150990"
    labels:
        datastore_id: "4962407260618752"
data:
    classification: ""
    created: "2016-01-22T09:40:35.65783Z"
    description: "Boris Sotillos\r\n12-Jan-2016 06:57 PM\r\n\r\nSummary:\r\nNSBundleResourceRequest::progress::cancel is causing the framework's download thread to throw an exception, and apparently, it is not cleaning up properly, causing a deadlock that makes itself evident on the next recovery/request.\r\n\r\nI would expect that at least, if cancellation is not possible, the framework completes downloads but does not crash.\r\nNote that progress::isCancellable returns YES\r\n \r\nIf we run the demo application with an Exception Breakpoint enabled for all exceptions, on throw (see cancel.png).\r\nWe get the console output:\r\n2016-01-12 18:08:54.214 crappy[1047:2673618] 1\r\n2016-01-12 18:08:54.217 crappy[1047:2673618] 2 cancellable = 1\r\n2016-01-12 18:08:54.228 crappy[1047:2673641] conditionallyBeginAccessingResourcesWithCompletionHandler downloadRequired = 1\r\n2016-01-12 18:08:55.219 crappy[1047:2673618] 3\r\n2016-01-12 18:08:55.219 crappy[1047:2673618] 4 downloadRequired = 1 \r\n2016-01-12 18:08:55.221 crappy[1047:2673618] 6\r\n2016-01-12 18:09:01.228 crappy[1047:2673618] 7 cancel\r\n2016-01-12 18:09:01.228 crappy[1047:2673641] cancellationHandler\r\n\r\nAnd then, an exception break, caused by an objc_exception_throw.\r\n\r\nIf we run the app without enabling Exception breaks, we get the console output:\r\n\r\n2016-01-12 18:09:46.666 crappy[1052:2673996] 1\r\n2016-01-12 18:09:46.670 crappy[1052:2673996] 2 cancellable = 1\r\n2016-01-12 18:09:46.680 crappy[1052:2674014] conditionallyBeginAccessingResourcesWithCompletionHandler downloadRequired = 1\r\n2016-01-12 18:09:47.671 crappy[1052:2673996] 3\r\n2016-01-12 18:09:47.672 crappy[1052:2673996] 4 downloadRequired = 1 \r\n2016-01-12 18:09:47.674 crappy[1052:2673996] 6\r\n2016-01-12 18:09:53.679 crappy[1052:2673996] 7 cancel\r\n2016-01-12 18:09:53.679 crappy[1052:2674015] cancellationHandler\r\n2016-01-12 18:09:53.691 crappy[1052:2674013] <NSXPCConnection: 0x12fe2d0e0> connection to service named com.apple.ondemandd.client: Warning: Exception caught during decoding of received reply to message 'pinTags:inBundle:priority:completionHandler:', dropping incoming message and calling failure block.\r\n\r\nException: Unable to add the URL file:///var/mobile/Library/OnDemandResources/AssetPacks/com.gameloft.test-d/7671957809540947968/com.gameloft.test-d.asset-pack-00000008JP3H9.assetpack/ to the bundle NSBundle </var/mobile/Containers/Bundle/Application/0EA25FB2-1DA3-46B5-988C-94454E857F32/crappy.app> (loaded)\r\n2016-01-12 18:09:53.692 crappy[1052:2674013] beginAccessingResourcesWithCompletionHandler\r\n2016-01-12 18:09:54.681 crappy[1052:2673996] 8\r\n2016-01-12 18:09:54.682 crappy[1052:2673996] 9\r\n2016-01-12 18:09:54.694 crappy[1052:2674013] conditionallyBeginAccessingResourcesWithCompletionHandler downloadRequired = 1\r\n2016-01-12 18:09:55.684 crappy[1052:2673996] 10\r\n2016-01-12 18:09:55.684 crappy[1052:2673996] 11 downloadRequired = 1\r\n2016-01-12 18:09:55.685 crappy[1052:2673996] 12\r\na2016-01-12 18:10:30.510 crappy[1052:2674013] *** -[NSLock lock]: deadlock (<NSLock: 0x12fe2cf30> '(null)')\r\n2016-01-12 18:10:30.510 crappy[1052:2674013] *** Break on _NSLockError() to debug.\r\n\r\nwhich also exhibits the same behaviour.\r\n\r\nSteps to Reproduce:\r\nI'm attaching a tvOS xcode project\r\nrun it, following instruction on the \"description\"\r\n\r\nExpected Results:\r\ncancellation of the resource request\r\n\r\nActual Results:\r\ninternally throws on cancel, that causes ulterior deadlock\r\n\r\nVersion:\r\napple TV 9.1 (13U85)\r\n\r\nNotes:\r\n\r\n\r\nConfiguration:\r\nATV using LAN\r\n\r\nAttachments:\r\n'crappy_cancel.zip' was successfully uploaded.\r\n\r\n=======================================================================================================================================\r\n\r\nApple Developer Relations\r\n14-Jan-2016 09:38 PM\r\n\r\nDo you still see this issue in the latest iOS 9.3 beta release?\r\n\r\nPlease test with this release.  If you still have issues, please update your bug report with any relevant logs or information that could help us investigate.\r\n\r\niOS 9.3\r\nhttps://developer.apple.com/ios/download/\r\n\r\n=======================================================================================================================================\r\n\r\nApple Developer Relations\r\n25-Jan-2016 10:42 PM\r\n\r\nDo you still see this issue in the latest iOS Beta?\r\n\r\nPlease test with the latest Beta.  If you still have issues, please update your bug report with any relevant logs or information that could help us investigate.\r\n\r\niOS\r\nhttps://developer.apple.com/ios/download/\r\n\r\n=======================================================================================================================================\r\n\r\nBoris Sotillos\r\n26-Jan-2016 09:49 AM\r\n\r\nHi,\r\nI'll be trying to reproduce this. When I have the time.\r\n\r\n=======================================================================================================================================\r\n\r\nBoris Sotillos\r\n26-Jan-2016 11:26 AM\r\n\r\nBTW.\r\nThe application is a tvOS application, not an iOS application.\r\nI'll be trying tvOS 9.2 beta 2\r\n\r\n=======================================================================================================================================\r\n\r\nBoris Sotillos\r\n28-Jan-2016 04:32 PM\r\n\r\nRetested with tvOS 9.2 beta 2 (12Y5189e), compiled on Xcode 7.3 beta (7D129n)\r\n\r\nTHE ISSUE HAS BEEN FIXED."
    email: borissotillos@gmail.com
    modified: "2016-01-28T15:43:19.02073Z"
    number: "24150990"
    number_intvalue: 24150990
    originated: 12-Jan-2016 06:57 PM
    parent_number: '&{NULL_VALUE}'
    product: tvOS SDK
    product_version: apple TV 9.1 (13U85)
    reproducible: 100%
    resolved: 28-Jan-2016
    status: closed
    title: NSBundleResourceRequest::progress::cancel throws an exception
