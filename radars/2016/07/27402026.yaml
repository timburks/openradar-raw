apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "27402026"
    labels:
        datastore_id: "4961743486844928"
data:
    classification: Serious Bug
    created: "2016-07-18T14:27:24.65585Z"
    description: "Disk image signing is available in 10.11.4 and later. https://developer.apple.com/library/prerelease/content/technotes/tn2206/_index.html#//apple_ref/doc/uid/DTS40007919-CH1-TNTAG18\r\n\r\nWhen re-signing an already-signed disk image with codesign --sign --force, the disk image may be broken, rendered unreadable. This happens on approximately half of all re-sign attempts.\r\n\r\nUDIF disk image is normally laid out with its UDIF header occupying the final 512 bytes of the file. The UDIF header is identified by its magic number (“koly”) and version number (currently 4). When codesign --sign adds a signature to an unsigned disk image, the signature is placed at the same file offset where the UDIF header had been located, and the UDIF header is re-written after the signature so that it still occupies the final 512 bytes of the file.\r\n\r\nWhen codesign --sign --force re-signs an already-signed disk image, the signature is placed at the same file offset as the existing signature, replacing it, and the UDIF header is re-written after the signature. If the new signature is the same length as the existing signature, or if the new signature is longer, the disk image file remains the same size or grows, and the disk image remains usable. However, if the new signature is shorter than the old signature, the UDIF header as re-written is not in the correct location, because the disk image file is not truncated immediately following the UDIF header. The disk image file remains the same size, but the UDIF header is more than 512 bytes from the end of the file.\r\n\r\nSteps to Reproduce:\r\nCreate a disk image file, sign it with codesign --sign, and then re-sign it with codesign --sign --force repeatedly until the disk image is rendered unusable (or until you’ve done it enough times that you’ve seen the disk image file size shrink and can ascertain that it’s behaving correctly):\r\n\r\n$ mkdir empty\r\n$ hdiutil create -srcdir empty -fs HFS+ -format UDZO -imagekey zlib-level=9 -o empty.dmg\r\n.\r\ncreated: …/empty.dmg\r\n$ codesign --sign='Developer ID Application: Me' empty.dmg\r\n\r\nNow repeat these next two commands:\r\n\r\n$ codesign --sign='Developer ID Application: Me' --force empty.dmg\r\nempty.dmg: replacing existing signature\r\n$ hdiutil imageinfo empty.dmg > /dev/null\r\n\r\nExpected Results:\r\n$ mkdir empty\r\n$ hdiutil create -srcdir empty -fs HFS+ -format UDZO -imagekey zlib-level=9 -o empty.dmg\r\n.\r\ncreated: …/empty.dmg\r\n$ codesign --sign='Developer ID Application: Me' empty.dmg\r\n$ codesign --sign='Developer ID Application: Me' --force empty.dmg\r\nempty.dmg: replacing existing signature\r\n$ hdiutil imageinfo empty.dmg > /dev/null\r\n$ codesign --sign='Developer ID Application: Me' --force empty.dmg\r\nempty.dmg: replacing existing signature\r\n$ hdiutil imageinfo empty.dmg > /dev/null\r\n$ codesign --sign='Developer ID Application: Me' --force empty.dmg\r\nempty.dmg: replacing existing signature\r\n$ hdiutil imageinfo empty.dmg > /dev/null\r\n\r\n(No failures detected, and at some point, you observe empty.dmg shrinking in size and can stop testing.)\r\n\r\n$ codesign --verify --verbose empty.dmg\r\nempty.dmg: valid on disk\r\nempty.dmg: satisfies its Designated Requirement\r\n\r\nActual Results:\r\n$ mkdir empty\r\n$ hdiutil create -srcdir empty -fs HFS+ -format UDZO -imagekey zlib-level=9 -o empty.dmg\r\n.\r\ncreated: …/empty.dmg\r\n$ codesign --sign='Developer ID Application: Me' empty.dmg\r\n$ codesign --sign='Developer ID Application: Me' --force empty.dmg\r\nempty.dmg: replacing existing signature\r\n$ hdiutil imageinfo empty.dmg > /dev/null\r\n$ codesign --sign='Developer ID Application: Me' --force empty.dmg\r\nempty.dmg: replacing existing signature\r\n$ hdiutil imageinfo empty.dmg > /dev/null\r\nhdiutil: imageinfo failed - image not recognized\r\n\r\n$ codesign --verify --verbose empty.dmg\r\nempty.dmg: code object is not signed at all\r\n\r\nAt this point, you can see that codesign has broken the disk image. Neither hdiutil nor codesign can make any sense of it as a disk image any longer. You can examine what’s supposed to be the UDIF header in the final 512 bytes of the file:\r\n\r\n$ tail -c 512 empty.dmg | hexdump -C\r\n00000000  6f 6c 79 00 00 00 04 00  00 02 00 00 00 00 01 00  |oly.............|\r\n00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\r\n00000020  00 00 00 00 00 08 23 00  00 00 00 00 00 00 00 00  |......#.........|\r\n00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\r\n*\r\n000000d0  00 00 00 00 00 00 00 00  00 00 00 00 00 08 23 00  |..............#.|\r\n000000e0  00 00 00 00 00 1f 99 00  00 00 00 00 00 00 00 00  |................|\r\n000000f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\r\n*\r\n00000120  00 00 00 00 00 00 00 00  00 00 00 00 00 27 bc 00  |.............'..|\r\n00000130  00 00 00 00 00 24 98 00  00 00 00 00 00 00 00 00  |.....$..........|\r\n00000140  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\r\n*\r\n00000160  00 00 02 00 00 00 20 7b  a8 58 9d 00 00 00 00 00  |...... {.X......|\r\n00000170  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\r\n*\r\n000001e0  00 00 00 00 00 00 00 00  00 00 01 00 00 00 00 00  |................|\r\n000001f0  00 07 c8 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\r\n00000200\r\n\r\nHere, you can see because of the incomplete magic number (should be “koly”) that the file should have been truncated to be one byte shorter than it currently is. If the file is truncated to this length, it begins working again:\r\n\r\n$ stat -f %z empty.dmg\r\n20053\r\n$ python\r\n[…]\r\n>>> import os\r\n>>> os.ftruncate(os.open(\"empty.dmg\", os.O_WRONLY), 20052)\r\n>>> ^D\r\n$ hdiutil imageinfo empty.dmg > /dev/null\r\n$ codesign --verify --verbose empty.dmg\r\nempty.dmg: valid on disk\r\nempty.dmg: satisfies its Designated Requirement\r\n\r\nVersion:\r\n10.11.5 15F34\r\n10.12dp2 16A239j"
    email: mark@chromium.org
    modified: "2016-07-18T14:27:24.65606Z"
    number: "27402026"
    number_intvalue: 27402026
    originated: "2016-07-18"
    parent_number: '&{NULL_VALUE}'
    product: OS X
    product_version: 10.11.5 15F34
    reproducible: Sometimes
    resolved: ""
    status: Open
    title: codesign --sign --force breaks disk images
