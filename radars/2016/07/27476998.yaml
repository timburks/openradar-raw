apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "27476998"
    labels:
        datastore_id: "5001147395866624"
data:
    classification: Bug
    created: "2016-07-21T19:27:31.693Z"
    description: "This issue resolved in iOS 10 Beta 4 [14A5322e].\r\n\r\nArea:\r\nAVFoundation (Audio / Video)\r\n\r\nSummary:\r\nAVSampleBufferDisplayLayer does not display an IOSurface-backed CVPixelBufferRef (kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange) on iOS 10.\r\n\r\nSteps to Reproduce:\r\nLaunch the demo attached. Important sample code is in ViewController.m\r\n1) Create a CVPixelBufferRef backed by an IOSurface (kCVPixelBufferIOSurfacePropertiesKey attribute)\r\n2) Wrap that pixel buffer in a CMSampleBufferRef with settings for immediate display\r\n3) Enqueue the sample buffer in an AVSampleBufferDisplayLayer\r\n\r\nExpected Results:\r\nOn iOS 9 and earlier, this displays the pixel buffer content (centered green screen in the sample app).\r\n\r\nActual Results:\r\nOn iOS 10 the layer appears completely transparent.\r\n\r\nVersion:\r\niOS 10.0 [14A5309d]\r\n\r\nNotes:\r\nRelevant code is in the -displayTestBuffer method in ViewController.m.\r\n\r\nCompiling with Xcode 7.3.x (iOS 9 SDK) vs 8.0 (iOS 10 SDK) does not seem to have any effect. Using direct allocation for the buffer vs using a buffer pool also does not seem to have any effect.\r\n\r\nConfiguration:\r\niPhone 6, 64GB, AT&T and various others\r\n\r\n\r\nExcerpt from sample code submitted with report:\r\n===================\r\n\r\n@import AVFoundation;\r\n@import UIKit;\r\n@import CoreVideo;\r\n\r\n@interface SampleBufferView : UIView\r\n@property (nonatomic, readonly) AVSampleBufferDisplayLayer *sampleBufferDisplayLayer;\r\n@end\r\n\r\n@implementation SampleBufferView\r\n+ (Class)layerClass {\r\n    return [AVSampleBufferDisplayLayer class];\r\n}\r\n- (AVSampleBufferDisplayLayer *)sampleBufferDisplayLayer {\r\n    return (AVSampleBufferDisplayLayer *)self.layer;\r\n}\r\n@end\r\n\r\n@interface ViewController : UIViewController\r\n@end\r\n\r\n@interface ViewController ()\r\n@property (nonatomic, readonly) SampleBufferView *sampleBufferView;\r\n@end\r\n\r\n@implementation ViewController\r\n\r\n- (void)loadView {\r\n    self.view = [SampleBufferView new];\r\n}\r\n\r\n- (SampleBufferView *)sampleBufferView {\r\n    return (SampleBufferView *)self.view;\r\n}\r\n\r\n- (void)viewDidAppear:(BOOL)animated {\r\n    [super viewDidAppear:animated];\r\n    \r\n    [self displayTestBuffer];\r\n}\r\n\r\n- (void)displayTestBuffer {\r\n    \r\n    NSDictionary *attributes = @{ (id)kCVPixelBufferIOSurfacePropertiesKey: @{} };\r\n    \r\n    CVPixelBufferRef pixelBuffer;\r\n    if (CVPixelBufferCreate(kCFAllocatorDefault,\r\n                            1920,\r\n                            1080,\r\n                            kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange,\r\n                            (__bridge CFDictionaryRef)attributes,\r\n                            &pixelBuffer) != kCVReturnSuccess) {\r\n        [NSException raise:NSInternalInconsistencyException\r\n                    format:@\"Failure in CVPixelBufferCreate\"];\r\n        return;\r\n    }\r\n    \r\n    CMVideoFormatDescriptionRef formatDescription;\r\n    if (CMVideoFormatDescriptionCreateForImageBuffer(kCFAllocatorDefault,\r\n                                                     pixelBuffer,\r\n                                                     &formatDescription) != noErr) {\r\n        [NSException raise:NSInternalInconsistencyException\r\n                    format:@\"Failure in CMVideoFormatDescriptionCreateForImageBuffer\"];\r\n        return;\r\n    }\r\n    \r\n    CMSampleBufferRef sampleBuffer;\r\n    if (CMSampleBufferCreateReadyWithImageBuffer(kCFAllocatorDefault,\r\n                                                 pixelBuffer,\r\n                                                 formatDescription,\r\n                                                 &kCMTimingInfoInvalid,\r\n                                                 &sampleBuffer) != noErr) {\r\n        [NSException raise:NSInternalInconsistencyException\r\n                    format:@\"Failure in CMSampleBufferCreateReadyWithImageBuffer\"];\r\n        return;\r\n    }\r\n    \r\n    CFArrayRef attachmentsArray = CMSampleBufferGetSampleAttachmentsArray(sampleBuffer, true);\r\n    CFMutableDictionaryRef attachments = (CFMutableDictionaryRef)CFArrayGetValueAtIndex(attachmentsArray, 0);\r\n    \r\n    CFDictionarySetValue(attachments, kCMSampleAttachmentKey_DisplayImmediately, kCFBooleanTrue);\r\n    \r\n    \r\n    [self.sampleBufferView.sampleBufferDisplayLayer enqueueSampleBuffer:sampleBuffer];\r\n    \r\n    CVPixelBufferRelease(pixelBuffer);\r\n    CFRelease(formatDescription);\r\n    CFRelease(sampleBuffer);\r\n}\r\n\r\n@end"
    email: kevin@rabb.it
    modified: "2016-08-02T19:51:17.25845Z"
    number: "27476998"
    number_intvalue: 27476998
    originated: "2016-07-21"
    parent_number: '&{NULL_VALUE}'
    product: iOS
    product_version: iOS 10.0 [14A5309d]
    reproducible: Always
    resolved: Yes
    status: Closed
    title: AVSampleBufferDisplayLayer does not render content
