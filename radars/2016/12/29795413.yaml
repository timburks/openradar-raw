apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "29795413"
    labels:
        datastore_id: "5005997403799552"
data:
    classification: ""
    created: "2016-12-29T02:48:00.13995Z"
    description: "I create a menu of file names and modification dates. I align these using an attributed string with a tab stop set to fit the longest file name. This works fine on macOS 10.8-10.11 and 10.12.1. However on 10.12.2 the tab stop isn't expanded correctly.\r\n\r\nSteps to Reproduce:\r\nSet attributedTitle on NSMenuItem, using a tab stop to leave space between the filename and the file modification date. See code:\r\n\r\n#define FILEICONSIZE         16.0\r\n#define FILEDATELEADINGSPACE 16.0\r\n\r\n...\r\n\r\n- (void)rebuildMenu:(NSMenu *)menu fromFiles:(NSMutableArray <FileRepresentation *> *)files\r\n{\r\n    NSMenuItem *item = [menu itemWithTitle:NSLocalizedString(@\"Open iCloud\", nil)];\r\n    NSMenu *icloudFilesMenu = item.submenu;\r\n    if (!icloudFilesMenu)\r\n        return;\r\n\r\n    static NSImage *icon;\r\n    if (!icon) {\r\n        icon = [NSImage imageNamed:@\"SSDoc\"];\r\n        icon.size = NSMakeSize(FILEICONSIZE, FILEICONSIZE);\r\n    }\r\n\r\n    [icloudFilesMenu removeAllItems];\r\n\r\n    NSDictionary *stdAttributes = @{ NSFontAttributeName: [NSFont menuBarFontOfSize:0] };\r\n    NSDictionary *ttAttributes  = @{ NSFontAttributeName: [NSFont toolTipsFontOfSize:0] };\r\n\r\n    // get max width of filename\r\n    CGFloat maxWidth = 0;\r\n    for (FileRepresentation *f in files) {\r\n        NSMutableAttributedString *attribTitle;\r\n\r\n        attribTitle = [[[NSAttributedString alloc] initWithString:f.fileName attributes:stdAttributes] mutableCopy];\r\n        [attribTitle addAttribute:NSParagraphStyleAttributeName\r\n                            value:[NSParagraphStyle defaultParagraphStyle]\r\n                            range:NSMakeRange(0, f.fileName.length)];\r\n        NSRect rect = [attribTitle boundingRectWithSize:CGSizeMake(CGFLOAT_MAX, CGFLOAT_MAX)\r\n                                                options:NSStringDrawingUsesLineFragmentOrigin|NSStringDrawingUsesFontLeading];\r\n        if (rect.size.width > maxWidth)\r\n            maxWidth = rect.size.width;\r\n    }\r\n    maxWidth += FILEDATELEADINGSPACE;\r\n    NSMutableParagraphStyle *tabbedStyle = [[NSParagraphStyle defaultParagraphStyle] mutableCopy];\r\n    tabbedStyle.tabStops = @[[[NSTextTab alloc] initWithTextAlignment:NSLeftTextAlignment location:maxWidth options:@{}]];\r\n\r\n    // build file menu\r\n    for (FileRepresentation *f in files) {\r\n        NSMutableAttributedString *attribTitle;\r\n        NSString *fname;\r\n\r\n        fname = [f.fileName stringByAppendingString:@\"\\t\"];\r\n        item = [[NSMenuItem alloc] initWithTitle:fname action:@selector(openFile:) keyEquivalent:@\"\"];\r\n\r\n        attribTitle = [[[NSAttributedString alloc] initWithString:fname attributes:stdAttributes] mutableCopy];\r\n        [attribTitle addAttribute:NSParagraphStyleAttributeName\r\n                            value:tabbedStyle\r\n                            range:NSMakeRange(0, fname.length)];\r\n\r\n        // append file date in tool tip font\r\n        if (f.modDate) {\r\n            NSAttributedString *attribfDate;\r\n            NSString *fdate = [((AppController *)[(NSApplication *)NSApp delegate]).fileDateFormatter stringFromDate:f.modDate];\r\n            attribfDate = [[NSAttributedString alloc] initWithString:fdate attributes:ttAttributes];\r\n            [attribTitle appendAttributedString:attribfDate];\r\n        }\r\n\r\n        item.attributedTitle = attribTitle;\r\n        item.target = self;\r\n        item.enabled = YES;\r\n        item.representedObject = f.url;\r\n        item.image = icon;\r\n\r\n        [icloudFilesMenu addItem:item];\r\n    }\r\n}\r\n\r\nExpected Results:\r\nmacOS 10.12.2 should render the attributed string the same was as on macOS 10.12.1, as the attributed strings are the same.\r\n\r\nActual Results:\r\nmacOS 10.12.2 appear to ignore the tabStops applied to the style.\r\n\r\nVersion:\r\n10.12.2 (16C67)\r\n\r\nNotes:\r\n\r\n\r\nConfiguration:\r\nIssue occurs on macOS 10.12.2, but not on 10.8, 10.9, 10.10, 10.11, 10.12.1"
    email: michael@rourke.id.au
    modified: "2016-12-29T02:48:00.14022Z"
    number: "29795413"
    number_intvalue: 29795413
    originated: 23-Dec-2016
    parent_number: '&{NULL_VALUE}'
    product: macOS + SDK
    product_version: ""
    reproducible: Yes
    resolved: ""
    status: Open
    title: NSMenuItem with attributedTitle not working in macOS 10.12.2 Sierra only
