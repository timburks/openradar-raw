apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "14354117"
    labels:
        datastore_id: "3175404"
data:
    classification: Crash/Hang/Data Loss
    created: "2013-07-04T10:16:03.836896Z"
    description: "Summary:\r\nIn the attached sample project (or download from http://cl.ly/2Y0y020o1t2R) of a document based app we've got a setup of three nested Core Data contexts.\r\n\r\n- savingContext (async queue)\r\n-- mainDocumentContext (main queue)\r\n--- scratchContext (main queue)\r\n\r\nThe reason to have two contexts on the main queue is to allow the scratchContext contents to be used for UI updates as well. If changes were made in the mainDocumentContext and the document gets saved to disk for the first time, e.g. through autosave, the contexts on the main queue deadlock. \r\n\r\nSteps to Reproduce:\r\nOpen attached sample app. On the left, add one or more items. Switch to another app to let autosave kick in.\r\n\r\nExpected Results:\r\nApp still being responsive.\r\n\r\nActual Results:\r\nApp deadlocks/hangs.\r\n\r\nWhat's interesting that the array controller somehow tries to access the saving context in the other queue (see stack trace below). The fetch request on the main queue is just waiting around. This seems to happen while the persistent store is created for the first time with addPersistentStoreWithType:configuration:URL:options:error: (as can be seen in the stack trace of the second queue below)\r\n\r\n\r\nRegression:\r\n\r\nNotes:\r\n\r\nThread 1, Queue : NSManagedObjectContext Queue\r\n#0\t0x00007fff91dc3122 in __psynch_mutexwait ()\r\n#1\t0x00007fff91806dfd in pthread_mutex_lock ()\r\n#2\t0x00007fff8f4dd548 in -[_PFLock lock] ()\r\n#3\t0x00007fff8f4ee2e7 in -[NSManagedObjectContext executeFetchRequest:error:] ()\r\n#4\t0x00007fff8f536a4e in -[NSManagedObjectContext(_NestedContextSupport) _parentObjectsForFetchRequest:inContext:error:] ()\r\n#5\t0x00007fff8f56a72a in __82-[NSManagedObjectContext(_NestedContextSupport) executeRequest:withContext:error:]_block_invoke_0 ()\r\n#6\t0x00007fff938f60b6 in _dispatch_client_callout ()\r\n#7\t0x00007fff938faaf1 in _dispatch_barrier_sync_f_slow ()\r\n#8\t0x00007fff8f53687c in _perform ()\r\n#9\t0x00007fff8f5366c2 in -[NSManagedObjectContext(_NestedContextSupport) executeRequest:withContext:error:] ()\r\n#10\t0x00007fff8f4ee309 in -[NSManagedObjectContext executeFetchRequest:error:] ()\r\n#11\t0x00007fff8f536a4e in -[NSManagedObjectContext(_NestedContextSupport) _parentObjectsForFetchRequest:inContext:error:] ()\r\n#12\t0x00007fff8f56a72a in __82-[NSManagedObjectContext(_NestedContextSupport) executeRequest:withContext:error:]_block_invoke_0 ()\r\n#13\t0x00007fff938fba2d in _dispatch_barrier_sync_f_slow_invoke ()\r\n#14\t0x00007fff938f60b6 in _dispatch_client_callout ()\r\n#15\t0x00007fff938fb0c8 in _dispatch_main_queue_callback_4CF ()\r\n#16\t0x00007fff8a817b4c in __CFRunLoopRun ()\r\n#17\t0x00007fff8a8170e2 in CFRunLoopRunSpecific ()\r\n#18\t0x00007fff8d181eb4 in RunCurrentEventLoopInMode ()\r\n#19\t0x00007fff8d181c52 in ReceiveNextEventCommon ()\r\n#20\t0x00007fff8d181ae3 in BlockUntilNextEventMatchingListInMode ()\r\n#21\t0x00007fff92b4e533 in _DPSNextEvent ()\r\n#22\t0x00007fff92b4ddf2 in -[NSApplication nextEventMatchingMask:untilDate:inMode:dequeue:] ()\r\n#23\t0x00007fff92b451a3 in -[NSApplication run] ()\r\n#24\t0x00007fff92ae9bd6 in NSApplicationMain ()\r\n#25\t0x0000000100002812 in main at /Users/ck/Documents/Golden Box/Tests/DocumentContextsTest/DocumentContextsTest/main.m:13\r\n#26\t0x00007fff8fb4c7e1 in start ()\r\n\r\n\r\nThread 5, Queue : com.apple.root.default-priority\r\n#0\t0x00007fff91dc16c2 in semaphore_wait_trap ()\r\n#1\t0x00007fff938fac32 in _dispatch_thread_semaphore_wait ()\r\n#2\t0x00007fff938faa92 in _dispatch_barrier_sync_f_slow ()\r\n#3\t0x00007fff8f53687c in _perform ()\r\n#4\t0x00007fff8f5366c2 in -[NSManagedObjectContext(_NestedContextSupport) executeRequest:withContext:error:] ()\r\n#5\t0x00007fff8f4ee309 in -[NSManagedObjectContext executeFetchRequest:error:] ()\r\n#6\t0x00007fff92ab890c in -[_NSManagedProxy fetchObjectsWithFetchRequest:error:] ()\r\n#7\t0x00007fff92da9352 in -[NSArrayController(NSManagedController) _performFetchWithRequest:merge:error:] ()\r\n#8\t0x00007fff92ab837a in -[NSObjectController(NSManagedController) fetchWithRequest:merge:error:] ()\r\n#9\t0x00007fff92f8dd65 in -[_NSManagedProxy _storesDidChange:] ()\r\n#10\t0x00007fff8a827eda in _CFXNotificationPost ()\r\n#11\t0x00007fff8e5ef7b6 in -[NSNotificationCenter postNotificationName:object:userInfo:] ()\r\n#12\t0x00007fff8f4ecced in -[NSPersistentStoreCoordinator(_NSInternalMethods) _postStoresChangedNotificationsForStores:changeKey:options:] ()\r\n#13\t0x00007fff8f4de516 in -[NSPersistentStoreCoordinator addPersistentStoreWithType:configuration:URL:options:error:] ()\r\n#14\t0x0000000100003737 in -[BSManagedDocument configurePersistentStoreCoordinatorForURL:ofType:modelConfiguration:storeOptions:error:] at /Users/ck/Documents/Golden Box/Tests/DocumentContextsTest/DocumentContextsTest/BSManagedDocument/BSManagedDocument.m:156\r\n#15\t0x0000000100004b1e in __63-[BSManagedDocument contentsForURL:ofType:saveOperation:error:]_block_invoke at /Users/ck/Documents/Golden Box/Tests/DocumentContextsTest/DocumentContextsTest/BSManagedDocument/BSManagedDocument.m:325\r\n#16\t0x00000001000072e9 in -[BSManagedDocument writeToURL:ofType:forSaveOperation:originalContentsURL:error:] at /Users/ck/Documents/Golden Box/Tests/DocumentContextsTest/DocumentContextsTest/BSManagedDocument/BSManagedDocument.m:756\r\n#17\t0x00007fff92a252ce in -[NSDocument _writeSafelyToURL:ofType:forSaveOperation:forceTemporaryDirectory:error:] ()\r\n#18\t0x00007fff92a25014 in -[NSDocument _writeSafelyToURL:ofType:forSaveOperation:error:] ()\r\n#19\t0x00007fff92a24b99 in -[NSDocument writeSafelyToURL:ofType:forSaveOperation:error:] ()\r\n#20\t0x0000000100006fe6 in -[BSManagedDocument writeSafelyToURL:ofType:forSaveOperation:error:] at /Users/ck/Documents/Golden Box/Tests/DocumentContextsTest/DocumentContextsTest/BSManagedDocument/BSManagedDocument.m:715\r\n#21\t0x00007fff92a24337 in __block_global_90 ()\r\n#22\t0x00007fff92a31aef in __block_global_97 ()\r\n#23\t0x00007fff938f9f01 in _dispatch_call_block_and_release ()\r\n#24\t0x00007fff938f60b6 in _dispatch_client_callout ()\r\n#25\t0x00007fff938f71fa in _dispatch_worker_thread2 ()\r\n#26\t0x00007fff91803d0b in _pthread_wqthread ()\r\n#27\t0x00007fff917ee1d1 in start_wqthread ()"
    email: hello@christianklotz.co.uk
    modified: "2013-07-04T10:16:03.837086Z"
    number: "14354117"
    number_intvalue: 14354117
    originated: 04-Jul-2013 11:09 AM
    parent_number: '&{NULL_VALUE}'
    product: OS X SDK
    product_version: 10.8.4/12E55
    reproducible: Always
    resolved: ""
    status: Open
    title: Nested Core Data contexts deadlock on 1st document save if they're on same queue
