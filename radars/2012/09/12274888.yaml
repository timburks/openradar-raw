apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "12274888"
    labels:
        datastore_id: "1958401"
data:
    classification: Serious Bug
    created: "2012-09-11T09:33:10.033809Z"
    description: "==========================\r\nSummary:\r\n==========================\r\nI'm one of the developers of an app, which installs a couple of apps, daemons, agents and one kernel extension. We have our own custom installer app that puts everything in place and triggers a kext cache update simply by putting the kext in /System/Library/Extensions, as it is recommended in man(8) kextcache. If the update fails, an older version of the kernel extension will be loaded (in the case of an update from an older version). Because we rely heavily on interprocess communication between our daemon and our kernel extension, their versions must match. If they don't, our app reports an error to the user and refuses to work.\r\n\r\nThe kextcache update fails for some of our users for a variety of reasons, none of which we are responsible for. With the update of 10.8.1, which delivers some kernel extensions of its own, you (Apple) are experiencing this problem, too, as indicated by system log messages such as these (from a user's system log during startup):\r\n\r\n<date> <host> kernel[0]: Refusing new kext com.apple.kpi.bsd, v12.1: already have loaded v12.0.\r\n<date> <host> kernel[0]: Refusing new kext com.apple.kpi.iokit, v12.1: already have loaded v12.0.\r\n<date> <host> kernel[0]: Refusing new kext com.apple.kpi.libkern, v12.1: already have loaded v12.0.\r\n<date> <host> kernel[0]: Refusing new kext com.apple.kpi.mach, v12.1: already have loaded v12.0.\r\n<date> <host> kernel[0]: Refusing new kext com.apple.kpi.private, v12.1: already have loaded v12.0.\r\n<date> <host> kernel[0]: Refusing new kext com.apple.kpi.unsupported, v12.1: already have loaded v12.0.\r\n\r\nUnfortunately, the user doesn't get notified about any errors if the kextcache update fails (I found one exception: changing the startup disk in the system preferences doesn't work anymore if the FileVault 2 is enabled. Instead, the user simply gets a message that the boot caches could not be updated).\r\n\r\n\r\n==========================\r\nSteps to Reproduce:\r\n==========================\r\nI'm testing the success of failure of the kextcache update by issuing the following command, which I'll call \"Update Command\" from here on:\r\n    sudo touch /System/Library/Extensions/ && sudo kextcache -v 6 -update-volume /\r\n\r\nThe \"-update-volume\" option is specifically mentioned in man(8) kextcache, but only on OS X 10.8 and 10.8.1, not on earlier OS X versions or the online version of the man page [link1]. Although, it seems to work the same on 10.6, 10.7 and 10.8 (these are the versions supported by our app).\r\n\r\nI found different reasons for kextcache to fail:\r\n\r\n- Return code 0 (success): not really a fail, but kext cache doesn't do anything if /mach_kernel doesn't exist. A user had FileVault 2 enabled (thus starting from Recovery HD and not using /mach_kernel) and that file was missing (don't know how the user managed to do that).\r\nCan be reproduced simply by renaming /mach_kernel temporarily and then issuing the Update Command.\r\nFixed by telling user to reinstall 10.8.1, which puts /mach_kernel there again.\r\n\r\n- Return code 28: FileVault 2 is enabled and Recovery HD is full: I've seen this a couple of times and in all cases the shadow file for network booting (/Volumes/Recovery HD/.com.apple.NetBootX/shadowfile) was using up almost all of the disk space. In one case, the user reported that he only booted from a network volume once: to install OS X.\r\nCan be reproduced simply by putting a large file on the Recovery HD (adapt count accordingly) and then issuing the Update Command:\r\n    sudo dd if=/dev/zero of=/Volumes/Recovery\\ HD/big_file count=117760 bs=1024\r\nFixed by deleting the shadow file.\r\n\r\n- Return code 71: Problem with a 3rd party kernel extension. \r\nCan be reproduced by installing VodafoneMobileBroadBand4.07.07.00.dmg from [link2]. Do not download the newest one (it works fine on 10.8.1). After installing, issue the Update Command and you'll get an error.\r\nFixed by deleting/updating offending kernel extensions.\r\n\r\n- Another code 71: Unknown problem with a kernel extensions.\r\nI could not reproduce this, but I attached a log by a user with the output of the Update Command [file1] and the list of his installed kernel extensions [file2]. The error message from the log:\r\n    setting load address of AppleAHCIPort.kext to 0xffffff7f824ce000\r\n    kxld[com.apple.driver.AppleAHCIPort]: The vtable for AppleAHCIPortPolledAdapter was\r\n      not patched because its parent, the vtable for IOAHCIPollerInterface, was not found.\r\n\r\n\r\n==========================\r\nExpected Results:\r\n==========================\r\n1. Some kind of user feedback. Anything. Tell the user that something is wrong, or better yet: fix it.\r\n2. The step \"Removing unnecessary bloat.\" that is logged while updating the helper partition should actually delete files that are not needed, like the \"/Volumes/Recovery HD/big_file\" we created earlier. And especially the shadow file for network boots, that is a real problem.\r\n\r\n\r\n==========================\r\nActual Results:\r\n==========================\r\nOld versions of kernel extensions are kept in use after a system update or software update, which could result in unexpected behavior. And the user doesn't know anything about it or how to resolve the issue.\r\n\r\n\r\n==========================\r\nRegression:\r\n==========================\r\nWe have a couple of support cases where users run into this issue. All of them are on OS X 10.8.1. Because our app is currently at the end of an open beta phase (release candidate is out), most of our users are probably rather tech-savvy and use the latest software versions. Maybe that's the reason that all of them run OS X 10.8.1, or maybe there's something in that OS release that causes these problems more often.\r\nMost of our users that reported this issue use FileVault 2, but I don't know if it's all of them. kextcache seems to update the helper partition (Recovery HD) only if FileVault 2 is enabled and because one of the causes for the issue at hand is a full Recovery HD, the statistics may be skewed in that direction.\r\n\r\n\r\n==========================\r\nNotes:\r\n==========================\r\n\r\n[link1] http://developer.apple.com/library/mac/#documentation/Darwin/Reference/Manpages/man8/kextcache.8.html\r\n[link2] http://www.business.vodafone.com/site/bus/public/enuk/support/10_productsupport/laptop_connectivity/40_software/software/10_latest/p_software.jsp\r\n\r\n[file1] result_code_71_kextcache.log\r\n[file2] result_code_71_installed_kexts.log"
    email: marco@duckcode.com
    modified: "2012-09-11T09:35:16.168175Z"
    number: "12274888"
    number_intvalue: 12274888
    originated: 11-Sep-2012 11:28 AM
    parent_number: '&{NULL_VALUE}'
    product: Mac OS X
    product_version: 10.8.1 (12B19)
    reproducible: Sometimes
    resolved: No
    status: Open
    title: kextcache updates fail silently for so many reasons
