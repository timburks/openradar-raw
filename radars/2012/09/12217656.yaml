apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "12217656"
    labels:
        datastore_id: "1919402"
data:
    classification: Serious Bug
    created: "2012-09-01T06:14:28.965179Z"
    description: "31-Aug-2012 04:52 PM Mike Boylan:\r\nSummary:\r\n\r\nThis is an incredibly important bug affecting several hundred machines in a production environment with the potential to affect hundreds of students.\r\n\r\nWhen a 10.8.1 Mac is bound to a 2003 operational level active directory domain and configured to create a mobile account on login, if that user ever enters their password incorrectly at the login window, that bad password (or a bad password of some type) seems to get cached and is used during the regular mobile account check-ins/refreshes with the domain controllers to see if the mobile account's credentials are up-to-date. This results in numerous and frequent failed authentication requests logged on the domain controllers, ultimately leading to locked Active Directory accounts.\r\n\r\nThis problem is exasperated by a separate, but ultimately related bug, where 10.8.1, on a single failed login attempt at the login window, logs at a minimum of 2, and often times as many as *seven* failed authentication attempts against the domain controllers.\r\n\r\nSteps to Reproduce:\r\n\r\n- Bind a 10.8.1 machine to Active Directory with the following ad plugin configuration options:\r\nAdvanced Options - User Experience\r\n  Create mobile account at login = Enabled\r\n     Require confirmation        = Disabled\r\n  Force home to startup disk     = Enabled\r\n     Mount home as sharepoint    = Enabled\r\n  Use Windows UNC path for home  = Enabled\r\n     Network protocol to be used = smb\r\n  Default user Shell             = /bin/bash\r\n\r\nAdvanced Options - Mappings\r\n  Mapping UID to attribute       = not set\r\n  Mapping user GID to attribute  = not set\r\n  Mapping group GID to attribute = not set\r\n  Generate Kerberos authority    = Enabled\r\n\r\nAdvanced Options - Administrative\r\n  Preferred Domain controller    = not set\r\n  Allowed admin groups           = domain admins,enterprise admins,workstation admins\r\n  Authentication from any domain = Enabled\r\n  Packet signing                 = allow\r\n  Packet encryption              = allow\r\n  Password change interval       = 14\r\n  Restrict Dynamic DNS updates   = not set\r\n  Namespace mode                 = domain\r\n\r\n- Login successfully as a user to trigger the creation of a mobile account\r\n- Logout\r\n\r\nTo observe the higher than normal failed authentication attempts:\r\n- Purposefully type a bad password once, twice, or three times at the login window for that user\r\n- Inspect the failed password count for a user in Active Directory using the LockoutStatus tool\r\n- Observe that the failed password count increments by at least 2, but often times more per every failed request. We saw up to 7 for a single failed attempt.\r\n\r\nTo observe the continued attempts by opendirectoryd to authenticate using kerberos with the incorrect information:\r\n\r\n- Login to said machine and enable opendirectoryd debug logging\r\n- Logout\r\n- Leave said machine at the login window\r\n- Continue to monitor the user's failed password count using the LockoutStatus tool\r\n    -- Notice it increases over time while the machine continues to sit at the login window\r\n    -- Observe log entry time correlation between the DC security logs logging event 675 audit failure with kerberos error code 0x18, otherwise known as bad password with opendirectoryd logs on the clients. The 675 AUDIT FAILURE messages will be triggered from the machine's IP address.\r\n\r\nLog entries on DCs will appear as such:\r\n675,AUDIT FAILURE,Security,Fri Aug 31 07:00:44 2012,NT AUTHORITY\\SYSTEM, cos01 %{S-1-5-21-3125130454-1535616552-1580254349-1385} krbtgt/AD.SCHOOL.EDU 0x2 0x18 10.17.42.23\r\n\r\nLog entries on the client for correlating time stamp(s) will appear as:\r\n2012-08-31 07:00:44.720183 EDT - 124.830.837, Node: /Active Directory/AD/ad.school.edu, Module: Kerberosv5 - Audit - Invalid credentials (5000) - Verify password for record type Users 'cos01' node '/Active Directory/AD/ad.school.edu'\r\n2012-08-31 07:00:44.720238 EDT - 124.830, Node: /Local/Default - Audit - Invalid credentials (5000) - Verify password for record type Users 'cos01' node '/Local/Default'\r\n2012-08-31 07:00:44.720248 EDT - 124.830.837, Node: /Active Directory/AD/ad.school.edu, Module: Kerberosv5 - ODRecordVerifyPassword failed with error 'Invalid credentials' (5000)\r\n2012-08-31 07:00:44.720281 EDT - 124.830, Node: /Local/Default - ODRecordVerifyPassword failed with error 'Invalid credentials' (5000)\r\n\r\nAgain, this is happening continuously in the background while a machine sits at the login window.\r\n\r\n- Eventually enough failed attempts will occur leading to an account lockout in Active Directory. This will depend on the site configuration. Ours is set to lockout at 20 failed attempts for 20 minutes.\r\n\r\nExpected Results:\r\n\r\nI'm unsure of the exact inner-workings of the Mobile Account, but I would expect that it would use the password from the last successfully authenticated session, not the last password entered at the login window (or some other random bad password), to see if its credentials are still valid. If so, no more checks should be performed until the timer expires and it's time to check in again. If found to be invalid, the account would be flagged as such and an update performed through a successful login at the login window would occur.\r\n\r\nActual Results:\r\n\r\nThe refresh mechanism for AD mobile accounts seems to be using a password that is NOT the last successful password from a user login when performing its checks against the domain controllers. If a user mistypes his or her password at the login window, that password, or a incorrect password (not sure exactly from where?) is being used to perform the account checks and refreshes against the directory. When found to be invalid, the checks still continue on a regular interval, increasing the failed authentication request count on the domain controllers each and every time. Because of a separate but seemingly related bug of OS X sending multiple failed authentication requests at one time, the lockout grace count is diminished more quickly than anticipated causing fast account lockouts.\r\n\r\nRegression:\r\nUnsure/Untested\r\n\r\nNotes:\r\nWe successfully duplicated this several times. Attached are all the logs for a test machine, including opendirectoryd logging in debug mode, syslog, and other various output including dsconfigad, system_profiler, mcxquery, and last. We included last to show the successful login. Also included is the klist output of a successful login showing functional kerberbos. The testing last night was performed with test account cos01. We left the machine at the login window after a failed authentication attempt and the failed count on the domain controllers was 3. By morning, the account had increased to 18 failed authentication attempts logged, with hundreds of entries of event 675 AUDIT FAILURE on the domain controllers. Time stamps with those messages correlate with refresh events in the opendirectoryd debug logs. Logs from the domain controllers showing the audit failures are also included."
    email: cos06@rmu.edu
    modified: "2012-09-12T14:41:15.516908Z"
    number: "12217656"
    number_intvalue: 12217656
    originated: 31-Aug-2012 04:52 PM
    parent_number: '&{NULL_VALUE}'
    product: Mac OS X
    product_version: 10.8.1 (12B19)
    reproducible: Always
    resolved: 11-Sept-2012
    status: Duplicate
    title: AD Mobile Accts | Bad mobile acct refreshes/checks leading to account lockouts
