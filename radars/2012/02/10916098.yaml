apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "10916098"
    labels:
        datastore_id: "1529403"
data:
    classification: Crash/Hang/Data Loss
    created: "2012-02-23T11:03:59.230384Z"
    description: "I hit what appears to be a deadlock situation, creating an NSCache while a background queue is destroying one. I paused the app after it spun for about 5 seconds. After examining the state in the debugger for a while, the app received SIGABRT. I suspect someone else on the system sent that (since it would apparently have failed to react to the memory pressure warning?). That crash report is attached.\r\n\r\nThread 1 is creating an NSCache instance with +[NSCache new] (frame 4). LIFancyCoverCache is not an NSCache subclass, btw.\r\n\r\nIt appears that Thread 1 and Thread 13 are messaging two different cache instances: <NSCache: 0x10f17c1d0> on Thread 1, <NSCache: 0x10c4f3590> on Thread 13. (At least, that's what were in $rbx on each thread.)\r\n\r\nHere are the backtraces for the two threads in question. The backtrace of all threads is a separate attachment.\r\n\r\n\r\nThread 1, Queue : com.apple.main-thread\r\n#0\t0x00007fff88e2abf2 in __psynch_mutexwait ()\r\n#1\t0x00007fff8dca51a1 in pthread_mutex_lock ()\r\n#2\t0x00007fff90548905 in cache_create ()\r\n#3\t0x00007fff947f1a9c in -[NSCache init] ()\r\n#4\t0x00007fff947cb3b2 in +[NSObject new] ()\r\n#5\t0x000000010026cc4a in -[LIFancyCoverCache init] at /Users/jonathon/Documents/Streams/Delicious Monster/UberLibrary/Library/LIFancyCoverCache.m:39\r\n#6\t0x00007fff947cb3b2 in +[NSObject new] ()\r\n#7\t0x000000010026cf92 in +[LIFancyCoverCache fancyCoverCacheForSize:] ()\r\n#8\t0x000000010025ecce in -[LICoverImageView drawRect:] ()\r\n#9\t0x00007fff8ce09abe in -[NSView _drawRect:clip:] ()\r\n#10\t0x00007fff8ce371eb in -[NSView _recursiveDisplayAllDirtyWithLockFocus:visRect:] ()\r\n#11\t0x00007fff8ce37617 in -[NSView _recursiveDisplayAllDirtyWithLockFocus:visRect:] ()\r\n#12\t0x00007fff8ce37617 in -[NSView _recursiveDisplayAllDirtyWithLockFocus:visRect:] ()\r\n#13\t0x00007fff8ce37617 in -[NSView _recursiveDisplayAllDirtyWithLockFocus:visRect:] ()\r\n#14\t0x00007fff8ce37617 in -[NSView _recursiveDisplayAllDirtyWithLockFocus:visRect:] ()\r\n#15\t0x00007fff8ce37617 in -[NSView _recursiveDisplayAllDirtyWithLockFocus:visRect:] ()\r\n#16\t0x00007fff8ce37617 in -[NSView _recursiveDisplayAllDirtyWithLockFocus:visRect:] ()\r\n#17\t0x00007fff8ce07099 in -[NSView _recursiveDisplayRectIfNeededIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:topView:] ()\r\n#18\t0x00007fff8ce0834e in -[NSView _recursiveDisplayRectIfNeededIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:topView:] ()\r\n#19\t0x00007fff8ce0834e in -[NSView _recursiveDisplayRectIfNeededIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:topView:] ()\r\n#20\t0x00007fff8ce0834e in -[NSView _recursiveDisplayRectIfNeededIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:topView:] ()\r\n#21\t0x00007fff8ce0834e in -[NSView _recursiveDisplayRectIfNeededIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:topView:] ()\r\n#22\t0x00007fff8ce0834e in -[NSView _recursiveDisplayRectIfNeededIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:topView:] ()\r\n#23\t0x00007fff8ce0834e in -[NSView _recursiveDisplayRectIfNeededIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:topView:] ()\r\n#24\t0x00007fff8ce0834e in -[NSView _recursiveDisplayRectIfNeededIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:topView:] ()\r\n#25\t0x00007fff8ce0834e in -[NSView _recursiveDisplayRectIfNeededIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:topView:] ()\r\n#26\t0x00007fff8ce0834e in -[NSView _recursiveDisplayRectIfNeededIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:topView:] ()\r\n#27\t0x00007fff8ce06593 in -[NSThemeFrame _recursiveDisplayRectIfNeededIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:topView:] ()\r\n#28\t0x00007fff8ce019af in -[NSView _displayRectIgnoringOpacity:isVisibleRect:rectIsVisibleRectForView:] ()\r\n#29\t0x00007fff8cdfa429 in -[NSView displayIfNeeded] ()\r\n#30\t0x00007fff8cdf9b69 in _handleWindowNeedsDisplayOrLayoutOrUpdateConstraints ()\r\n#31\t0x00007fff947e4bd7 in __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__ ()\r\n#32\t0x00007fff947e4b36 in __CFRunLoopDoObservers ()\r\n#33\t0x00007fff947b9ce9 in __CFRunLoopRun ()\r\n#34\t0x00007fff947b9676 in CFRunLoopRunSpecific ()\r\n#35\t0x00007fff8fd2731f in RunCurrentEventLoopInMode ()\r\n#36\t0x00007fff8fd2e5c9 in ReceiveNextEventCommon ()\r\n#37\t0x00007fff8fd2e456 in BlockUntilNextEventMatchingListInMode ()\r\n#38\t0x00007fff8cdbdf5d in _DPSNextEvent ()\r\n#39\t0x00007fff8cdbd861 in -[NSApplication nextEventMatchingMask:untilDate:inMode:dequeue:] ()\r\n#40\t0x00007fff8cdba19d in -[NSApplication run] ()\r\n#41\t0x00007fff8d038b88 in NSApplicationMain ()\r\n#42\t0x0000000100002c87 in main ()\r\nThread 2, Queue : com.apple.libdispatch-manager\r\nThread 7, Queue : (null)\r\nThread 11 CVDisplayLink, Queue : (null)\r\nThread 13, Queue : com.apple.root.default-priority\r\n#0\t0x00007fff88e2abf2 in __psynch_mutexwait ()\r\n#1\t0x00007fff8dca51a1 in pthread_mutex_lock ()\r\n#2\t0x00007fff9054792a in cache_destroy ()\r\n#3\t0x00007fff948c39db in -[NSCache dealloc] ()\r\n#4\t0x00007fff94789ca0 in CFRelease ()\r\n#5\t0x00007fff905468e4 in _value_entry_remove ()\r\n#6\t0x00007fff905469cd in _entry_unmap ()\r\n#7\t0x00007fff90546a71 in _entry_evict ()\r\n#8\t0x00007fff90546b04 in _evict_last ()\r\n#9\t0x00007fff90546cf2 in _cache_enforce_limits ()\r\n#10\t0x00007fff90546ea5 in cache_handle_memory_pressure ()\r\n#11\t0x00007fff8a7d92b6 in _dispatch_source_invoke ()\r\n#12\t0x00007fff8a7d5f77 in _dispatch_queue_invoke ()\r\n#13\t0x00007fff8a7d5760 in _dispatch_worker_thread2 ()\r\n#14\t0x00007fff8dca83da in _pthread_wqthread ()\r\n#15\t0x00007fff8dca9b85 in start_wqthread ()\r\nThread 17 QTKit: QTCALayerRendererPendingQWorkLoop, Queue : (null)\r\nThread 19 com.apple.NSURLConnectionLoader, Queue : (null)\r\nThread 21 com.apple.CFSocket.private, Queue : (null)\r\nThread 27, Queue : (null)\r\nThread 28, Queue : (null)"
    email: me@JonathonMah.com
    modified: "2012-03-06T11:41:16.012494Z"
    number: "10916098"
    number_intvalue: 10916098
    originated: 22-Feb-2012 06:18 PM
    parent_number: '&{NULL_VALUE}'
    product: Mac OS X
    product_version: 10.7.3 (11D50)
    reproducible: I Didn't Try
    resolved: ""
    status: Open
    title: NSCache / libcache BIG BAD deadlock
