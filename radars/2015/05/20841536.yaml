apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "20841536"
    labels:
        datastore_id: "4957577066577920"
data:
    classification: Crash/Hang/Data Loss
    created: "2015-05-06T19:40:50.10331Z"
    description: "Summary:\r\nI added state restoration to an app in the last update. I imediately started getting an incredibly high number of crash reports from all over the application. Each one crashed in a different thread, in different parts of the app.\r\n \r\nEvery report has two things in common. All of them are SIGSEGV errors with a SEGV_ACCERR error code. All of them reference the following calls in the main thread:\r\n\r\n15  libsystem_c.dylib                    0x30b04eb9 exit + 10\r\n16  UIKit                                0x257795e7 -[UIApplication _terminateWithStatus:] + 404\r\n17  UIKit                                0x25964a83 -[UIApplication _updateSnapshotAndStateRestorationArchiveForBackgroundEvent:saveState:exitIfCouldNotRestoreState:] + 108\r\n\r\nI did some digging and found that UIKit state restoration fails if the application is launched in the background to perform a background app refresh. The following messages are printed:\r\n\r\nError reading archived restorable state: Error Domain=NSCocoaErrorDomain Code=257 \"The operation couldn’t be completed. (Cocoa error 257.)\" UserInfo=0x174861dc0 {NSFilePath=/var/mobile/Containers/Data/Application/2AEAAA47-401A-4AD9-ACD4-157EB07E6A9F/Library/Saved Application State/com.north.watchville.savedState/data.data, NSUnderlyingError=0x17425ad90 \"The operation couldn’t be completed. Operation not permitted\"}\r\n\r\nApplication could not restore state when launched in background while locked, skipping snapshot/state save when asked to update snapshot in background, and terminating app instead\r\n \r\nIt seems as though the state restoration files are protected in a way that the rest of my application's data is not. The call to exit causes trouble on any background threads that are still running so I see lots of crash reports.\r\n \r\nInterestingly enough, -[UIApplicationDelegate application:shouldSaveApplicationState:] and -[UIApplication application:shouldRestoreApplicationState:] are never called in this mode. So I never have an option to opt out of state restoration in the background and prevent this crash.\r\n\r\nAdditionally, while building the sample project for this report, I discovered that if I don't implement\r\n\r\nfunc application(application: UIApplication, willFinishLaunchingWithOptions launchOptions: [NSObject : AnyObject]?) -> Bool {\r\n    return true\r\n}\r\n\r\nthe errors and crashes go away and state restoration works in the background as expected. If it is implemented, state restoration fails with the issues outlined above.\r\n\r\nSteps to Reproduce:\r\nIn the attached sample application:\r\n\r\n- Run the \"Foreground\" scheme on a device\r\n- Close the application by pressing the home button so that UIKit has a chance to archive all application state\r\n- Sop the application from Xcode\r\n- Run the \"Background\" scheme on a device while the device is locked\r\n\r\nIf application:willFinishLaunchingWithOptions: (AppDelegate.swift line 25) is included in the build, you will see errors around state restoration. If it is not included, everything (including state restoration) works as expected.\r\n\r\nExpected Results:\r\nState restoration should work, or UIKit should not attempt to archive or restore state in cases where it could fail (background running on a locked device).\r\n\r\nActual Results:\r\nState restoration fails which results in the application terminating itself, resulting in high crash volume.\r\n\r\nIt prints the following error messages:\r\n\r\nError reading archived restorable state: Error Domain=NSCocoaErrorDomain Code=257 \"The operation couldn’t be completed. (Cocoa error 257.)\" UserInfo=0x174861dc0 {NSFilePath=/var/mobile/Containers/Data/Application/2AEAAA47-401A-4AD9-ACD4-157EB07E6A9F/Library/Saved Application State/com.north.watchville.savedState/data.data, NSUnderlyingError=0x17425ad90 \"The operation couldn’t be completed. Operation not permitted\"}\r\n\r\nApplication could not restore state when launched in background while locked, skipping snapshot/state save when asked to update snapshot in background, and terminating app instead\r\n\r\nThen UIApplication terminates itself.\r\n\r\nSample project: http://cl.ly/asp8"
    email: calebmdavenport@gmail.com
    modified: "2015-05-06T19:40:50.10368Z"
    number: "20841536"
    number_intvalue: 20841536
    originated: May 6 2015
    parent_number: '&{NULL_VALUE}'
    product: iOS
    product_version: 7.1 - 8.x
    reproducible: Always
    resolved: ""
    status: Open
    title: State Restoration and Background App Refresh Crash
