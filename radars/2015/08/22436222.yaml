apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "22436222"
    labels:
        datastore_id: "5680889925206016"
data:
    classification: Serious Bug
    created: "2015-08-26T12:13:12.65979Z"
    description: "Summary:\r\nThe following snippets crash the Swift compiler (and SourceKitService). An example project and crash reports are attached.\r\n\r\nI've included three crashing cases as they all produce different stack traces. However, as they are all very similar I included them in the same report as it might be likely that their causes are related.\r\n\r\n\r\n// a)\r\n_ = { () -> [UnsafePointer<Int>] in\r\n    return [1, 2, 3].map {\r\n        return UnsafePointer(UnsafeMutablePointer.alloc($0))\r\n    }\r\n}\r\n\r\n// b)\r\n_ = { () -> [UnsafePointer<Int>] in\r\n    return (0..<100).map {\r\n        return UnsafePointer(UnsafeMutablePointer.alloc($0))\r\n    }\r\n}\r\n\r\n// c)\r\n_ = {\r\n    return [1, 2, 3].map {\r\n        return UnsafeMutablePointer.alloc($0)\r\n    }\r\n}\r\n\r\nSteps to Reproduce:\r\n1. Open the attached project\r\n2. Uncomment one of the crashing cases and build\r\n\r\nExpected Results:\r\nThe code snippet should compile successfully\r\n\r\nActual Results:\r\nThe compiler & SourceKitService crash\r\n\r\nStack trace for a):\r\n\r\n0  swift                    0x000000010b8b8edb llvm::sys::PrintStackTrace(__sFILE*) + 43\r\n1  swift                    0x000000010b8b961b SignalHandler(int) + 379\r\n2  libsystem_platform.dylib 0x00007fff95333eaa _sigtramp + 26\r\n3  libsystem_platform.dylib 0x00007fe03b87e478 _sigtramp + 2790565352\r\n4  swift                    0x0000000109bb46bc swift::Lowering::SILGenFunction::emitLValue(swift::Expr*, swift::AccessKind) + 76\r\n5  swift                    0x0000000109b9dcb0 swift::ASTVisitor<(anonymous namespace)::RValueEmitter, swift::Lowering::RValue, void, void, void, void, void, swift::Lowering::SGFContext>::visit(swift::Expr*, swift::Lowering::SGFContext) + 128\r\n6  swift                    0x0000000109b9c18f swift::Lowering::SILGenFunction::emitRValueAsSingleValue(swift::Expr*, swift::Lowering::SGFContext) + 47\r\n7  swift                    0x0000000109b78c71 (anonymous namespace)::SILGenApply::visitExpr(swift::Expr*) + 49\r\n8  swift                    0x0000000109b7b7d2 (anonymous namespace)::SILGenApply::visitApplyExpr(swift::ApplyExpr*) + 4466\r\n9  swift                    0x0000000109b701f2 prepareApplyExpr(swift::Lowering::SILGenFunction&, swift::Expr*) + 178\r\n10 swift                    0x0000000109b700ff swift::Lowering::SILGenFunction::emitApplyExpr(swift::Expr*, swift::Lowering::SGFContext) + 47\r\n11 swift                    0x0000000109b9dda4 swift::ASTVisitor<(anonymous namespace)::RValueEmitter, swift::Lowering::RValue, void, void, void, void, void, swift::Lowering::SGFContext>::visit(swift::Expr*, swift::Lowering::SGFContext) + 372\r\n12 swift                    0x0000000109b99916 swift::Lowering::SILGenFunction::emitRValue(swift::Expr*, swift::Lowering::SGFContext) + 22\r\n13 swift                    0x0000000109bdf22a swift::Lowering::SILGenFunction::emitReturnExpr(swift::SILLocation, swift::Expr*) + 362\r\n14 swift                    0x0000000109bdcf04 swift::ASTVisitor<(anonymous namespace)::StmtEmitter, void, void, void, void, void, void>::visit(swift::Stmt*) + 740\r\n15 swift                    0x0000000109bdcd7b swift::ASTVisitor<(anonymous namespace)::StmtEmitter, void, void, void, void, void, void>::visit(swift::Stmt*) + 347\r\n16 swift                    0x0000000109bdcc15 swift::Lowering::SILGenFunction::emitStmt(swift::Stmt*) + 21\r\n17 swift                    0x0000000109bade98 swift::Lowering::SILGenFunction::emitClosure(swift::AbstractClosureExpr*) + 216\r\n18 swift                    0x0000000109b67544 swift::Lowering::SILGenModule::emitClosure(swift::AbstractClosureExpr*) + 212\r\n19 swift                    0x0000000109ba59f1 (anonymous namespace)::RValueEmitter::visitAbstractClosureExpr(swift::AbstractClosureExpr*, swift::Lowering::SGFContext) + 97\r\n20 swift                    0x0000000109b9ddc9 swift::ASTVisitor<(anonymous namespace)::RValueEmitter, swift::Lowering::RValue, void, void, void, void, void, swift::Lowering::SGFContext>::visit(swift::Expr*, swift::Lowering::SGFContext) + 409\r\n21 swift                    0x0000000109b9c3ad swift::Lowering::SILGenFunction::emitIgnoredExpr(swift::Expr*) + 397\r\n22 swift                    0x0000000109b9ff55 swift::ASTVisitor<(anonymous namespace)::RValueEmitter, swift::Lowering::RValue, void, void, void, void, void, swift::Lowering::SGFContext>::visit(swift::Expr*, swift::Lowering::SGFContext) + 8997\r\n23 swift                    0x0000000109b9c3ad swift::Lowering::SILGenFunction::emitIgnoredExpr(swift::Expr*) + 397\r\n24 swift                    0x0000000109b69066 swift::Lowering::SILGenModule::visitTopLevelCodeDecl(swift::TopLevelCodeDecl*) + 198\r\n25 swift                    0x0000000109b6966b swift::Lowering::SILGenModule::emitSourceFile(swift::SourceFile*, unsigned int) + 779\r\n26 swift                    0x0000000109b6a230 swift::SILModule::constructSIL(swift::ModuleDecl*, swift::SILOptions&, swift::FileUnit*, llvm::Optional<unsigned int>, bool, bool) + 944\r\n27 swift                    0x0000000109b6a5dd swift::performSILGeneration(swift::FileUnit&, swift::SILOptions&, llvm::Optional<unsigned int>, bool) + 109\r\n28 swift                    0x00000001099c8ed5 performCompile(swift::CompilerInstance&, swift::CompilerInvocation&, llvm::ArrayRef<char const*>, int&) + 11445\r\n29 swift                    0x00000001099c600a frontend_main(llvm::ArrayRef<char const*>, char const*, void*) + 2682\r\n30 swift                    0x00000001099c2697 main + 2247\r\n31 libdyld.dylib            0x00007fff8b77f5ad start + 1\r\n32 libdyld.dylib            0x000000000000003a start + 1955072654\r\n\r\n\r\n\r\nStack trace for b):\r\n\r\n(binary_expr type='<<error type>>' location=/Users/janoschhildebrand/Dropbox/Projects/Apple Bugs/untitled folder 2/Crash/Crash/main.swift:22:14 range=[/Users/janoschhildebrand/Dropbox/Projects/Apple Bugs/untitled folder 2/Crash/Crash/main.swift:22:13 - line:22:17] nothrow\r\n  (overloaded_decl_ref_expr type='<<error type>>' location=/Users/janoschhildebrand/Dropbox/Projects/Apple Bugs/untitled folder 2/Crash/Crash/main.swift:22:14 range=[/Users/janoschhildebrand/Dropbox/Projects/Apple Bugs/untitled folder 2/Crash/Crash/main.swift:22:14 - line:22:14] name=..< #decls=3 specialized=no\r\n  Swift.(file)...<\r\n  Swift.(file)...<\r\n  Swift.(file)...<)\r\n  (tuple_expr type='<<error type>>' location=/Users/janoschhildebrand/Dropbox/Projects/Apple Bugs/untitled folder 2/Crash/Crash/main.swift:22:13 range=[/Users/janoschhildebrand/Dropbox/Projects/Apple Bugs/untitled folder 2/Crash/Crash/main.swift:22:13 - line:22:17]\r\n    (integer_literal_expr type='<<error type>>' location=/Users/janoschhildebrand/Dropbox/Projects/Apple Bugs/untitled folder 2/Crash/Crash/main.swift:22:13 range=[/Users/janoschhildebrand/Dropbox/Projects/Apple Bugs/untitled folder 2/Crash/Crash/main.swift:22:13 - line:22:13] value=0)\r\n    (integer_literal_expr type='<<error type>>' location=/Users/janoschhildebrand/Dropbox/Projects/Apple Bugs/untitled folder 2/Crash/Crash/main.swift:22:17 range=[/Users/janoschhildebrand/Dropbox/Projects/Apple Bugs/untitled folder 2/Crash/Crash/main.swift:22:17 - line:22:17] value=100)))\r\n0  swift                    0x0000000102aa2edb llvm::sys::PrintStackTrace(__sFILE*) + 43\r\n1  swift                    0x0000000102aa361b SignalHandler(int) + 379\r\n2  libsystem_platform.dylib 0x00007fff95333eaa _sigtramp + 26\r\n3  swift                    0x0000000102a5d458 llvm::FoldingSetNodeID::operator==(llvm::FoldingSetNodeID const&) const + 40\r\n\r\n\r\n\r\nStack trace for c):\r\n\r\n0  swift                    0x00000001099d5edb llvm::sys::PrintStackTrace(__sFILE*) + 43\r\n1  swift                    0x00000001099d661b SignalHandler(int) + 379\r\n2  libsystem_platform.dylib 0x00007fff95333eaa _sigtramp + 26\r\n3  libsystem_platform.dylib 0x00000000ffffffff _sigtramp + 1791803759\r\n4  swift                    0x0000000107c1f739 swift::Lowering::adjustFunctionType(swift::CanTypeWrapper<swift::AnyFunctionType>, swift::AnyFunctionType::ExtInfo) + 25\r\n5  swift                    0x0000000107c1fd9a swift::Lowering::TypeConverter::getConstantInfo(swift::SILDeclRef) + 250\r\n6  swift                    0x0000000107c42843 swift::SILModule::getOrCreateFunction(swift::SILLocation, swift::SILDeclRef, swift::ForDefinition_t) + 147\r\n7  swift                    0x0000000107c829f5 swift::Lowering::SILGenModule::getFunction(swift::SILDeclRef, swift::ForDefinition_t) + 117\r\n8  swift                    0x0000000107c844bc swift::Lowering::SILGenModule::emitClosure(swift::AbstractClosureExpr*) + 76\r\n9  swift                    0x0000000107cc29f1 (anonymous namespace)::RValueEmitter::visitAbstractClosureExpr(swift::AbstractClosureExpr*, swift::Lowering::SGFContext) + 97\r\n10 swift                    0x0000000107cbadc9 swift::ASTVisitor<(anonymous namespace)::RValueEmitter, swift::Lowering::RValue, void, void, void, void, void, swift::Lowering::SGFContext>::visit(swift::Expr*, swift::Lowering::SGFContext) + 409\r\n11 swift                    0x0000000107cb93ad swift::Lowering::SILGenFunction::emitIgnoredExpr(swift::Expr*) + 397\r\n12 swift                    0x0000000107cbcf55 swift::ASTVisitor<(anonymous namespace)::RValueEmitter, swift::Lowering::RValue, void, void, void, void, void, swift::Lowering::SGFContext>::visit(swift::Expr*, swift::Lowering::SGFContext) + 8997\r\n13 swift                    0x0000000107cb93ad swift::Lowering::SILGenFunction::emitIgnoredExpr(swift::Expr*) + 397\r\n14 swift                    0x0000000107c86066 swift::Lowering::SILGenModule::visitTopLevelCodeDecl(swift::TopLevelCodeDecl*) + 198\r\n15 swift                    0x0000000107c8666b swift::Lowering::SILGenModule::emitSourceFile(swift::SourceFile*, unsigned int) + 779\r\n16 swift                    0x0000000107c87230 swift::SILModule::constructSIL(swift::ModuleDecl*, swift::SILOptions&, swift::FileUnit*, llvm::Optional<unsigned int>, bool, bool) + 944\r\n17 swift                    0x0000000107c875dd swift::performSILGeneration(swift::FileUnit&, swift::SILOptions&, llvm::Optional<unsigned int>, bool) + 109\r\n18 swift                    0x0000000107ae5ed5 performCompile(swift::CompilerInstance&, swift::CompilerInvocation&, llvm::ArrayRef<char const*>, int&) + 11445\r\n19 swift                    0x0000000107ae300a frontend_main(llvm::ArrayRef<char const*>, char const*, void*) + 2682\r\n20 swift                    0x0000000107adf697 main + 2247\r\n21 libdyld.dylib            0x00007fff8b77f5ad start + 1\r\n22 libdyld.dylib            0x000000000000003a start + 1955072654\r\n\r\nVersion:\r\nXcode 7.0b6 (7A192o)\r\nApple Swift version 2.0 (swiftlang-700.0.57.3 clang-700.0.72)\r\n\r\nNotes:\r\nPotentially related to rdar://22436079."
    email: janoschhildebrand@gmail.com
    modified: "2015-10-16T10:34:33.82412Z"
    number: "22436222"
    number_intvalue: 22436222
    originated: 26-Aug-2015
    parent_number: '&{NULL_VALUE}'
    product: Developer tools
    product_version: Xcode 7.0b6 (7A192o)
    reproducible: Always
    resolved: Xcode 7.1b2
    status: Duplicate of 22436079 (Closed)
    title: 'Xcode 7.0b6 (7A192o): [Swift] Various compiler crashes on closure creating UnsafePointer array using map'
