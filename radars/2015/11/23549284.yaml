apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "23549284"
    labels:
        datastore_id: "4980151246913536"
data:
    classification: Crash/Hang/Data Loss
    created: "2015-11-15T23:10:33.12179Z"
    description: "Summary:\r\nThe following code crashes the Swift compiler:\r\n\r\nSteps to Reproduce:\r\nimport Foundation\r\n\r\nclass BinaryHeap<T: AnyObject where T: Comparable>\r\n{\r\n    let heap: CFBinaryHeap\r\n    init() {\r\n        var callbacks = CFBinaryHeapCallBacks(\r\n            version: 0,\r\n            retain: { _, obj in\r\n                Unmanaged<T>.fromOpaque(COpaquePointer(obj)).retain()\r\n                return obj\r\n            },\r\n            release: { _, obj in\r\n                Unmanaged<T>.fromOpaque(COpaquePointer(obj)).release()\r\n            },\r\n            copyDescription: { obj in\r\n                let o = Unmanaged<T>.fromOpaque(COpaquePointer(obj)).takeUnretainedValue()\r\n                return Unmanaged.passRetained(String(o) as CFString)\r\n            },\r\n            compare: { obj1, obj2, _ in\r\n                let o1 = Unmanaged<T>.fromOpaque(COpaquePointer(obj1)).takeUnretainedValue()\r\n                let o2 = Unmanaged<T>.fromOpaque(COpaquePointer(obj2)).takeUnretainedValue()\r\n                if o1 == o2 { return .CompareEqualTo }\r\n                if o1 < o2 { return .CompareLessThan }\r\n                return .CompareGreaterThan\r\n            }\r\n        )\r\n        heap = CFBinaryHeapCreate(nil, 0, &callbacks, nil)\r\n    }\r\n}\r\n\r\nExpected Results:\r\nNo crash.\r\n\r\nActual Results:\r\nSegfault:\r\n\r\n0  swift                    0x0000000105ddc33b llvm::sys::PrintStackTrace(__sFILE*) + 43\r\n1  swift                    0x0000000105ddca7b SignalHandler(int) + 379\r\n2  libsystem_platform.dylib 0x00007fff9d65beaa _sigtramp + 26\r\n3  libsystem_platform.dylib 0x0000000000000003 _sigtramp + 1654276467\r\n4  swift                    0x0000000103fac4ab swift::irgen::emitPolymorphicArguments(swift::irgen::IRGenFunction&, swift::CanTypeWrapper<swift::SILFunctionType>, swift::CanTypeWrapper<swift::SILFunctionType>, llvm::ArrayRef<swift::Substitution>, swift::irgen::WitnessMetadata*, swift::irgen::Explosion&) + 587\r\n5  swift                    0x0000000103ff90ac (anonymous namespace)::IRGenSILFunction::visitFullApplySite(swift::FullApplySite) + 2172\r\n6  swift                    0x0000000103feabad swift::irgen::IRGenModule::emitSILFunction(swift::SILFunction*) + 10973\r\n7  swift                    0x0000000103f51253 swift::irgen::IRGenModuleDispatcher::emitLazyDefinitions() + 307\r\n8  swift                    0x0000000103fd169a performIRGeneration(swift::IRGenOptions&, swift::ModuleDecl*, swift::SILModule*, llvm::StringRef, llvm::LLVMContext&, swift::SourceFile*, unsigned int) + 1034\r\n9  swift                    0x0000000103fd1a30 swift::performIRGeneration(swift::IRGenOptions&, swift::SourceFile&, swift::SILModule*, llvm::StringRef, llvm::LLVMContext&, unsigned int) + 64\r\n10 swift                    0x0000000103ed0465 performCompile(swift::CompilerInstance&, swift::CompilerInvocation&, llvm::ArrayRef<char const*>, int&) + 13701\r\n11 swift                    0x0000000103ecccd3 frontend_main(llvm::ArrayRef<char const*>, char const*, void*) + 2691\r\n12 swift                    0x0000000103ec9354 main + 2324\r\n13 libdyld.dylib            0x00007fff9e79f5ad start + 1\r\n14 libdyld.dylib            0x000000000000000f start + 1636174435\r\nStack dump:\r\n0.\tProgram arguments: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift -frontend -c -primary-file - -target x86_64-apple-darwin15.2.0 -enable-objc-interop -sdk /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.11.sdk -color-diagnostics -module-name main -o /var/folders/lp/hlnmlhtn79s4qvxx8c7bppbw0000gn/T/--d9fefa.o \r\n1.\tWhile emitting IR SIL function @_TToFFC4main10BinaryHeapcuRq_Ss9AnyObjectq_Ss10Comparable_FMGS0_q__FT_GS0_q__U2_FTGVSs13UnsafePointerT__GS3_T__GVSs20UnsafeMutablePointerT___OSC18CFComparisonResult for expression at [<stdin>:20:22 - line:26:13] RangeText=\"{ obj1, obj2, _ in\r\n                let o1 = Unmanaged<T>.fromOpaque(COpaquePointer(obj1)).takeUnretainedValue()\r\n                let o2 = Unmanaged<T>.fromOpaque(COpaquePointer(obj2)).takeUnretainedValue()\r\n                if o1 == o2 { return .CompareEqualTo }\r\n                if o1 < o2 { return .CompareLessThan }\r\n                return .CompareGreaterThan\r\n            }\"\r\n\r\nVersion:\r\nXcode 7.2 beta (7C46t)\r\nOS X 10.11.2 (15C40a)\r\n\r\n\r\nConfiguration:\r\nApple Swift version 2.1 (swiftlang-700.1.101.6 clang-700.1.76)\r\nTarget: x86_64-apple-darwin15.2.0"
    email: jtbandes@gmail.com
    modified: "2015-11-15T23:10:33.12219Z"
    number: "23549284"
    number_intvalue: 23549284
    originated: 11/14/2015
    parent_number: '&{NULL_VALUE}'
    product: Developer Tools
    product_version: ""
    reproducible: Always
    resolved: ""
    status: Open
    title: 'Swift: crash with CFBinaryHeapCallBacks'
