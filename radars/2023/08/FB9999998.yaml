apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: FB9999998
    labels:
        datastore_id: "5569054056120320"
data:
    classification: Crash
    created: "2023-08-31T05:20:41.275469Z"
    description: "We recently observed a crash spike on iOS 17 since July 26, including the most recent beta 8 releases. This appears to be crashing from iOS's internal \"com.apple.network.connections\" queue from within Network.framework's QUIC/Http3 implementation stack (libquic). We believe this crash happens in a relatively high-loss networking environment, and iOS client is expecting to receive data via URLSession (with Http3/Quic), and libquic's loss detection implementation decided to declare packet loss and crashed. \r\n\r\nFull stack trace pasted below for your reference. Our app is currently built with Xcode 14.2 toolchain. \r\n\r\nSimilar issue appears to have been reported in https://developer.apple.com/forums/thread/735080 and https://github.com/firebase/firebase-ios-sdk/issues/11655 from multiple people.  \r\n\r\n\r\n\r\n\r\n\r\nFull Stack Trace \r\n\r\nEXC_BAD_ACCESS\r\n_quic_recovery_declare_packets_lost\r\nAttempted to dereference null pointer.\r\nAug 30th 2023, 13:08:45 PDT\r\n\r\nSTACKTRACE\r\n\r\nCrashReporter Key:  d8eb75b9794bf1f2f7372e8e60de4ff343b9b3ff\r\nHardware Model:     iPhone15,2\r\nProcess:            XXX\r\nIdentifier:         XXX\r\nVersion:            11.31\r\nRole:               Foreground\r\nOS Version:         iOS 17.0\r\nException Type:     EXC_BAD_ACCESS \r\nException Subtype:  KERN_INVALID_ADDRESS\r\n\r\n\r\nEXC_BAD_ACCESS: Attempted to dereference null pointer.\r\n\r\n0  libquic.dylib +0x20a98          _quic_recovery_declare_packets_lost\r\n1  libquic.dylib +0x1ffa4          _quic_recovery_find_lost_packet_inner\r\n2  libquic.dylib +0x1dd58          _quic_recovery_find_lost_packets\r\n3  libquic.dylib +0x11354          _quic_recovery_received_ack\r\n4  libquic.dylib +0x51e64          _quic_frame_process_ACK\r\n5  libquic.dylib +0xb3a38          _quic_conn_process_frame\r\n6  libquic.dylib +0xb01e4          _quic_conn_process_inbound\r\n7  Network +0x323e6c               _nw_protocol_data_access_buffer\r\n8  libquic.dylib +0xb69cc          ___quic_conn_handle_inbound_block_invoke\r\n9  libquic.dylib +0xb6790          _quic_conn_handle_inbound\r\n10 Network +0x3104d8               ___nw_protocol_implementation_get_input_internal_block_invoke\r\n11 Network +0x30fb00               _nw_protocol_implementation_read\r\n12 Network +0x30f354               _nw_protocol_implementation_input_available\r\n13 Network +0x1edc4                nw_channel_update_input_source(nw_channel*, nw_protocol*, bool)\r\n14 Network +0x91a54c               ____ZL17nw_channel_createP10nw_contextPhjPvjbbPb_block_invoke.43\r\n15 libdispatch.dylib +0x42fc       __dispatch_client_callout\r\n16 libdispatch.dylib +0x77b4       __dispatch_continuation_pop\r\n17 libdispatch.dylib +0x1b5bc      __dispatch_source_latch_and_call\r\n18 libdispatch.dylib +0x1a18c      __dispatch_source_invoke\r\n19 libdispatch.dylib +0xd6a4       __dispatch_workloop_invoke\r\n20 libdispatch.dylib +0x17000      __dispatch_root_queue_drain_deferred_wlh\r\n21 libdispatch.dylib +0x16874      __dispatch_workloop_worker_thread\r\n22 libsystem_pthread.dylib +0x1960 __pthread_wqthread\r\n\r\nTHREADS\r\n\r\nThread 0 - (TH_STATE_WAITING)\r\n0  libsystem_kernel.dylib +0x11d4 _mach_msg2_trap\r\n1  libsystem_kernel.dylib +0xf6c  _mach_msg2_internal\r\n2  libsystem_kernel.dylib +0xe84  _mach_msg_overwrite\r\n3  libsystem_kernel.dylib +0xcc4  _mach_msg\r\n4  CoreFoundation +0x364b8        ___CFRunLoopServiceMachPort\r\n5  CoreFoundation +0x343b0        ___CFRunLoopRun\r\n6  CoreFoundation +0x33e14        _CFRunLoopRunSpecific\r\n7  GraphicsServices +0x35e8       _GSEventRunModal\r\n8  UIKitCore +0x22f2fc            -[UIApplication _run]\r\n9  UIKitCore +0x22e938            _UIApplicationMain\r\n10 XXX +0x3fe9c             main (main.m:15:16)\r\n11 dyld +0x5d40                   start\r\n\r\nThread 1 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x972c  ___workq_kernreturn\r\n1 libsystem_pthread.dylib +0x19ac __pthread_wqthread\r\n\r\nThread 2 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x972c  ___workq_kernreturn\r\n1 libsystem_pthread.dylib +0x19ac __pthread_wqthread\r\n\r\nThread 3 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x972c  ___workq_kernreturn\r\n1 libsystem_pthread.dylib +0x19ac __pthread_wqthread\r\n\r\nThread 4 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x972c  ___workq_kernreturn\r\n1 libsystem_pthread.dylib +0x19ac __pthread_wqthread\r\n\r\nThread 5 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x972c  ___workq_kernreturn\r\n1 libsystem_pthread.dylib +0x19ac __pthread_wqthread\r\n\r\nThread 6 - (TH_STATE_WAITING)\r\n0  libquic.dylib +0x20a98          _quic_recovery_declare_packets_lost\r\n1  libquic.dylib +0x1ffa4          _quic_recovery_find_lost_packet_inner\r\n2  libquic.dylib +0x1dd58          _quic_recovery_find_lost_packets\r\n3  libquic.dylib +0x11354          _quic_recovery_received_ack\r\n4  libquic.dylib +0x51e64          _quic_frame_process_ACK\r\n5  libquic.dylib +0xb3a38          _quic_conn_process_frame\r\n6  libquic.dylib +0xb01e4          _quic_conn_process_inbound\r\n7  Network +0x323e6c               _nw_protocol_data_access_buffer\r\n8  libquic.dylib +0xb69cc          ___quic_conn_handle_inbound_block_invoke\r\n9  libquic.dylib +0xb6790          _quic_conn_handle_inbound\r\n10 Network +0x3104d8               ___nw_protocol_implementation_get_input_internal_block_invoke\r\n11 Network +0x30fb00               _nw_protocol_implementation_read\r\n12 Network +0x30f354               _nw_protocol_implementation_input_available\r\n13 Network +0x1edc4                nw_channel_update_input_source(nw_channel*, nw_protocol*, bool)\r\n14 Network +0x91a54c               ____ZL17nw_channel_createP10nw_contextPhjPvjbbPb_block_invoke.43\r\n15 libdispatch.dylib +0x42fc       __dispatch_client_callout\r\n16 libdispatch.dylib +0x77b4       __dispatch_continuation_pop\r\n17 libdispatch.dylib +0x1b5bc      __dispatch_source_latch_and_call\r\n18 libdispatch.dylib +0x1a18c      __dispatch_source_invoke\r\n19 libdispatch.dylib +0xd6a4       __dispatch_workloop_invoke\r\n20 libdispatch.dylib +0x17000      __dispatch_root_queue_drain_deferred_wlh\r\n21 libdispatch.dylib +0x16874      __dispatch_workloop_worker_thread\r\n22 libsystem_pthread.dylib +0x1960 __pthread_wqthread\r\n\r\nThread 7 - (TH_STATE_WAITING)\r\n0  libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1  libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2  libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3  libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4  CoreFoundation +0x364b8         ___CFRunLoopServiceMachPort\r\n5  CoreFoundation +0x343b0         ___CFRunLoopRun\r\n6  CoreFoundation +0x33e14         _CFRunLoopRunSpecific\r\n7  Foundation +0x2c828             -[NSRunLoop(NSRunLoop) runMode:beforeDate:]\r\n8  Foundation +0x5b5e0             -[NSRunLoop(NSRunLoop) runUntilDate:]\r\n9  UIKitCore +0x1910cc             -[UIEventFetcher threadMain]\r\n10 Foundation +0xb2520             ___NSThread__start__\r\n11 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 8 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x972c  ___workq_kernreturn\r\n1 libsystem_pthread.dylib +0x19ac __pthread_wqthread\r\n\r\nThread 9 - (TH_STATE_WAITING)\r\n0  libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1  libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2  libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3  libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4  CoreFoundation +0x364b8         ___CFRunLoopServiceMachPort\r\n5  CoreFoundation +0x343b0         ___CFRunLoopRun\r\n6  CoreFoundation +0x33e14         _CFRunLoopRunSpecific\r\n7  Foundation +0x2c828             -[NSRunLoop(NSRunLoop) runMode:beforeDate:]\r\n8  Networking +0x10fbb0            base::MessagePumpNSRunLoop::DoRun(base::MessagePump::Delegate*)\r\n9  Networking +0x10e398            base::MessagePumpCFRunLoopBase::Run(base::MessagePump::Delegate*)\r\n10 Networking +0xc43f8             base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta)\r\n11 Networking +0x8fe6c             base::RunLoop::Run(base::Location const&)\r\n12 Networking +0xe831c             base::Thread::Run(base::RunLoop*)\r\n13 Networking +0xd245c             base::internal::ServiceThread::Run(base::RunLoop*)\r\n14 Networking +0xe8444             base::Thread::ThreadMain()\r\n15 Networking +0x1089b8            base::(anonymous namespace)::ThreadFunc(void*)\r\n16 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 10 - (TH_STATE_WAITING)\r\n0  libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1  libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2  libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3  libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4  Networking +0x111c98            base::WaitableEvent::TimedWaitImpl(base::TimeDelta)\r\n5  Networking +0xaa678             base::WaitableEvent::TimedWait(base::TimeDelta)\r\n6  Networking +0xdb980             base::internal::WorkerThread::Delegate::WaitForWork(base::WaitableEvent*)\r\n7  Networking +0xdc544             base::internal::WorkerThread::RunWorker()\r\n8  Networking +0xdc1b8             base::internal::WorkerThread::RunPooledWorker()\r\n9  Networking +0xdc0ac             base::internal::WorkerThread::ThreadMain()\r\n10 Networking +0x1089b8            base::(anonymous namespace)::ThreadFunc(void*)\r\n11 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 11 - (TH_STATE_WAITING)\r\n0  libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1  libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2  libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3  libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4  Networking +0x111c98            base::WaitableEvent::TimedWaitImpl(base::TimeDelta)\r\n5  Networking +0xaa678             base::WaitableEvent::TimedWait(base::TimeDelta)\r\n6  Networking +0xdb980             base::internal::WorkerThread::Delegate::WaitForWork(base::WaitableEvent*)\r\n7  Networking +0xdc340             base::internal::WorkerThread::RunWorker()\r\n8  Networking +0xdc134             base::internal::WorkerThread::RunBackgroundPooledWorker()\r\n9  Networking +0xdc0dc             base::internal::WorkerThread::ThreadMain()\r\n10 Networking +0x1089b8            base::(anonymous namespace)::ThreadFunc(void*)\r\n11 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 12 - (TH_STATE_WAITING)\r\n0  libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1  libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2  libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3  libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4  CoreFoundation +0x364b8         ___CFRunLoopServiceMachPort\r\n5  CoreFoundation +0x343b0         ___CFRunLoopRun\r\n6  CoreFoundation +0x33e14         _CFRunLoopRunSpecific\r\n7  Foundation +0x2c828             -[NSRunLoop(NSRunLoop) runMode:beforeDate:]\r\n8  Networking +0x10fbb0            base::MessagePumpNSRunLoop::DoRun(base::MessagePump::Delegate*)\r\n9  Networking +0x10e398            base::MessagePumpCFRunLoopBase::Run(base::MessagePump::Delegate*)\r\n10 Networking +0xc43f8             base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta)\r\n11 Networking +0x8fe6c             base::RunLoop::Run(base::Location const&)\r\n12 Networking +0xe831c             base::Thread::Run(base::RunLoop*)\r\n13 Networking +0xe8444             base::Thread::ThreadMain()\r\n14 Networking +0x1089b8            base::(anonymous namespace)::ThreadFunc(void*)\r\n15 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 13 - (TH_STATE_WAITING)\r\n0  libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1  libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2  libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3  libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4  CoreFoundation +0x364b8         ___CFRunLoopServiceMachPort\r\n5  CoreFoundation +0x343b0         ___CFRunLoopRun\r\n6  CoreFoundation +0x33e14         _CFRunLoopRunSpecific\r\n7  Foundation +0x2c828             -[NSRunLoop(NSRunLoop) runMode:beforeDate:]\r\n8  Networking +0x10fbb0            base::MessagePumpNSRunLoop::DoRun(base::MessagePump::Delegate*)\r\n9  Networking +0x10e398            base::MessagePumpCFRunLoopBase::Run(base::MessagePump::Delegate*)\r\n10 Networking +0xc43f8             base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta)\r\n11 Networking +0x8fe6c             base::RunLoop::Run(base::Location const&)\r\n12 Networking +0xe831c             base::Thread::Run(base::RunLoop*)\r\n13 Networking +0xe8444             base::Thread::ThreadMain()\r\n14 Networking +0x1089b8            base::(anonymous namespace)::ThreadFunc(void*)\r\n15 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 14 - (TH_STATE_WAITING)\r\n0  libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1  libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2  libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3  libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4  CoreFoundation +0x364b8         ___CFRunLoopServiceMachPort\r\n5  CoreFoundation +0x343b0         ___CFRunLoopRun\r\n6  CoreFoundation +0x33e14         _CFRunLoopRunSpecific\r\n7  Foundation +0x2c828             -[NSRunLoop(NSRunLoop) runMode:beforeDate:]\r\n8  Networking +0x10fbb0            base::MessagePumpNSRunLoop::DoRun(base::MessagePump::Delegate*)\r\n9  Networking +0x10e398            base::MessagePumpCFRunLoopBase::Run(base::MessagePump::Delegate*)\r\n10 Networking +0xc43f8             base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta)\r\n11 Networking +0x8fe6c             base::RunLoop::Run(base::Location const&)\r\n12 Networking +0xe831c             base::Thread::Run(base::RunLoop*)\r\n13 Networking +0xe8444             base::Thread::ThreadMain()\r\n14 Networking +0x1089b8            base::(anonymous namespace)::ThreadFunc(void*)\r\n15 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 15 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x972c  ___workq_kernreturn\r\n1 libsystem_pthread.dylib +0x19ac __pthread_wqthread\r\n\r\nThread 16 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1 libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2 libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3 libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4 CoreFoundation +0x364b8         ___CFRunLoopServiceMachPort\r\n5 CoreFoundation +0x343b0         ___CFRunLoopRun\r\n6 CoreFoundation +0x33e14         _CFRunLoopRunSpecific\r\n7 CFNetwork +0x258794             0x189000794 (0x189000618 + 380)\r\n8 Foundation +0xb2520             ___NSThread__start__\r\n9 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 17 - (TH_STATE_WAITING)\r\n0  libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1  libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2  libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3  libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4  Networking +0x111c98            base::WaitableEvent::TimedWaitImpl(base::TimeDelta)\r\n5  Networking +0xaa678             base::WaitableEvent::TimedWait(base::TimeDelta)\r\n6  Networking +0xdb980             base::internal::WorkerThread::Delegate::WaitForWork(base::WaitableEvent*)\r\n7  Networking +0xdc544             base::internal::WorkerThread::RunWorker()\r\n8  Networking +0xdc1b8             base::internal::WorkerThread::RunPooledWorker()\r\n9  Networking +0xdc0ac             base::internal::WorkerThread::ThreadMain()\r\n10 Networking +0x1089b8            base::(anonymous namespace)::ThreadFunc(void*)\r\n11 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 18 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1 libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2 libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3 libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4 Bugsnag +0x2d188                ksmachexc_i_handleExceptions (BSG_KSCrashSentry_MachException.c:229:36)\r\n5 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 19 - KSCrash Exception Handler (Primary) - (TH_STATE_RUNNING)\r\n0 unknown file -0x4 unknown method\r\n\r\nThread 20 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x1150  _semaphore_wait_trap\r\n1 libdispatch.dylib +0x4898       __dispatch_sema4_wait\r\n2 libdispatch.dylib +0x4f48       __dispatch_semaphore_wait_slow\r\n3 Bugsnag +0x30a3c                -[BSGAppHangDetector detectAppHangs] (BSGAppHangDetector.m:125:13)\r\n4 Bugsnag +0x309c8                DetectAppHangs (BSGAppHangDetector.m:214:5)\r\n5 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 21 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x972c  ___workq_kernreturn\r\n1 libsystem_pthread.dylib +0x19ac __pthread_wqthread\r\n\r\nThread 22 - (TH_STATE_WAITING)\r\n0  libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1  libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2  libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3  libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4  Networking +0x111c98            base::WaitableEvent::TimedWaitImpl(base::TimeDelta)\r\n5  Networking +0xaa678             base::WaitableEvent::TimedWait(base::TimeDelta)\r\n6  Networking +0xdb980             base::internal::WorkerThread::Delegate::WaitForWork(base::WaitableEvent*)\r\n7  Networking +0xdc340             base::internal::WorkerThread::RunWorker()\r\n8  Networking +0xdc1b8             base::internal::WorkerThread::RunPooledWorker()\r\n9  Networking +0xdc0ac             base::internal::WorkerThread::ThreadMain()\r\n10 Networking +0x1089b8            base::(anonymous namespace)::ThreadFunc(void*)\r\n11 libsystem_pthread.dylib +0x24d0 __pthread_start\r\n\r\nThread 23 - (TH_STATE_WAITING)\r\n0 libsystem_kernel.dylib +0x11d4  _mach_msg2_trap\r\n1 libsystem_kernel.dylib +0xf6c   _mach_msg2_internal\r\n2 libsystem_kernel.dylib +0xe84   _mach_msg_overwrite\r\n3 libsystem_kernel.dylib +0xcc4   _mach_msg\r\n4 CoreFoundation +0x364b8         ___CFRunLoopServiceMachPort\r\n5 CoreFoundation +0x343b0         ___CFRunLoopRun\r\n6 CoreFoundation +0x33e14         _CFRunLoopRunSpecific\r\n7 CFNetwork +0x258794             0x189000794 (0x189000618 + 380)\r\n8 Foundation +0xb2520             ___NSThread__start__\r\n9 libsystem_pthread.dylib +0x24d0 __pthread_start"
    email: dennycd@pinterest.com
    modified: "2023-08-31T16:15:02.910353Z"
    number: FB9999998
    number_intvalue: 9999998
    originated: ""
    parent_number: '&{NULL_VALUE}'
    product: iOS SDK
    product_version: iOS 17 Beta 4 ~ Beta 8
    reproducible: ""
    resolved: ""
    status: Open
    title: iOS 17 crash on quic_recovery_declare_packets_lost
