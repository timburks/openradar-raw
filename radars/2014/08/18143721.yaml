apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "18143721"
    labels:
        datastore_id: "4966205588766720"
data:
    classification: ""
    created: "2014-08-27T03:22:34.337884Z"
    description: "Summary:\r\nOn device only, trying to make a new background NSURLSession from a today view extension logs sandbox permissions errors to the console and is unable to upload files.  As outlined in the app extension programming guide, the sharedContainerIdentifier on the configuration used to create the URL session was set to the identifier of the app group. The app groups is enabled for and the app group ID is added to the app IDs of both the extension and the main app, and the corresponding values are in the app and appex entitlement files. \r\n\r\nFurthermore, attempting to create upload tasks with the session fail with similar permissions errors logged. The error reported to URLSession:task:didCompleteWithError: is NSPOSIXErrorDomain -- code: 2.  The same issues occur whether the items are done on a background thread or on the main thread. \r\n\r\nBackground upload works as expected on simulator.\r\n\r\nSteps to Reproduce:\r\n1. Create background NSURLSession with app group ID in sharedContainerIdentifier property of the configuration object.\r\n2. Console logs report sandboxing errors.\r\n3. Create upload tasks by sending the uploadTaskWithRequest:fromFile: message to the NSURLSession.\r\n4. Console logs report more errors  and uploads fail.\r\n\r\nExpected Results:\r\nI would expect the background NSURLSession to upload the files as it does in the simulator using the shared container.\r\n\r\nActual Results:\r\nUpload fails on device due to permissions issues.   Here are the relevant console logs:\r\n\r\nAug 26 19:47:01 iPhone-5S-1 com.getdropbox.DropboxExtensionTest.DropboxTodayView[383] <Error>: Failed to issue sandbox extension for file file:///private/var/mobile/Containers/Shared/AppGroup/93C71934-7BDF-45BB-9106-4FD0BC60756E/logPoolBeingUploadedByExtension/ios_iPhone6,1_8.0_3.2-b2_178ED533-49DA-46CE-B068-6495F092F25D_1409107621_ANALYTICS_0_849221010.log.extensionbackgroundupload, errno = 1\r\nAug 26 19:47:01 iPhone-5S-1 nsurlsessiond[113] <Error>: Error linking upload file: Error Domain=NSCocoaErrorDomain Code=257 \"The operation couldn’t be completed. (Cocoa error 257.)\" UserInfo=0x157e1ff20 {NSFilePath=/private/var/mobile/Containers/Shared/AppGroup/93C71934-7BDF-45BB-9106-4FD0BC60756E/logPoolBeingUploadedByExtension/ios_iPhone6,1_8.0_3.2-b2_178ED533-49DA-46CE-B068-6495F092F25D_1409107621_ANALYTICS_0_849221010.log.extensionbackgroundupload, NSUnderlyingError=0x157e1e1e0 \"The operation couldn’t be completed. Operation not permitted\"}\r\nAug 26 19:47:01 iPhone-5S-1 syncdefaultsd[388] <Notice>: (Note ) marked \"com.me.keyvalueservice\" topic as \"enabled\" on <APSConnection: 0x15e60f470>\r\nAug 26 19:47:01 iPhone-5S-1 syncdefaultsd[388] <Notice>: (Error) Process with pid 188 is not authorized to access com.apple.stocks\r\nAug 26 19:47:01 iPhone-5S-1 syncdefaultsd[388] <Notice>: (Note ) marked \"com.me.keyvalueservice\" topic as \"opportunistic\" on <APSConnection: 0x15e60f470>\r\nAug 26 19:47:01 iPhone-5S-1 kernel[0] <Notice>: 014466.168832 wlan0.A[339] AppleBCMWLANConfigManager::configureRoamingProfile(): Received new roaming profile 3 (was 3, flag=0x1)\r\nAug 26 19:47:01 iPhone-5S-1 nsurlsessiond[113] <Error>: __NSCFLocalDownloadFile: error 2 creating temp file: /private/var/mobile/Containers/Shared/AppGroup/93C71934-7BDF-45BB-9106-4FD0BC60756E/Library/Caches/com.apple.nsurlsessiond/Downloads/com.getdropbox.DropboxExtensionTest/CFNetworkDownload_m5yda0.tmp\r\n\r\nVersion:\r\niOS 8 beta 5\r\n\r\nNotes:\r\nOthers on the developer forums seem to be having similar issues, and also report somewhat similar issues for OS 10.10.  Here are a couple links for posts discussing this issue on iOS:\r\nhttps://devforums.apple.com/message/1021058#1021058\r\nhttps://devforums.apple.com/message/1030240#1030240\r\n\r\n\r\nConfiguration:\r\niPhone 5s 16GB, Verizon\r\n\r\nAttachments:"
    email: cs@dropbox.com
    modified: "2014-08-27T03:22:34.338079Z"
    number: "18143721"
    number_intvalue: 18143721
    originated: 8/26/2014
    parent_number: '&{NULL_VALUE}'
    product: iOS
    product_version: 8.0 beta 5
    reproducible: Always
    resolved: ""
    status: Open
    title: Background NSURLSession not permitted to access app group sandbox
