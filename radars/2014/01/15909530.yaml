apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "15909530"
    labels:
        datastore_id: "5184813115899904"
data:
    classification: Serious Bug
    created: "2014-01-25T18:54:54.79087Z"
    description: "Summary:\r\nCSBackupIsItemExcluded has several issues affecting its accuracy with path exclusions, including relative paths, symbolic links and user-excluded versus programmatically-excluded paths.\r\n\r\nSteps to Reproduce:\r\n1. Create a folder named \"exclusions\" in your home folder, which should not be excluded from Time Machine.\r\n\r\n% mkdir exclusions\r\n\r\n2. Create a symbolic link from \"exclusions-link\" to this folder:\r\n\r\n% ln -s exclusions exclusions-link\r\n\r\n3. Compile the attached source file in the folder:\r\n\r\n% clang -framework CoreServices -o excluded excluded.c\r\n\r\n4. Create three folders in exclusions-link.  Exclude one from Time Machine by path with Time Machine System Preferences, one by path with tmutil, and one by \"stickiness\" with tmutil:\r\n\r\n% cd exclusions-link\r\n% mkdir ExcludedByPathWithTimeMachineSystemPreferences ExcludedByPathWithTmutil ExcludedByStickiness\r\n% sudo tmutil addexclusion -p ExcludedByPathWithTmutil\r\nPassword:\r\n% tmutil addexclusion ExcludedByStickiness           \r\n% open .\r\n[drag \"ExcludedByPathWithTimeMachineSystemPreferences\" into System Preferences > Time Machine > Options…]\r\n\r\n5. Examine these folders for exclusion status with tmutil and with CSBackupIsItemExcluded, with relative, absolute and canonicalized paths:\r\n\r\n% tmutil isexcluded Excluded*\r\n% echo Excluded* | xargs -n 1 ./excluded\r\n% echo $PWD/Excluded* | xargs -n 1 ./excluded\r\n% cd ../exclusions\r\n% echo $PWD/Excluded* | xargs -n 1 ./excluded\r\n\r\nExpected Results:\r\nAll four methods correctly show the paths are excluded.\r\n\r\nActual Results:\r\ntmutil returns as expected; note that it canonicalizes paths as it prints them:\r\n\r\n% tmutil isexcluded Excluded*\r\n[Excluded]\t/Users/local/exclusions/ExcludedByPathWithTimeMachineSystemPreferences\r\n[Excluded]\t/Users/local/exclusions/ExcludedByPathWithTmutil\r\n[Excluded]\t/Users/local/exclusions/ExcludedByStickiness\r\n\r\nCSBackupIsItemExcluded only returns true for the \"sticky\" folder, for absolute and relative paths.  Note that the base URL printed below has already been canonicalized:\r\n\r\n% echo Excluded* | xargs -n 1 ./excluded\r\n<CFURL 0x7fe2b2c083d0 [0x7fff77512eb0]>{string = ExcludedByPathWithTimeMachineSystemPreferences, encoding = 134217984\r\n\tbase = <CFURL 0x7fe2b2c08450 [0x7fff77512eb0]>{string = file:///Users/local/exclusions/, encoding = 134217984, base = (null)}}\r\nnot excluded\r\n<CFURL 0x7ff0b1d04c20 [0x7fff77512eb0]>{string = ExcludedByPathWithTmutil, encoding = 134217984\r\n\tbase = <CFURL 0x7ff0b1d04c60 [0x7fff77512eb0]>{string = file:///Users/local/exclusions/, encoding = 134217984, base = (null)}}\r\nnot excluded\r\n<CFURL 0x7fcce0e04900 [0x7fff77512eb0]>{string = ExcludedByStickiness, encoding = 134217984\r\n\tbase = <CFURL 0x7fcce0e04940 [0x7fff77512eb0]>{string = file:///Users/local/exclusions/, encoding = 134217984, base = (null)}}\r\nexcluded\r\n% echo $PWD/Excluded* | xargs -n 1 ./excluded\r\n<CFURL 0x7fd368504c50 [0x7fff77512eb0]>{string = file:///Users/local/exclusions-link/ExcludedByPathWithTimeMachineSystemPreferences, encoding = 134217984, base = (null)}\r\nnot excluded\r\n<CFURL 0x7fc54b504c40 [0x7fff77512eb0]>{string = file:///Users/local/exclusions-link/ExcludedByPathWithTmutil, encoding = 134217984, base = (null)}\r\nnot excluded\r\n<CFURL 0x7fa4f1504bf0 [0x7fff77512eb0]>{string = file:///Users/local/exclusions-link/ExcludedByStickiness, encoding = 134217984, base = (null)}\r\nexcluded\r\n\r\nWith a canonicalized path, CSBackupIsItemExcluded returns true for the programmatically excluded path, but still not the user-excluded one:\r\n\r\n% cd ../exclusions\r\n% echo $PWD/Excluded* | xargs -n 1 ./excluded\r\n<CFURL 0x7fa00ac083b0 [0x7fff77512eb0]>{string = file:///Users/local/exclusions/ExcludedByPathWithTimeMachineSystemPreferences, encoding = 134217984, base = (null)}\r\nnot excluded\r\n<CFURL 0x7f9513e049d0 [0x7fff77512eb0]>{string = file:///Users/local/exclusions/ExcludedByPathWithTmutil, encoding = 134217984, base = (null)}\r\nexcluded by path\r\n<CFURL 0x7f9048c083d0 [0x7fff77512eb0]>{string = file:///Users/local/exclusions/ExcludedByStickiness, encoding = 134217984, base = (null)}\r\nexcluded\r\n\r\nVersion:\r\nXcode 5.0.2 (5A3005); OS X 10.9.1 (13B42)\r\n\r\nNotes:\r\nCanonicalizing the path before calling CSBackupIsItemExcluded would work around the issue with the programmatically-excluded path.  Reading the SkipPaths default from com.apple.TimeMachine directly would allow me to match against the user-excluded path.\r\n\r\n% defaults read /Library/Preferences/com.apple.TimeMachine SkipPaths\r\n(\r\n[…]    \"~local/exclusions/ExcludedByPathWithTimeMachineSystemPreferences\"\r\n)\r\n\r\nConfiguration:\r\nMac mini Mid 2011, 2.5 GHz Core i5, 8 GB RAM, RADEON HD 6630M, OS X 10.9.1 (13B42) \r\nMac mini Late 2012, 2.6 GHz Core i7, 16 GB RAM, Intel HD4000, OS X 10.8.5 (12F45)\r\n\r\nAttachments:\r\n'excluded.c' was successfully uploaded.\r\n\r\n[Attached file is uploaded to <http://sabi.net/temp/15909530.c>.]"
    email: nriley@gmail.com
    modified: "2014-01-25T18:54:54.79107Z"
    number: "15909530"
    number_intvalue: 15909530
    originated: 25-Jan-2014 12:52 PM
    parent_number: '&{NULL_VALUE}'
    product: OS X SDK
    product_version: Xcode 5.0.2 (5A3005); OS X 10.9.1 (13B42)
    reproducible: Always
    resolved: ""
    status: Open
    title: CSBackupIsItemExcluded inconsistently reports path exclusions
