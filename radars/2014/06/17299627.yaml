apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "17299627"
    labels:
        datastore_id: "5272709218959360"
data:
    classification: Serious Bug
    created: "2014-06-13T09:24:07.748761Z"
    description: "In my Mac App on the Mac App Store (http://fflp.me), the user can buy new content (new characters) from the Store (Cmd B) by clicking on the price or \"Restore\" (or \"Restore All\" in the menu. After the usual confirmation dialogs, the download begins, by landing in 'paymentQueue:updatedDownloads:' with the state SKDownloadStateActive. All goes fine, until almost 100%, when (I'm guessing) the internals of StoreKit go and unpack that .pkg to deliver me it's content.\r\n\r\nOn a \"normal\" (Administrator) user, all goes fine and I land in SKDownloadStateFinished where I can install the content.\r\n\r\nOn a Guest user though (used by the Apple Review Team as well), this happens — before SKDownloadStateFinished:\r\n\r\n\r\nstoreagent[274]: *** Assertion failure in -[SoftwareInstallOperation _startInstall], /SourceCache/Pisa/Pisa-232.6/iTunes Protocol/Built Into App/SoftwareInstallOperation.m:509\r\n\r\nstoreagent[274]: error Error Domain=PKInstallErrorDomain Code=100 \"The installation could not be started.\" UserInfo=0x7f9c9a4c0fa0 {NSLocalizedDescription=The installation could not be started., NSUnderlyingError=0x7f9c9a745e70 \"Authorization is required to install the packages.\"}\r\n\r\nstoreagent[274]: underlyingError Error Domain=PKInstallErrorDomain Code=100 \"Authorization is required to install the packages.\" UserInfo=0x7f9c9a745d40 {NSLocalizedDescription=Authorization is required to install the packages.}\r\n\r\nstoreagent[274]: localException [PKInstallClient initWithRequest:PKInstallRequest <1 packages, destination=/>] failed with Error Domain=PKInstallErrorDomain Code=100 \"Authorization is required to install the packages.\" UserInfo=0x7f9c9a745d40 {NSLocalizedDescription=Authorization is required to install the packages.}\r\n\r\nstoreagent[274]: -[SSDownload source]: unrecognized selector sent to instance 0x7f9c9a665c70\r\n\r\nstoreagent[274]: *** Terminating app due to uncaught exception 'NSInvalidArgumentException', reason: '-[SSDownload source]: unrecognized selector sent to instance 0x7f9c9a665c70'\r\n*** First throw call stack:\r\n(\r\n\t0   CoreFoundation                      0x00007fff96fe725c __exceptionPreprocess + 172\r\n\t1   libobjc.A.dylib                     0x00007fff8d802e75 objc_exception_throw + 43\r\n\t2   CoreFoundation                      0x00007fff96fea12d -[NSObject(NSObject) doesNotRecognizeSelector:] + 205\r\n\t3   CoreFoundation                      0x00007fff96f453f2 ___forwarding___ + 1010\r\n\t4   CoreFoundation                      0x00007fff96f44f78 _CF_forwarding_prep_0 + 120\r\n\t5   storeagent                          0x000000010e00f3ea storeagent + 156650\r\n\t6   storeagent                          0x000000010e05b8a6 storeagent + 469158\r\n\t7   storeagent                          0x000000010e0a9507 storeagent + 787719\r\n\t8   storeagent                          0x000000010e014d5d storeagent + 179549\r\n\t9   storeagent                          0x000000010e012b57 storeagent + 170839\r\n\t10  CoreFoundation                      0x00007fff96ed2bec __invoking___ + 140\r\n\t11  CoreFoundation                      0x00007fff96ed2a54 -[NSInvocation invoke] + 308\r\n\t12  CoreFoundation                      0x00007fff96f755e6 -[NSInvocation invokeWithTarget:] + 54\r\n\t13  CommerceKit                         0x00007fff98493246 -[ISDelegateProxy sendInvocationToDelegate:] + 294\r\n\t14  Foundation                          0x00007fff95dab13e __NSThreadPerformPerform + 229\r\n\t15  CoreFoundation                      0x00007fff96f18731 __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 17\r\n\t16  CoreFoundation                      0x00007fff96f09ea2 __CFRunLoopDoSources0 + 242\r\n\t17  CoreFoundation                      0x00007fff96f0962f __CFRunLoopRun + 831\r\n\t18  CoreFoundation                      0x00007fff96f090b5 CFRunLoopRunSpecific + 309\r\n\t19  CoreFoundation                      0x00007fff96fbe811 CFRunLoopRun + 97\r\n\t20  storeagent                          0x000000010e07db13 storeagent + 609043\r\n\t21  libdyld.dylib                       0x00007fff943e75fd start + 1\r\n)\r\n\r\nFflp![313]: === __61-[CKClientDispatch _sendMessage:callbackQueue:callbackBlock:]_block_invoke_2: Got error (Connection invalid).\r\nFflp![313]: === __61-[CKClientDispatch _sendMessage:callbackQueue:callbackBlock:]_block_invoke_2: Got error (Connection invalid).\r\nFflp![313]: === __61-[CKClientDispatch _sendMessage:callbackQueue:callbackBlock:]_block_invoke_2: Got error (Connection invalid).\r\ncom.apple.launchd.peruser.201[172]: (com.apple.storeagent[274]) Job appears to have crashed: Abort trap: 6\r\n\r\n—\r\n\r\n2 Apple Engineers told me during WWDC that it's a know bug and the Review Team then approved the app. The problem is that I'm now sure that someone using a guest account will loose money for nothing, which makes me have to check the user is not a guest."
    email: mc@stuffmc.com
    modified: "2014-06-13T09:35:08.184553Z"
    number: "17299627"
    number_intvalue: 17299627
    originated: "2014-06-13"
    parent_number: '&{NULL_VALUE}'
    product: OS X SDK
    product_version: Xcode 5.1.1, OS 10.9.4
    reproducible: Always
    resolved: ""
    status: Open
    title: 'In-App Purchase: Hosted Content cannot be unpacked if User is not Administrator'
