apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "9911657"
    labels:
        datastore_id: "1288408"
data:
    classification: Serious Bug
    created: "2011-08-07T21:34:29.681922Z"
    description: "Summary:\r\nThe AXTextMarkerForPosition parameterized Accessibility attribute is broken in Safari 5.1, and almost always returns the text marker corresponding to the upper left corner of the current visible area rather than the position given.\r\n\r\nSteps to Reproduce:\r\nCompile and run this program:\r\n\r\n// gcc -framework Cocoa -framework ApplicationServices axtest.m\r\n\r\n\r\n#import <Cocoa/Cocoa.h>\r\n\r\n\r\n#define ERR_CHECK( expr ) do { \\\r\n        AXError my_innerErr = expr; \\\r\n        if( my_innerErr ) \\\r\n        { \\\r\n            if(my_innerErr != kAXErrorAttributeUnsupported && \\\r\n\t\t\t   my_innerErr != kAXErrorNotImplemented && \\\r\n               my_innerErr != kAXErrorNoValue) \\\r\n                NSLog( @\"%s:%d: %s (%ld)\", __func__, __LINE__, GetMacOSStatusErrorString( my_innerErr ), (long)my_innerErr ); \\\r\n            return nil; \\\r\n        } \\\r\n    } while( 0 )\r\n\r\nstatic AXValueRef ValueForParameterizedAttribute(CFStringRef attr, CFTypeRef parameter, AXUIElementRef elt)\r\n{\r\n\tCFTypeRef result;\r\n\tERR_CHECK( AXUIElementCopyParameterizedAttributeValue( elt, attr, parameter, &result ) );\r\n\treturn CFMakeCollectable( result );\r\n}\r\n\r\nstatic id ValueForParameter(CFStringRef attr, AXUIElementRef elt)\r\n{\r\n    CFTypeRef result;\r\n    ERR_CHECK(AXUIElementCopyAttributeValue(elt, attr, &result));\r\n    return [(id)result autorelease];\r\n}\r\n\r\nstatic id Test(void)\r\n{\r\n    AXUIElementRef sysElement = AXUIElementCreateSystemWide();\r\n        \r\n    while(1)\r\n    {\r\n        NSPoint p = [NSEvent mouseLocation];\r\n        NSScreen *screen = [[NSScreen screens] objectAtIndex: 0];\r\n        p.y = [screen frame].size.height - p.y - 1;\r\n        \r\n\t\tAXValueRef ptObj = CFMakeCollectable( AXValueCreate( kAXValueCGPointType, &p ) );\r\n\t\t\r\n        AXUIElementRef elt;\r\n        ERR_CHECK( AXUIElementCopyElementAtPosition( sysElement, p.x, p.y, &elt ) );\r\n        \r\n        AXValueRef marker = ValueForParameterizedAttribute(CFSTR(\"AXTextMarkerForPosition\"), ptObj, elt);\r\n        if( !marker )\r\n            goto webkitFail;\r\n        \r\n        AXValueRef endMarker = ValueForParameterizedAttribute(CFSTR(\"AXNextSentenceEndTextMarkerForTextMarker\"), marker, elt);\r\n        if( !endMarker )\r\n            goto webkitFail;\r\n        \r\n        NSArray *markersArray = [NSArray arrayWithObjects: (id)marker, endMarker, nil];\r\n        AXValueRef range = ValueForParameterizedAttribute(CFSTR(\"AXTextMarkerRangeForUnorderedTextMarkers\"), (CFTypeRef)markersArray, elt);\r\n        if( !range )\r\n            goto webkitFail;\r\n        \r\n        NSString *endString = (id)ValueForParameterizedAttribute(CFSTR(\"AXStringForTextMarkerRange\"), range, elt);\r\n        if( !endString || ![endString isKindOfClass: [NSString class]] )\r\n            goto webkitFail;\r\n        \r\n        AXValueRef startMarker = ValueForParameterizedAttribute(CFSTR(\"AXPreviousSentenceStartTextMarkerForTextMarker\"), marker, elt);\r\n        if( !startMarker )\r\n            goto webkitFail;\r\n        \r\n        markersArray = [NSArray arrayWithObjects: (id)startMarker, endMarker, nil];\r\n        range = ValueForParameterizedAttribute(CFSTR(\"AXTextMarkerRangeForUnorderedTextMarkers\"), (CFTypeRef)markersArray, elt);\r\n        if( !range )\r\n            goto webkitFail;\r\n        \r\n        NSString *fullString = (id)ValueForParameterizedAttribute(CFSTR(\"AXStringForTextMarkerRange\"), range, elt);\r\n        if( !fullString || ![fullString isKindOfClass: [NSString class]] )\r\n            goto webkitFail;\r\n        \r\n        NSLog(@\"%@\", fullString);\r\n        \r\n    webkitFail:\r\n        ;\r\n        \r\n        sleep(1);\r\n    }\r\n}\r\n\r\nint main(int argc, char **argv)\r\n{\r\n    [NSAutoreleasePool new];\r\n    \r\n    NSApplicationLoad();\r\n    Test();\r\n}\r\n\r\nIt will attempt to use AXTextMarkerForPosition to print the text under the mouse cursor. First, test it with an app that uses the original WebKit, such as Adium, Colloquy, NetNewsWire, Safari 5 or below, etc. Next, test it with Safari 5.1.\r\n\r\nExpected Results:\r\nThe test app should print the text under the mouse cursor at all times.\r\n\r\nActual Results:\r\nIn Safari 5.1, it usually prints the text located at the top left corner of the current view. For example, I visited http://www.apple.com/mac/ in Safari 5.1 and ran this test program. As I scrolled down the page, the program continued to print whatever text was at that corner, ignoring my mouse position.\r\n\r\nRegression:\r\nThis is new in Safari 5.1. It fails on both Lion and Snow Leopard.\r\n\r\nNotes:\r\nWhile AXTextMarkerForPosition is private API, it's the only way that I know of to extract the text at a specific point in Safari. Additionally, on Snow Leopard, the built-in dictionary lookup shortcut (cmd-control-d) uses this attribute, and consequently it no longer works in Safari 5.1.\r\n\r\nIf there is a better way to get the text at a specific point in Safari, I would love to hear it!"
    email: michael.ash@gmail.com
    modified: "2011-08-28T05:35:03.502715Z"
    number: "9911657"
    number_intvalue: 9911657
    originated: 07-Aug-2011 05:28 PM
    parent_number: '&{NULL_VALUE}'
    product: Safari
    product_version: "5.1"
    reproducible: Always
    resolved: ""
    status: Open
    title: AXTextMarkerForPosition broken in Safari 5.1
