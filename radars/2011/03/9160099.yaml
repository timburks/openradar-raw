apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "9160099"
    labels:
        datastore_id: "1138407"
data:
    classification: Serious Bug
    created: "2011-03-20T20:17:14.195473Z"
    description: "20-Mar-2011 12:37 PM Joel Bruner:\r\nFinder Inherited ACL Duplication\r\n\r\nSummary:\r\nACLs are redundantly duplicated in copy operations via Finder (but not cp -p in Terminal)\r\n\r\nSteps to Reproduce:\r\nOn a fresh server install, nothing special, just AFP service running... \r\n1. Create a folder and make it an AFP share point (turn off Spotlight indexing for one less ACL in the mix)\r\n2. Add a user to the folder ACL (a local, OD, or AD, doesn't matter), in this test case, Admin (501), the defaults permissions are fine (Read Only, Inheritance on)\r\n3. Save and apply rights to folder\r\n4. Create a test document  in TextEdit (on the server to eliminate OS X Client from the ACL equation) and save to folder created in step 1, you could also just touch a new filename too.\r\n5. Duplicate the file in Finder, duplicate the duplicate, etc...\r\n6. Examine the folder with ls -le, the original file will have no ACL, the duplicate will have ACLs applied, duplicates will start to have ACLs repeating/duplicating and \"stacking up\"\r\n7. When the ACLs gets long enough (esp. on an app) Finder will crash when copying\r\n\r\nExpected Results:\r\nACL methods are aware of an existing duplicate ACEs and do not append new ACEs to the ACL\r\n\r\nActual Results:\r\nACLs are duplicated and appended until Finder is unable to work with the file (Copy, get Info) without crashing\r\n\r\nRegression:\r\n10.6, 10.6.2, bug not present, results were consistent and as expected. \r\nExample permissions from the test file when duplicated in 10.6 or 10.6.2:\r\n0: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n\r\n10.6.3 (and into 10.6.4) introduced the behavior of adding a Write ACE to the duplication of a file that only had a Read ACE on it, example output:\r\n\r\n1st duplication (of file with no ACL):\r\n0: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n\r\n2nd copy (of file above):\r\n0: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n1: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n\r\n3rd, 4th copy, etcâ€¦ did not duplicate past these two ACEs, why write rights were included is a mystery, it's as if the compliment from the Unix permissions were added because administrator is doing the copying on this file? Bizarre. \r\n\r\nAlso Finder starts listing _3_ ACEs on a file that ls -le only lists with _2_, Finder saying this ghost ACE is \"Custom\".\r\n\r\n10.6.5 introduced a new level of duplication, now not only was an errant Write ACE being added to a Read only ACE, but now those entries were being duplicated as well.\r\nExample:\r\n-rw-r--r--@ 1 administrator  admin  4 Mar 18 17:19 test copy 2.txt\r\n 0: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 1: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 2: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n\r\n-rw-r--r--@ 1 administrator  admin  4 Mar 18 17:19 test copy 3.txt\r\n 0: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 1: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 2: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 3: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 4: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n\r\n-rw-r--r--@ 1 administrator  admin  4 Mar 18 17:19 test copy 4.txt\r\n 0: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 1: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 2: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 3: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 4: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 5: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 6: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n\r\n10.6.6 continued this behavior, which becomes fatal for Finder when copying/duplicating packages and Applicaion bundles in a folder with and ACL, Finder will become overwhelmed with the length of the ACL by the 3rd copy and fail, resulting in a truncated application or package and error -41. See the movie called \"10.6.6 ACL Chess.app.mov\", even one duplication in a folder with one ACL results in a file in the Chess.app have 12 ACEs!\r\n\r\n10.6.6 does not address or change the duplication behavior introduced in 10.6.5, or the errant addition of Write rights to what should be a Read ACE introduced in 10.6.3\r\n\r\nWhen \"cp -p\" is used to copy the errant ACEs are purged and properly reflect the ACL of the parent folder. Seems to be Finder's problem.\r\n\r\n21-Mar-2011 11:47 AM Joel Bruner:\r\nFurther regression testing notes, AFP need not be involved, and client will behave the same as well when inheritance is turned on  (file_inherit,directory_inherit), just make the folder, apply an ACL with chmod, and Finder will duplicate ACEs without proper checking and duplicates will occur to the point of Finder error -41 on applications and packages.\r\n\r\nWhile this bug affects both client and server, only server makes it easily possible by turning inheritance on by default when using the Server Admin AFP panel, whereas Finder does not turn on inheritance in it's ACLs that are added by Finder\r\n\r\nCreate a new folder in the root (to avoid any other possible ACL permissions, permission interactions), logged in as administrator (501) - you can also be logged in as anyone else who has write permissions to the folder.\r\n\r\nApply the folder ACLs (the same that server Server Manager would apply with inheritance on) using chmod:\r\n1. mkdir ~/chmodACLTest\r\n2. chmod +a \"administrator allow list,search,readattr,readextattr,readsecurity,file_inherit,directory_inherit\"  ~/chmodACLTest\r\n3. Copy an application like Chess.app into the folder with Finder, duplicate/copy and recopy the copy, the 3rd duplicate will fail with Error -41 because ACLs are stacking up.\r\n# for a simple file experiment\r\n4. touch ~/chmodACLTest/test \r\n5. Go to Finder and duplicate the test file and its duplicates.\r\nInspect permissions in Finder and in addition to Read, the erroneous Write ACE is labeled Custom in Finder.\r\n\r\nInspect with Terminal:\r\n\r\n$ ls -led ~/chmodACLTest\r\ndrwxr-xr-x+ 6 administrator  admin  204 Mar 21 10:29 chmodACLTest\r\n 0: user:administrator allow list,search,readattr,readextattr,readsecurity,file_inherit,directory_inherit\r\n 1: user:_spotlight inherited allow list,search,file_inherit,directory_inherit\r\n\r\n$ ls -le\r\ntotal 0\r\n-rw-r--r--+ 1 administrator  admin  0 Mar 21 10:28 test\r\n 0: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n-rw-r--r--+ 1 administrator  admin  0 Mar 21 10:28 test copy\r\n 0: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 1: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 2: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n-rw-r--r--+ 1 administrator  admin  0 Mar 21 10:28 test copy 2\r\n 0: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 1: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 2: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 3: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 4: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n-rw-r--r--+ 1 administrator  admin  0 Mar 21 10:28 test copy 3\r\n 0: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 1: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 2: user:administrator inherited allow write,delete,append,writeattr,writeextattr,chown\r\n 3: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 4: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 5: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 6: user:administrator inherited allow read,execute,readattr,readextattr,readsecurity\r\n 7: user:_spotlight inherited allow read,execute\r\n\r\nNotes on Admin's ACL being Read Only vs. Unix permissions:\r\nYou can also give admin write permissions in the ACL and the same behavior will occur, while it seems like a poor example to have the same user duplicating the file having Read Only in the ACL, it should and is possible, because the Unix permissions allow this, what the example highlights is that a Write ACE is inexplicably written when that is not supposed to be inherited from the parent folder."
    email: brunerd@gmail.com
    modified: "2011-08-28T05:37:27.92157Z"
    number: "9160099"
    number_intvalue: 9160099
    originated: 20-Mar-2011 12:37 PM
    parent_number: "8729952"
    product: OS X
    product_version: 10.6.7/10J869
    reproducible: Always
    resolved: ""
    status: Duplicate/8729952
    title: 'Finder: Inherited ACL Duplication'
