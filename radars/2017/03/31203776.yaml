apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "31203776"
    labels:
        datastore_id: "4984460223184896"
data:
    classification: ""
    created: "2017-03-22T21:06:16.08493Z"
    description: "Summary:\r\nUsing Apple Configurator 2 I have created IKEv2 cert based VPN connection.\r\n\r\nOn connecting to pfSense (Strongswan) VPN server it can be logged that macOS never proposes Phase 2 as it is set in mobileconfig.\r\n\r\nThe main point here is that for\r\nPhase 1 (IKE SA) DH group is set as DH20 (ECP_384)\r\nPhase 2 (Child SA) DH group is set as DH20 (ECP_384)\r\nBoth on server and client.\r\n\r\nNote that logs are \"newest on top\". IP addresses are in private range as the testing is sandboxed.\r\n\r\nOn connection the Strongswan/charon logs for phase 1 are\r\n\r\n---------------\r\nselected proposal: IKE:AES_CBC_256/HMAC_SHA2_384_192/PRF_HMAC_SHA2_384/ECP_384\r\nconfigured proposals: IKE:AES_CBC_256/HMAC_SHA2_384_192/PRF_HMAC_SHA2_384/ECP_384\r\nreceived proposals: IKE:AES_CBC_256/HMAC_SHA2_384_192/PRF_HMAC_SHA2_384/ECP_384 \r\n---------------\r\n\r\nwhere one can see that macOS proposes ECP_384 and proposal matches.\r\n\r\nOn connection the Strongswan/charon logs for phase 2 are\r\n\r\n---------------\r\nconfigured proposals: ESP:AES_CBC_256/HMAC_SHA2_256_128/ECP_384/NO_EXT_SEQ    \r\nreceived proposals: ESP:AES_CBC_256/HMAC_SHA2_256_128/NO_EXT_SEQ    \r\n---------------\r\n\r\nthus one can see that proposal by macOS lacks ECP_384 (DH group 20).\r\n\r\nHowever one can connect as \"The first IKEv2 \"Phase 2\" is derived from the initial IKE negotiation. The other values are not used until Rekey.\" https://wiki.strongswan.org/projects/strongswan/wiki/ExpiryRekey#IPsec\r\n\r\nIn result on first rekey the connection just fails miserably, because ECP_384 still lacks in proposal\r\n\r\n---------------\r\nreceived DELETE for IKE_SA con1[12]    \r\nparsed INFORMATIONAL request 11 [ D ]    \r\nreceived packet: from 192.168.10.146[4500] to 192.168.10.100[4500] (88 bytes)    \r\nsending packet: from 192.168.10.100[4500] to 192.168.10.146[4500] (88 bytes)    \r\ngenerating CREATE_CHILD_SA response 10 [ N(NO_PROP) ]    \r\nfailed to establish CHILD_SA, keeping IKE_SA    \r\nno acceptable proposal found    \r\nconfigured proposals: ESP:AES_CBC_256/HMAC_SHA2_256_128/ECP_384/NO_EXT_SEQ    \r\nreceived proposals: ESP:AES_CBC_256/HMAC_SHA2_256_128/NO_EXT_SEQ    \r\nno acceptable DIFFIE_HELLMAN_GROUP found    \r\nselecting proposal:    \r\n---------------\r\n\r\nI tried also DH14 and DH2 for Phase 2, they are also not included in the proposal to the server.\r\n\r\nThe DH group exists in .mobileconfig file ChildSecurityAssociationParameters dict\r\n\r\n---------------\r\n<key>ChildSecurityAssociationParameters</key>\r\n<dict>\r\n  <key>DiffieHellmanGroup</key>\r\n  <integer>20</integer>\r\n  <key>EncryptionAlgorithm</key>\r\n  <string>AES-256</string>\r\n  <key>IntegrityAlgorithm</key>\r\n  <string>SHA2-256</string>\r\n  <key>LifeTimeInMinutes</key>\r\n  <integer>60</integer>\r\n</dict>\r\n<key>IKESecurityAssociationParameters</key>\r\n<dict>\r\n  <key>DiffieHellmanGroup</key>\r\n  <integer>20</integer>\r\n  <key>EncryptionAlgorithm</key>\r\n  <string>AES-256</string>\r\n  <key>IntegrityAlgorithm</key>\r\n  <string>SHA2-384</string>\r\n  <key>LifeTimeInMinutes</key>\r\n  <integer>480</integer>\r\n</dict>\r\n---------------\r\n\r\nCurrent way to make macOS work with Strongswan is to disable DH group in Strongswan Phase 2, leave whatever DH group in Apple Configurator for Child SA as it will not be sent anyways. This results in phase 2 matching in rekeying\r\n\r\n---------------\r\nselected proposal: ESP:AES_CBC_256/HMAC_SHA2_256_128/NO_EXT_SEQ\r\nconfigured proposals: ESP:AES_CBC_256/HMAC_SHA2_256_128/NO_EXT_SEQ\r\nreceived proposals: ESP:AES_CBC_256/HMAC_SHA2_256_128/NO_EXT_SEQ\r\n---------------\r\n\r\nand connection is kept.\r\n\r\nIn year 2017 VPN is everyday reality.\r\nFirstly this is security issue compromising phase 2 security gateway.\r\nSecondly VPN is unusable as it drops connections.\r\n\r\nI have to mention that this issue also affects iOS, the logs and everything is exactly the same after installing this profile on iPhone. I will be crossposting this in iOS bugreports, for which I apologize. \r\n/ranting\r\nOr maybe not as being mac poweruser and part-time-developer myself for veeery long time I have seen the trend of how fast you address longstanding macOS vs iOS bugs. Note that Apple in year 2016 added support for DH14 https://support.apple.com/en-us/HT206154 while it was minimum recommended group years ago.\r\n\r\nSteps to Reproduce:\r\nInstall Apple Configurator 2\r\nConfigure certificate based IKEv2 VPN profile with any(!) Phase 2 DH Group (20/14/2).\r\n\r\nExpected Results:\r\nDH group configured in phase 2 should be sent to the server as proposal.\r\n\r\nActual Results:\r\nDH group configured in phase 2 is not sent to the server as proposal.\r\n\r\nVersion:\r\nmacOS 10.12.4 Beta (16E191a)\r\nApple Configurator 2.3 (3D68)\r\niOS 10.2.1 on iPhone SE\r\n\r\nNotes:\r\nMy longer debugging findings related to this issue can be found here\r\nhttps://forum.pfsense.org/index.php?topic=127696.0\r\n\r\nConfiguration:\r\n\r\n\r\nAttachments:"
    email: reinis.adovics@gmail.com
    modified: "2017-03-22T21:06:16.08516Z"
    number: "31203776"
    number_intvalue: 31203776
    originated: 22-03-2017
    parent_number: '&{NULL_VALUE}'
    product: Other
    product_version: ""
    reproducible: ""
    resolved: ""
    status: Open
    title: macOS built in IKEv2 VPN is not passing Child SA DH group proposal
