apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "34372201"
    labels:
        datastore_id: "4941025453801472"
data:
    classification: Crash/Hang/Data Loss
    created: "2017-09-11T18:40:50.61688Z"
    description: "Summary:\r\nWe noticed that one of our test cases, which is stress-testing document loading, occasionally triggers a crash in filecoordinationd, leading to failed coordinated reads. This appears to be due to an issue with KVO observing in filecoordinationd. When the issue occurs, we get an error on our side and also a system crash report for filecoordinationd.\r\n\r\nSteps to Reproduce:\r\nOur tests simply loads a lot of documents from our test pool in parallel using our PSPDFKit framework. The document is a file presenter and uses file coordination for reading.\n\n- (void)testLoadAllDocuments {\n    let allPDFAssets = [self PDFAssets];\n\n    dispatch_apply(allPDFAssets.count, self.defaultDispatchQueue, ^(size_t index) {\n        NSURL *url = allPDFAssets[index];\n        let document = [PSPDFDocument documentWithContent:url];\n        const BOOL isValid = document.isValid;\n  \n        if ([self isPathSupposedToBeValid:path]) {\n            XCTAssertTrue(isValid, \"File with path should be valid: %@\", path);\n        } else {\n            XCTAssertFalse(isValid);\n        }\n    });\n}\n\nOur tests run on various iOS simulators. The failures only occur on the iOS 11 tests. \r\n\r\nExpected Results:\r\nThe test should pass without issues. That is the current behavior on iOS 9 and iOS 10. \r\n\r\nActual Results:\r\nThe test occasionally fails with the following style of error on our side:\n\n2017-09-10 21:31:22.386588-0700 PSPDFKit-TestHost-iOS[85299:30681418] [claims] F2C6B0EB-EDAA-49C0-8DB6-7E061116FB68 grantAccessClaim message failed: Error Domain=NSCocoaErrorDomain Code=4097 \"connection to service named com.apple.FileCoordination\" UserInfo={NSDebugDescription=connection to service named com.apple.FileCoordination}\n2017-09-10 21:31:22.386789-0700 PSPDFKit-TestHost-iOS[85299:30681418] A process invoked one of the -[NSFileCoordinator coordinate...] methods but filecoordinationd crashed. Returning an error.\n2017-09-10 21:31:22.386852-0700 PSPDFKit-TestHost-iOS[85299:30681131] [PSPDFKit] [ Warn] -[PSPDFCoordinatedFileDataProvider performCoordinatedReading:options:error:]/121 Coordinated data provider read from file:///Volumes/CI/ci/Library/Developer/CoreSimulator/Devices/38BFE303-5225-4514-AC12-8C501F090CB7/data/Containers/Bundle/Application/FBF8A480-913A-4F6A-82F1-5B693F27F217/PSPDFKit-TestHost-iOS.app/assets/Testcase_JPG2000_Assert.pdf failed : Error Domain=NSCocoaErrorDomain Code=256 \"The file â€œTestcase_JPG2000_Assert.pdfâ€� couldnâ€™t be opened.\" UserInfo={NSURL=file:///Volumes/CI/ci/Library/Developer/CoreSimulator/Devices/38BFE303-5225-4514-AC12-8C501F090CB7/data/Containers/Bundle/Application/FBF8A480-913A-4F6A-82F1-5B693F27F217/PSPDFKit-TestHost-iOS.app/assets/Testcase_JPG2000_Assert.pdf}.\n\nThe crash occurs at different times during the test without a noticeable pattern. The crash also logs the following in the device (simulator) console:\n\nSep 11 14:35:19 SpaceBook com.apple.CoreSimulator.SimDevice.BB417EBE-D1E9-48C2-A550-C01DBC00B3CF[10730] (com.apple.FileCoordination[10987]): Service exited due to signal: Segmentation fault: 11 sent by exc handler[0]\nSep 11 14:45:23 SpaceBook com.apple.CoreSimulator.SimDevice.BB417EBE-D1E9-48C2-A550-C01DBC00B3CF[10730] (com.apple.FileCoordination[17405]): Service exited due to signal: Segmentation fault: 11 sent by exc handler[0]\n\nThere are also crash reports generated. \r\n\r\nVersion:\r\niOS 11, Xcode 9.0 beta 6 (9M214v)\r\n\r\nNotes:\r\nI’m attaching several crash reports and some output from the following command: sudo log stream --system --info --debug --predicate \"subsystem contains 'filecoordination'\"\n\nA representative stack trace contains:\n\n____NSOQOpFinished_block_invoke + 198\n+[__NSOperationInternal _observeValueForKeyPath:ofObject:changeKind:oldValue:newValue:indexes:context:] + 1777\nNSKeyValueNotifyObserver + 116\nNSKeyValueDidChange + 483\nNSKeyValueDidChangeWithPerThreadPendingNotifications + 129\n-[NSFileAccessProcessManager allowSuspension] + 182\n-[NSFileAccessClaim devalueSelf] + 65\n-[NSFileReadingClaim devalueSelf] + 153\n-[NSFileAccessClaim revoked] + 573\n-[NSFileAccessArbiter _revokeAccessClaimForID:fromLocal:] + 100\n__NSXPCCONNECTION_IS_CALLING_OUT_TO_EXPORTED_OBJECT_S1__ + 12\n-[NSXPCConnection _decodeAndInvokeMessageWithEvent:flags:] + 2706"
    email: matej@bukovinski.com
    modified: "2017-09-11T18:40:50.61718Z"
    number: "34372201"
    number_intvalue: 34372201
    originated: 11-Sep-2017 08:40 PM
    parent_number: '&{NULL_VALUE}'
    product: iOS + SDK
    product_version: iOS 11, Xcode 9.0 beta 6 (9M214v)
    reproducible: Sometimes
    resolved: ""
    status: Open
    title: filecoordinationd crashes while processing KVO
