apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "29984128"
    labels:
        datastore_id: "5604940256903168"
data:
    classification: Serious Bug
    created: "2017-01-12T04:43:39.89741Z"
    description: "#### Product\r\nDeveloper Tools\r\n\r\n#### Classification\r\nSerious Bug\r\n\r\n#### Reproducibility\r\nAlways\r\n\r\n#### Title\r\nXcode Automatic Provisioning resolves App Groups entitlement incorrectly\r\n\r\n#### Description\r\nXcode Automatic Provisioning (or 'Automatically manage signing' as it it shown in the Xcode UI) will automatically configure App Group Assignment for the App ID in the Developer Portal. You can see the App IDs it manages in the Developer Portal (Certificates, Identifiers & Profiles; Identifiers; App IDs) prefixed with 'XC'. You can edit the App Groups to see the assignment on the Developer Portal.\r\n\r\nWhen a Target uses different Bundle Identifiers for different Build Configurations, by changing the Build Setting PRODUCT_BUNDLE_IDENTIFIER, Xode will update the App IDs on the Developer Portal for each Build Configuration. Which Configurations are updated seems to depend on the active Scheme.\r\n\r\nWhen a Target uses the App Groups entitlement Xcode will update the App ID's App Group Assignment on the Developer Portal.\r\n\r\nIf a Target uses different Bundle Identifiers and different App Groups for different Build Configurations, Xcode does not update the App Group Assignment correctly. One App Group will be set for all active Build Configurations. Building with a Scheme that uses different Build Configurations will change all App ID App Group Assignments again, but to the value appropriate for that Configuration.\r\n\r\nThis means, when using Automatic Provisioning for Targets with different Bundle Identifiers and App Group entitlements, Xcode will update/repair the App IDs, and thus the Provisioning Profiles, to all have one set of App Group Assignments.\r\nSometimes Xcode will not attempt to repair the App ID, and simply fail the build due to missing the correct entitlements.\r\n\r\n#### Steps to reproduce\r\n\r\nDEVELOPMENT_TEAM, PRODUCT_BUNDLE_IDENTIFIER, and the App Groups may need to be adjusted to your Development Team.\r\n\r\n1. You can skip configuration steps if you open the project in the attached zip file.\r\n2. Create an Xcode project with an iOS App target\r\n3. Append the PRODUCT_BUNDLE_IDENTIFIER Build Setting with \"-$(CONFIGURATION)\", this will give different values for Debug and Release configurations. (AutomaticApp in the sample project)\r\n4. Enable Automatic Provisioning and set your Development Team for the target.\r\n5. Notice Xcode resolving the Provisioning Profiles correctly\r\n6. Add the App Groups capability to the app target, this will create an entitlements file.\r\n7. Edit the entitlements file to expand the CONFIGURATION build setting to have a different App Group per Configuration. For example use the string \"group.net.Ashton-W.AppGroupTest-$(CONFIGURATION).AppGroup\" in the entitlements file. (AutomaticAppWithExpandedAppGroup in the sample project)\r\n8. Build the app for Debug, eg: Run in Simulator.\r\n9. Then build the app for Release: eg: Archive for Generic iOS Device.\r\n10. Notice the App Groups assigned to the App IDs in the Developer Portal (Go to 'Certificates, Identifiers & Profiles'. Then go to 'App IDs' under the 'Identifiers' group in the navigation menu. Select the App IDs matching the bundle IDs we are using in this project, then press the edit button. Press the Edit button next to the App Groups entitlement.)\r\n11. Repeat Step 8 and 10, then Step 9 and 10.\r\n12. Revert the changes in step #7\r\n13. Make a copy of the entitlements file and change the CODE_SIGN_ENTITLEMENTS build setting to use the new file for the Release configuration.\r\n14. Edit the entitlements files so the App Groups used are different, for example: \"group.net.Ashton-W.AppGroupTest-Debug.AppGroup\" in the original file and \"group.net.Ashton-W.AppGroupTest-Release.AppGroup\" in the new file. (AutomaticAppWithGroup in the sample project)\r\n15. Build the app for Debug, eg: Run in Simulator.\r\n16. Then build the app for Release: eg: Archive for Generic iOS Device.\r\n17. Notice the App Groups assigned to the App IDs in the Developer Portal (...)\r\n18. Repeat Step 15 and 17, then Step 16 and 17.\r\n\r\n#### Expected Results\r\nXcode Automatic Provisioning uses the correct entitlements for the Debug build and the Release build.\r\nThe App IDs on the Developer Portal have the same App Group entitlements as configured as when Xcode builds.\r\n\r\n#### Actual Results\r\nXcode Automatic Provisioning updates the Release build App ID with the App Groups entitlements from the Debug build.\r\nThe App IDs on the Developer Portal do not always have the same App Group entitlements as when Xcode builds.\r\n\r\n#### Configuration\r\nIf you do not have Internet Access or Xcode does not try to update or repair the Provisioning Profiles, the build will fail with missing entitlements if it had previously set the App Groups incorrectly.\r\n\r\nManually assigning the App Groups on the Developer Portal and installing the Provisioning Profiles will work until Xcode updates or repairs the Provisioning Profiles, at which point the assignment will be incorrect for one or more App IDs.\r\n\r\n#### Xcode Version/Build & OSX Version/Build\r\nXcode 8.2.1 (8C1002)\r\n\r\n#### Additional Notes\r\n\r\nThe attached sample project contains three targets:\r\n\r\n**AutomaticApp**   \r\nApp using Automatic Provisioning (aka 'Automatically manage provisioning' in Xcode)\r\nThis app uses different `PRODUCT_BUNDLE_IDENTIFIER` per Build Configuration.\r\nThis works well.\r\n\r\n**AutomaticAppWithGroup**   \r\nAn App using Automatic Provisioning (aka 'Automatically manage provisioning' in Xcode)\r\nand the App Groups entitlement.\r\nDifferent `PRODUCT_BUNDLE_IDENTIFIER` per Build Configuration.\r\nDifferent `CODE_SIGN_ENTITLEMENTS` per Build Configuration to change which `.entitlements` file used to build.\r\nXcode will use the entitlements to configure the App Groups for the iOS App ID (in the Developer Portal). However, it will incorrectly configure the App Groups for the current Configuration to the iOS App IDs of all other Configurations too.\r\n\r\nThis is not desired or expected.\r\n\r\n**AutomaticAppWithExpandedAppGroup**   \r\nAn App using Automatic Provisioning (aka 'Automatically manage provisioning' in Xcode)\r\nand the App Groups entitlement.\r\nDifferent `PRODUCT_BUNDLE_IDENTIFIER` per Build Configuration.\r\nAlternatively, using Build Setting expansion inside the `.entitlements` file will show that `$(CONFIGURATION)` does get expanded, but the entitlements from the wrong Configuration are used.\r\n\r\nSample project can be found here https://github.com/Ashton-W/Radars/tree/master/29984128%20-%20Xcode%20Automatic%20Provisioning%20resolves%20App%20Groups%20entitlement%20incorrectly"
    email: ashton.john.williams@gmail.com
    modified: "2017-01-29T07:06:52.65765Z"
    number: "29984128"
    number_intvalue: 29984128
    originated: 12-Jan-2017
    parent_number: '&{NULL_VALUE}'
    product: Developer Tools
    product_version: Xcode 8.2.1 (8C1002)
    reproducible: Always
    resolved: ""
    status: Duplicate of 27728329 (Open)
    title: Xcode Automatic Provisioning resolves App Groups entitlement incorrectly
