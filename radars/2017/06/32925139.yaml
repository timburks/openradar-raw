apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "32925139"
    labels:
        datastore_id: "6055356497133568"
data:
    classification: Serious Bug
    created: "2017-06-22T16:10:40.59149Z"
    description: "Area:\r\nNetworking\r\n\r\nSummary:\r\nThe Google Chrome team has a distributed compilation environment. It’s internal-only, but it’s conceptually similar to distcc.\r\n\r\nOn the macOS 10.13 betas (both beta 1 and beta 2 so far), when I attempt to use this service to build Chrome, all networking stops about 2/3 of the way into the build.\r\n\r\nThe immediately apparent symptom is that the build stops progressing. I can stop the build, but by then, the damage is done in that networking remains unusable. I can’t pass any traffic over the network when this happens. If I run “ifconfig”, it hangs partway through dumping the “p2p0” interface. If I click on the AirPort menu extra, nothing happens and a beach ball eventually appears over the menu extra. If I try to open the Network preference pane in System Preferences, nothing populates.\r\n\r\nRunning “top -ocpu”, I see kernel_task at 100%, indicating that something’s spinning in a tight look in the kernel.\r\n\r\n^C and SIGKILL do not recover the hung ifconfigs. It is impossible to shut the system down cleanly either via the Apple menu:Restart or via “sudo shutdown -r now”.\r\n\r\nSteps to Reproduce:\r\nI can’t provide solid reproduction steps because I’ve only been able to reproduce the problem using our internal distributed build service. This service functions similarly to distcc and does not run anything at elevated privileges.\r\n\r\nEssentially, it’s:\r\n\r\n% git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git\r\n[also get goma, our distributed compilation tool, and start it]\r\n% PATH=\"${PATH}:$(pwd)/depot_tools:$(pwd)/goma_mac\"\r\n% mkdir chrome\r\n% cd chrome\r\n% fetch chrome\r\n[wait]\r\n% cd chrome\r\n% gn gen out/debug --args=\"use_goma=true goma_dir=\\\"$(pwd)/goma_mac\\\"\"\r\n% ninja -C out/debug chrome -j250\r\n\r\nExpected Results:\r\nThe build should complete successfully.\r\n\r\nObserved Results:\r\nAfter building 21,000 or so files out of 29,000 or so, the build stops progressing. You’ll notice that networking is not working. Browsers can’t browse, ping shows no connectivity, etc. The AirPort menu extra and Networking preference pane don’t work. kernel_task is using 100% CPU. Run “ifconfig” and it’ll hang irrecoverably part of the way through dumping the p2p0 interface. I’m including a snippet of that here because the sysdiagnose probably missed it since ifconfig never completed.\r\n\r\nlitterbox@litterbox zsh% ifconfig\r\nlo0: flags=8049<UP,LOOPBACK,RUNNING,MULTICAST> mtu 16384\r\n\toptions=1203<RXCSUM,TXCSUM,TXSTATUS,SW_TIMESTAMP>\r\n\tinet 127.0.0.1 netmask 0xff000000 \r\n\tinet6 ::1 prefixlen 128 \r\n\tinet6 fe80::1%lo0 prefixlen 64 scopeid 0x1 \r\n\tnd6 options=201<PERFORMNUD,DAD>\r\ngif0: flags=8010<POINTOPOINT,MULTICAST> mtu 1280\r\nstf0: flags=0<> mtu 1280\r\nXHC20: flags=0<> mtu 0\r\nXHC0: flags=0<> mtu 0\r\nXHC1: flags=0<> mtu 0\r\nen0: flags=8863<UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST> mtu 1500\r\n\tether uu:vv:ww:xx:yy:zz \r\n\tinet6 blahblahblah%en0 prefixlen 64 secured scopeid 0x7 \r\n\tinet6 blahblahblah prefixlen 64 autoconf secured \r\n\tinet6 blahblahblah prefixlen 64 autoconf temporary \r\n\tnd6 options=201<PERFORMNUD,DAD>\r\n\tmedia: autoselect\r\n\tstatus: active\r\nen1: flags=963<UP,BROADCAST,SMART,RUNNING,PROMISC,SIMPLEX> mtu 1500\r\n\toptions=60<TSO4,TSO6>\r\n\tether uu:vv:ww:xx:yy:zz \r\n\tmedia: autoselect <full-duplex>\r\n\tstatus: inactive\r\nen3: flags=963<UP,BROADCAST,SMART,RUNNING,PROMISC,SIMPLEX> mtu 1500\r\n\toptions=60<TSO4,TSO6>\r\n\tether uu:vv:ww:xx:yy:zz \r\n\tmedia: autoselect <full-duplex>\r\n\tstatus: inactive\r\nen2: flags=963<UP,BROADCAST,SMART,RUNNING,PROMISC,SIMPLEX> mtu 1500\r\n\toptions=60<TSO4,TSO6>\r\n\tether uu:vv:ww:xx:yy:zz \r\n\tmedia: autoselect <full-duplex>\r\n\tstatus: inactive\r\nen4: flags=963<UP,BROADCAST,SMART,RUNNING,PROMISC,SIMPLEX> mtu 1500\r\n\toptions=60<TSO4,TSO6>\r\n\tether uu:vv:ww:xx:yy:zz \r\n\tmedia: autoselect <full-duplex>\r\n\tstatus: inactive\r\np2p0: flags=8843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST> mtu 2304\r\n\tether uu:vv:ww:xx:yy:zz \r\n\r\nNormally, ifconfig should have continued by printing p2p0’s status line, and several other interfaces. After a fresh reboot, those look like\r\n\r\n\tstatus: inactive\r\nawdl0: flags=8943<UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST> mtu 1484\r\n\tether uu:vv:ww:xx:yy:zz \r\n\tinet6 blahblahblah%awdl0 prefixlen 64 scopeid 0xf \r\n\tnd6 options=201<PERFORMNUD,DAD>\r\n\tmedia: autoselect\r\n\tstatus: active\r\nipsec0: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 4096\r\n\toptions=6403<RXCSUM,TXCSUM,CHANNEL_IO,PARTIAL_CSUM,ZEROINVERT_CSUM>\r\nipsec1: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 4096\r\n\toptions=6403<RXCSUM,TXCSUM,CHANNEL_IO,PARTIAL_CSUM,ZEROINVERT_CSUM>\r\nutun0: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 2000\r\n\toptions=6403<RXCSUM,TXCSUM,CHANNEL_IO,PARTIAL_CSUM,ZEROINVERT_CSUM>\r\n\tinet6 blahblahblah%utun0 prefixlen 64 scopeid 0x12 \r\n\tnd6 options=201<PERFORMNUD,DAD>\r\n\r\nVersion:\r\n10.13db2 17A291j with Xcode 9b2 9M137d.\r\n\r\nI experienced this with 10.13db1 17A264c and Xcode 9b1 9M136h too.\r\n\r\nI see this problem when I’m building on an APFS or HFS+ filesystem.\r\n\r\nThe system is a MacBook Pro (15-inch, 2016) (MacBookPro13,3).\r\n\r\nConfiguration:\r\nWe never had any trouble up to and including 10.12.5 16F73."
    email: mark@chromium.org
    modified: "2017-08-01T20:48:06.75271Z"
    number: "32925139"
    number_intvalue: 32925139
    originated: "2017-06-22"
    parent_number: '&{NULL_VALUE}'
    product: macOS + SDK
    product_version: 10.13db2 17A291j
    reproducible: Always
    resolved: "2017-08-01"
    status: Closed
    title: After much heavy network activity, all networking stops, kernel_task spins at 100%, ifconfig and AirPort menu extra hang
