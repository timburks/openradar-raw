apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "30408641"
    labels:
        datastore_id: "6149444600856576"
data:
    classification: ""
    created: "2017-02-17T19:38:15.7451Z"
    description: "Summary:\r\nIn Finder, user can drag&drop files or folders to move them from one location to another, when both source and destination are within the same volume, or mount point. When they are in different mount points, moving by drag&drop is also possible, with Cmd being held. This is great and has been internalized by the majority of Mac users.\r\n\r\nInternally on a unix system, moving is typically done by the rename() system call. The rename() call can only handle the move within the same filesystem. If source and destination locations are on different volumes, rename() would fail. The unix standard (http://pubs.opengroup.org/onlinepubs/009695399/functions/rename.html) defines an error code, EXDEV, specifically for this case. The error code allows userspace program to tell \"moving across device\" from other errors, thus handle differently. The \"mv\" command, for example, would copy the file or directory over to destination, and remove the old one, in case of an EXDEV from rename().\r\n\r\nFinder, however, doesn't seem to respect this error code. Instead of doing a copy-then-remove, Finder just shows an error (incorrectly) saying the file can't be read or written. This normally is not an issue since Finder \"sees\" different volumes, and knows which locations are on different mounts, which allows it to use different approaches for move. However, on a network drive, this can become an issue and prevent the user from moving stuff using drag&drop. More specifically, if the the network drive's mount has a subdirectory that is a mount point by itself, moving files into or out of that subdirectory using rename() can cause file server to return an EXDEV error. Finder then thinks the file is not readable/writable.\r\n\r\nFWIW, the FileManager.moveItem() method in Foundation framework (https://developer.apple.com/reference/foundation/filemanager/1413529-moveitem) works fine in the scenario described above.\r\n\r\nWe ran into this issue on a product we are working on here at Keybase. But we also managed to reproduce it using NFS, which is a supported feature in Finder. Having mount point(s) inside NFS might seem like an edge case, but considering that NFS is commonly used for storing large amount of data, it's not uncommon for file servers to have to have multiple disks mounted to support one NFS root export. This suggests the bug described here is very likely to happen for NFS users.\r\n\r\nSteps to reproduce are listed below, using a Linux NFS server and Finder's \"Connect to Server\".\r\n\r\nSteps to Reproduce:\r\n0. Find out your own UID on macOS (with \"id\" command in CLI). I, being first user created on my mac, have 501. This is needed because by making the UID same on files served by NFS, it's easier to manage permissions. The script below needs the UID.\r\n1. Spin up a fresh Ubuntu 16.04 Linux instance. The ubuntu/xenial64 box from Vagrant (https://www.vagrantup.com/) works. Make sure macOS is able to access the Linux instance. If you use Vagrant, uncomment the line `config.vm.network \"public_network\"` makes it on a bridged network.\r\n2. On Linux, install nfs server: sudo apt-get update && sudo apt-get install -y nfs-kernel-server\r\n3. Reboot Linux, so that kernel module is loaded.\r\n4. In Linux, download and run this script (https://gist.github.com/songgao/cb3de68571367b13934a3cd0c48d37de) to configure the NFS server with root: wget https://gist.githubusercontent.com/songgao/cb3de68571367b13934a3cd0c48d37de/raw/027217b33cfd51fe95fb5420f161cdfc57d2ecce/nfs.sh -O nfs.sh && chmod a+x nfs.sh && sudo ./nfs.sh\r\n5. If command in 4 finishes successfully, in macOS try mounting it in Finder using \"Connect to Server\", and use this address: nfs://<Linux instance IP address>/var/nfs/general/\r\n6. In macOS, in Finder's NFS mount, you'd see a directory called submnt. Create a new folder outside it (i.e. in the mount root), and try dragging it into \"submnt\" directory. Finder would show the error attached now.\r\n\r\nExpected Results:\r\nMoving by drag&drop in Finder within same NFS mount works seamlessly.\r\n\r\nActual Results:\r\nIt errors; please see screenshot.\r\n\r\nVersion:\r\nmacOS version 10.12.3 (16D32)\r\nFinder version 10.12.3"
    email: song@keyba.se
    modified: "2017-02-17T19:40:30.52875Z"
    number: "30408641"
    number_intvalue: 30408641
    originated: 2/7/2017
    parent_number: '&{NULL_VALUE}'
    product: macOS+SDK/Finder.app
    product_version: 10.12.3
    reproducible: Always
    resolved: No
    status: Open
    title: Finder.app doesn't respond to EXDEV properly, breaking some NFS use cases
