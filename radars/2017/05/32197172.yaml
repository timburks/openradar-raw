apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "32197172"
    labels:
        datastore_id: "4939248041984000"
data:
    classification: Enhancement
    created: "2017-05-16T15:23:06.51525Z"
    description: "Summary:\r\nIf an iOS project is missing the `Copy Files` build phase to copy dynamic frameworks to the proper `Frameworks` directory inside the application bundle, the app will crash on Device but it would work fine in Simulator.\r\n\r\nA further inspection on the dyld API usage point that the Simulator is loading the libraries from the build directory, which should not do.\r\n\r\niOS Simulator build products directory contents:\r\n\r\n$ ls\r\nFrameworkA.framework  XING.app\r\n$ ls XING.app/\r\nBase.lproj  Info.plist  PkgInfo   XING    _CodeSignature\r\n\r\nThere is no Frameworks directory.\r\n\r\nExecutable inspection:\r\n\r\n$ otool -L XING.app/XING \r\nXING.app/XING:\r\n  @rpath/FrameworkA.framework/FrameworkA (compatibility version 1.0.0, current version 1.0.0)\r\n  /System/Library/Frameworks/Foundation.framework/Foundation (compatibility version 300.0.0, current version 1349.54.0)\r\n  /usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)\r\n  /usr/lib/libSystem.dylib (compatibility version 1.0.0, current version 1238.50.2)\r\n  /System/Library/Frameworks/UIKit.framework/UIKit (compatibility version 1.0.0, current version 3600.7.47)\r\n$ otool -l XING.app/XING | grep RPATH -n7\r\n397-          cmd LC_LOAD_DYLIB\r\n398-      cmdsize 80\r\n399-         name /System/Library/Frameworks/UIKit.framework/UIKit (offset 24)\r\n400-   time stamp 2 Thu Jan  1 01:00:02 1970\r\n401-      current version 3600.7.47\r\n402-compatibility version 1.0.0\r\n403-Load command 17\r\n404:          cmd LC_RPATH\r\n405-      cmdsize 40\r\n406-         path @executable_path/Frameworks (offset 12)\r\n407-Load command 18\r\n408-      cmd LC_FUNCTION_STARTS\r\n409-  cmdsize 16\r\n410-  dataoff 17296\r\n411- datasize 16\r\n\r\nLC_RPATH is correctly set to Frameworks directory and used to load the framework.\r\n\r\nLog from dyld API usage:\r\n\r\ndyld: loaded: /Users/renzo.crisostomo/Library/Developer/Xcode/DerivedData/XING-bbsprjwhtcxfzzfivnkfqioxxlsh/Build/Products/Debug-iphonesimulator/FrameworkA.framework/FrameworkA\r\n\r\nFramework is loaded from the build directory. This should not happen.\r\n\r\nRunning the project on Device, it will crash with the following:\r\n\r\ndyld: Library not loaded: @rpath/FrameworkA.framework/FrameworkA\r\n  Referenced from: /var/containers/Bundle/Application/EE4AAE10-2A0D-4C48-A8DC-A7933F999D15/XING.app/XING\r\n  Reason: image not found\r\n\r\nThe .app contents are the same as in the Simulator build:\r\n\r\n$ ls\r\nFrameworkA.framework  XING.app\r\n$ ls XING.app/\r\nBase.lproj      PkgInfo       _CodeSignature\r\nInfo.plist      XING        embedded.mobileprovision\r\n$ otool -L XING.app/XING \r\nXING.app/XING:\r\n  @rpath/FrameworkA.framework/FrameworkA (compatibility version 1.0.0, current version 1.0.0)\r\n  /System/Library/Frameworks/Foundation.framework/Foundation (compatibility version 300.0.0, current version 1349.54.0)\r\n  /usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)\r\n  /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1238.50.2)\r\n  /System/Library/Frameworks/UIKit.framework/UIKit (compatibility version 1.0.0, current version 3600.7.47)\r\n\r\nnb-rcrisostomo:Debug-iphoneos renzo.crisostomo$ otool -l XING.app/XING | grep RPATH -n7\r\n392-          cmd LC_LOAD_DYLIB\r\n393-      cmdsize 80\r\n394-         name /System/Library/Frameworks/UIKit.framework/UIKit (offset 24)\r\n395-   time stamp 2 Thu Jan  1 01:00:02 1970\r\n396-      current version 3600.7.47\r\n397-compatibility version 1.0.0\r\n398-Load command 18\r\n399:          cmd LC_RPATH\r\n400-      cmdsize 40\r\n401-         path @executable_path/Frameworks (offset 12)\r\n402-Load command 19\r\n403-      cmd LC_FUNCTION_STARTS\r\n404-  cmdsize 16\r\n405-  dataoff 5007\r\n\r\nAfter property adding the missing `Copy Files` build phase to copy dynamic frameworks to the proper `Frameworks` directory, the application doesn't crash anymore, but nothing really changes in the dyld API usage, the only difference is that the Framework is in the proper directory:\r\n\r\n$ ls XING.app/Frameworks/\r\nFrameworkA.framework\r\n\r\nSteps to Reproduce:\r\nUsing the latest version of Xcode (8.3.2 at the time of writing)\r\n\r\n1. `git checkout HEAD^`\r\n2. Open XING.xcworkspace\r\n3. Select Device\r\n4. Run\r\n5. Crash: dyld: Library not loaded\r\n\r\nThe latest commit in the repository adds the missing build phase and fixes the problem.\r\n\r\nExpected Results:\r\nSimulator should stop loading dynamic libraries from build directory. This is not really helpful and it's a bit confusing. I would expect to get the same dyld crash in both cases, Simulator and Device.\r\n\r\nActual Results:\r\nSimulator loads dynamic libraries from build directory, hiding build settings problems that are only reproducible when running the project using a device.\r\n\r\nVersion:\r\nXcode 8 (8.3.2)\r\n\r\nNotes:\r\n\r\n\r\nConfiguration:\r\nXcode 8.3.2, macOS Sierra 10.12.4\r\n\r\nAttachments:\r\n'XING.zip' was successfully uploaded."
    email: ruenzuo@gmail.com
    modified: "2017-05-16T15:23:06.51544Z"
    number: "32197172"
    number_intvalue: 32197172
    originated: Open
    parent_number: '&{NULL_VALUE}'
    product: Developer Tools
    product_version: Xcode 8 (8.3.2)
    reproducible: Always
    resolved: ""
    status: Open
    title: Simulator should stop loading dynamic libraries from build directory
