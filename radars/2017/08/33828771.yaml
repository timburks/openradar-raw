apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "33828771"
    labels:
        datastore_id: "5510031747317760"
data:
    classification: ReplayKit
    created: "2017-08-10T16:14:25.4951Z"
    description: "Area:\r\nReplayKit\r\n\r\nSummary:\r\nIf you do end up shipping iOS 11 where the com.apple.broadcast-services-setupui extension is _not_ used for global screen recordings with 3rd-party upload extensions, then this bug report merely suggests that there doesn't seem to be a way for a broadcast upload extension to determine video orientation on its own. That orientation information (whether it's video orientation or device orientation) should be made available somewhere.\r\n\r\nDetails:\r\nI am able to receive sample buffers in my broadcast upload extension (NSExtensionPointIdentifier: com.apple.broadcast-services-upload). The video sample buffers appear to be aligned to the camera sensor. For three of the four device orientations, I need to rotate the display of the video frame to show it correctly.\r\n\r\nI know how to apply this kind of rotation to a video file or a video broadcast. My problem is determining what the rotation should be. The sample buffer itself doesn't appear to provide details about orientation or a preferred transform. The complicating factor is that queries to both UIDevice and UIScreen _from within a broadcast upload extension_ appear to lack correct device orientation as well. Both of them either report device orientation to be unknown or they incorrectly report the device to be unrotated.\r\n\r\nI am guessing that the the broadcast setup UI (NSExtensionPointIdentifier: com.apple.broadcast-services-setupui) will solve this problem. It's a view controller that can resolve orientation. You already provide a way for a setupui extension to send this kind of data as setupInfo to an upload extension.\r\n\r\nHowever, as of beta 5, the setupui extension is not used when initiating a global screen recording from the Screen Recording button. (I'm hoping that will be fixed before iOS 11 is released.)\r\n\r\nSteps to Reproduce:\r\n- Run the attached VideoOrientationTest project to install the VideoOrientationTest app and associated \"Broadcast\" extension on an iOS 11 device.\r\n- Leave your device attached to Xcode on your Mac.\r\n- Install the Screen Recording button into your Control Center if it's not already installed.\r\n- Bring up the Control Center.\r\n- 3D touch the Screen Recording button.\r\n- Choose the \"Broadcast\" extension.\r\n- Tap \"Start Broadcast\". Wait for the count down and let the recording continue running.\r\n\r\n- In Xcode, set a breakpoint the processSampleBuffer() call in SampleHandler.swift (line 35).\r\n- In Xcode select Debug -> Attach to Process.\r\n- Wait for the process list to resolve.\r\n- Select Broadcast at the top of the list.\r\n- Wait for the break point to trap.\r\n\r\nExpected Results:\r\nAt the breakpoint, in that call stack, in that process, there should be a way to query or determine which way the video sampleBuffer is oriented.\r\n\r\nLot's of possible solutions. (You guys would know better than me.) Some possibilities:\r\n\r\n- Run the setupui extension before running a 3rd-party broadcast upload extension for a global Screen Recording. Give the setupui extension the opportunity to send device orientation to the upload extension.\r\n- Or, add orientation to the setupInfo of the broadcastStarted() call to the upload extension.\r\n- Or, embed the orientation somewhere into each video sample buffer.\r\n- Or, get UIDevice or UIScreen capable of communicating correct device orientation into a broadcast upload extension.\r\n\r\nObserved Results:\r\nAt the breakpoint, in that call stack, in that process, there doesn't appear to be a way to query or determine which way the video sampleBuffer is oriented.\r\n\r\nVersion:\r\n- iOS 11 beta 5 (15A5341f)\r\n- Xcode 9 beta 5 (9M202q)\r\n\r\nNotes:\r\nThe SampleHandler can determine the size and aspect ratio of a video sample buffer but that doesn't tell us which way the content inside the video frame is oriented.\r\n\r\nWithout a rotation, three of the four device orientations will render content incorrectly. It's not clear how code inside a SampleHandler could query or determine what that rotation should be.\r\n\r\nConfiguration:\r\nThis has been the case for all the iOS 11 betas so far (up to and including beta 5)."
    email: o.schnurr@techsmith.com
    modified: "2017-09-06T17:34:11.299Z"
    number: "33828771"
    number_intvalue: 33828771
    originated: 8/10/2017
    parent_number: '&{NULL_VALUE}'
    product: iOS
    product_version: iOS 11 beta 5 (15A5341f)
    reproducible: always
    resolved: no
    status: duplicate
    title: 'ReplayKit, Broadcast Upload Extension: Determining Orientation of Video Buffers'
