apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "29328986"
    labels:
        datastore_id: "6739064287920128"
data:
    classification: Crash
    created: "2017-07-21T19:40:00.10019Z"
    description: "Area:\r\nUIKit\r\n\r\nSummary:\r\nIf you perform updates on a UICollectionView in one iteration of run loop in the following order:\r\n1. Batch updates.\r\n2. Reload and layout.\r\n3. Batch updates.\r\n\r\nSteps to Reproduce:\r\nSee the attached project.\r\nRun its unit tests to reproduce the issue.\r\n\r\nExpected Results:\r\nThe collection view updates its contents correctly without any crashes.\r\n\r\nActual Results:\r\nYou get crash with the following error message:\r\n2016-11-18 11:40:09.411 CollectionViewUpdateCrash[56136:10665323] *** Assertion failure in -[UICollectionViewData indexPathForItemAtGlobalIndex:], /BuildRoot/Library/Caches/com.apple.xbs/Sources/UIKit_Sim/UIKit-3600.5.2/UICollectionViewData.m:652\r\n/Users/n.morev/Developer/Playground/CollectionViewUpdateCrash/CollectionViewUpdateCrashTests/CollectionViewUpdateCrashTests.m:87: error: -[CollectionViewUpdateCrashTests testConsecutiveUpdatesFollowedByReloads] : failed: caught \"NSInternalInconsistencyException\", \"request for index path for global index 9223372036854775806 when there are only 1 items in the collection view\"\r\n(\r\n\t0   CoreFoundation                      0x000000010364334b __exceptionPreprocess + 171\r\n\t1   libobjc.A.dylib                     0x00000001011f121e objc_exception_throw + 48\r\n\t2   CoreFoundation                      0x0000000103647442 +[NSException raise:format:arguments:] + 98\r\n\t3   Foundation                          0x0000000100d87e4d -[NSAssertionHandler handleFailureInMethod:object:file:lineNumber:description:] + 195\r\n\t4   UIKit                               0x0000000102068851 -[UICollectionViewData indexPathForItemAtGlobalIndex:] + 294\r\n\t5   UIKit                               0x0000000102069051 -[UICollectionViewData layoutAttributesForGlobalItemIndex:] + 30\r\n\t6   UIKit                               0x000000010201f928 -[UICollectionView _viewAnimationsForCurrentUpdate] + 8094\r\n\t7   UIKit                               0x00000001020247e1 __71-[UICollectionView _updateWithItems:tentativelyForReordering:animator:]_block_invoke.1983 + 197\r\n\t8   UIKit                               0x00000001017796e6 +[UIView(Animation) performWithoutAnimation:] + 90\r\n\t9   UIKit                               0x0000000102023337 -[UICollectionView _updateWithItems:tentativelyForReordering:animator:] + 3942\r\n\t10  UIKit                               0x000000010201d369 -[UICollectionView _endItemAnimationsWithInvalidationContext:tentativelyForReordering:animator:] + 17765\r\n\t11  UIKit                               0x0000000102025dba -[UICollectionView _endUpdatesWithInvalidationContext:tentativelyForReordering:animator:] + 71\r\n\t12  UIKit                               0x00000001020260fc -[UICollectionView _performBatchUpdates:completion:invalidationContext:tentativelyForReordering:animator:] + 432\r\n\t13  UIKit                               0x0000000102025f29 -[UICollectionView _performBatchUpdates:completion:invalidationContext:tentativelyForReordering:] + 91\r\n\t14  UIKit                               0x0000000102025eab -[UICollectionView _performBatchUpdates:completion:invalidationContext:] + 74\r\n\t15  UIKit                               0x0000000102025e00 -[UICollectionView performBatchUpdates:completion:] + 53\r\n\t16  CollectionViewUpdateCrashTests      0x000000010d484443 -[CollectionViewUpdateCrashTests testConsecutiveUpdatesFollowedByReloads] + 3923\r\n\t17  CoreFoundation                      0x00000001035ca05c __invoking___ + 140\r\n\t18  CoreFoundation                      0x00000001035c9ee1 -[NSInvocation invoke] + 289\r\n\t19  XCTest                              0x000000010d0b1f77 __24-[XCTestCase invokeTest]_block_invoke_2 + 481\r\n\t20  XCTest                              0x000000010d0ea7df -[XCTestContext performInScope:] + 190\r\n\t21  XCTest                              0x000000010d0b1d83 -[XCTestCase invokeTest] + 255\r\n\t22  XCTest                              0x000000010d0b259c -[XCTestCase performTest:] + 457\r\n\t23  XCTest                              0x000000010d0af664 -[XCTestSuite performTest:] + 491\r\n\t24  XCTest                              0x000000010d0af664 -[XCTestSuite performTest:] + 491\r\n\t25  XCTest                              0x000000010d0af664 -[XCTestSuite performTest:] + 491\r\n\t26  XCTest                              0x000000010d09b618 __25-[XCTestDriver _runSuite]_block_invoke + 51\r\n\t27  XCTest                              0x000000010d0bcd2b -[XCTestObservationCenter _observeTestExecutionForBlock:] + 602\r\n\t28  XCTest                              0x000000010d09b4b5 -[XCTestDriver _runSuite] + 436\r\n\t29  XCTest                              0x000000010d09c302 -[XCTestDriver _checkForTestManager] + 287\r\n\t30  XCTest                              0x000000010d0ebd67 _XCTestMain + 628\r\n\t31  CoreFoundation                      0x00000001035e825c __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__ + 12\r\n\t32  CoreFoundation                      0x00000001035cd304 __CFRunLoopDoBlocks + 356\r\n\t33  CoreFoundation                      0x00000001035cca75 __CFRunLoopRun + 901\r\n\t34  CoreFoundation                      0x00000001035cc494 CFRunLoopRunSpecific + 420\r\n\t35  GraphicsServices                    0x00000001054e8a6f GSEventRunModal + 161\r\n\t36  UIKit                               0x00000001016c0964 UIApplicationMain + 159\r\n\t37  CollectionViewUpdateCrash           0x0000000100c21bff main + 111\r\n\t38  libdyld.dylib                       0x000000010456668d start + 1\r\n\t39  ???                                 0x0000000000000005 0x0 + 5\r\n)\r\n\r\nThe error message is confusing because nowhere I refer to number 9223372036854775806 (or -1).\r\n\r\nVersion:\r\nVersion 8.1 (8B62)\r\n\r\nNotes:\r\n\r\n\r\nConfiguration:\r\niOS 10.1 Simulator"
    email: n.morev@corp.mail.ru
    modified: "2017-07-21T19:40:00.10047Z"
    number: "29328986"
    number_intvalue: 29328986
    originated: November 18 2016, 11:49 AM
    parent_number: '&{NULL_VALUE}'
    product: UIKit
    product_version: iOS 10.1
    reproducible: Always
    resolved: ""
    status: CLOSED DUPLICATE OF 28496311 CLOSED
    title: UICollectionView crash with confusing message after batch updates and reload
