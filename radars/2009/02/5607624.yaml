apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "5607624"
    labels:
        datastore_id: "3409"
data:
    classification: Other Bug
    created: "2009-02-11T15:22:07.25923Z"
    description: "Summary:\r\n\r\n/usr/libexec/InternetSharing sets bootpd's reply_threshold_seconds to a nonzero value. (Much more detail on this in the Notes section.) This effectively means that some devices, most prominently the Microsoft Xbox 360, will never obtain an IP address from an OS X machine that is acting as a DHCP server using Internet Sharing. Setting reply_threshold_seconds to 0 solves the problem (but is overridden whenever Internet Sharing is on).\r\n\r\n\r\nSteps to Reproduce:\r\n\r\n1) Enable Internet Sharing in System Preferences. For example, share a connection from AirPort to computers using Ethernet.\r\n2) Connect an Xbox 360 using Ethernet and set it to obtain an IP address using DHCP.\r\n\r\n\r\nExpected Results:\r\n\r\nThe Mac's DHCP server replies to the Xbox 360's DHCPDISCOVER messages, and the Xbox is able to obtain an IP address and connect to the Internet through the Mac.\r\n\r\n\r\nActual Results:\r\n\r\nbootpd never replies to the Xbox.\r\n\r\n\r\nRegression:\r\n\r\nThe problem is confirmed under 10.4.10 and 10.5.1. I have not had a chance to test under 10.4.11 but I assume it happens there as well.\r\n\r\n\r\nNotes:\r\n\r\nThe core problem is that /usr/libexec/InternetSharing, which is the daemon that is launched whenever Internet Sharing is enabled and which then launches bootpd, is apparently hard-coded to set bootpd's reply_threshold_seconds value to 4. Under Leopard, this setting exists in /etc/bootpd.plist, while under Tiger it is found in the local NetInfo domain at /config/dhcp. It seems that /usr/libexec/InternetSharing writes to the plist (Leopard) or NetInfo (Tiger) immediately before launching bootpd, every time it launches bootpd, which makes it impossible for the user to override this behavior (e.g., by changing the value in the plist or NetInfo and then killing bootpd).\r\n\r\nSetting reply_threshold_seconds to 4 means that bootpd will ignore DHCPDISCOVER messages whose \"secs\" field, as described in RFC 2131, Table 1, is less than 4. Unfortunately, some devices, including the Xbox 360 with the current firmware as of 11/18/2007, always set this field to 0 in their DHCPDISCOVER messages. (I have heard that this problem exists with the original Xbox too, as well as some other, less popular devices.) This appears to be allowed by the RFC (see p. 36), but it means that bootpd ignores all such devices and never gives them an IP address.\r\n\r\nSince reply_threshold_seconds need not be set for bootpd to run, and it will use 0 if no value is set, I assume that this behavior is deliberate and that it exists to reduce the number of problems caused by users enabling Internet Sharing on LANs where there is already a DHCP server. Note, however, that the DHCP server that Windows XP SP2 runs when its Internet sharing is turned on doesn't exhibit the same behavior (it works with the Xbox 360).\r\n\r\nMy preference would be that the default setting be changed to 0, but if this is deemed undesirable then I would like there to be some kind of hidden, or not-so-hidden, setting to override it. I've looked everywhere I can think of and have finally been forced to conclude that no such setting currently exists and this value of 4 must be hard-coded. (The source of /usr/libexec/InternetSharing doesn't appear to be available to the public.) If it were instead configurable in /Library/Preferences/SystemConfiguration/com.apple.nat.plist, as some other advanced Internet Sharing settings already are, knowledgeable users like me could at least override it on their machines. Even better would be an \"Advanced...\" button in the Sharing pane of System Preferences that led to a dialog that allowed the user to, for example, check a box to eliminate the reply threshold (set it to 0).\r\n\r\nI copied the bootpd.plist that Internet Sharing creates, disabled Internet Sharing, modified the plist to set the reply threshold to 0 and then ran bootpd manually. The Xbox 360 was then able to obtain an IP address from the Mac as desired. I have attached debugging output from bootpd in the before and after cases."
    email: onitake@gmail.com
    modified: "2011-08-28T05:50:48.821324Z"
    number: "5607624"
    number_intvalue: 5607624
    originated: 18-Nov-2007
    parent_number: '&{NULL_VALUE}'
    product: Mac OS X
    product_version: ""
    reproducible: Always
    resolved: ""
    status: ""
    title: Internet Sharing incompatible with e.g. Xbox 360, due to DHCP reply threshold
