apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "6829785"
    labels:
        datastore_id: "36404"
data:
    classification: ""
    created: "2009-04-27T16:52:38.683027Z"
    description: "27-Apr-2009 05:47 PM:\r\nSummary:\r\n\r\nInitially machines were running 10.5.4. I have tried upgrading to 10.5.6, but we still see the same issue.\r\n\r\nConfigure a machine to use autofs executable mount maps as follows:\r\n\r\nEdit /etc/auto_master\r\n\r\n#\r\n# Automounter master map\r\n#\r\n#+auto_master\t\t# Use directory service\r\n#/net\t\t\t-hosts\t\t-nobrowse,nosuid\r\n/home\t\t\tauto_home\t-nobrowse\r\n/Network/Servers\t-fstab\r\n#/-\t\t\t-static\r\n/automount/nfs\t\t-hosts\t\t-nobrowse,nosuid\r\n/automount/net\t\t/etc/auto_exec_net\r\n/automount/job\t\t/etc/auto_exec_job\r\n\r\nWe have older machines using mounts.byname, hence we had to comment out the +auto_master line along with /-\r\n\r\nWe would normally mount in / but this didn't work properly in Leopard and as such had to mount in a subdirectory.  This is a bug in its own right, which I believe you are already aware of.\r\n\r\n/etc/auto_exec_net contains:\r\n\r\n#!/bin/sh\r\n\r\nif [ $# -eq 0 ]; then # List keys\r\n\typcat -k auto.net.mac | awk '{print $1}'\r\n\texit\r\nfi\r\n\r\n# Return the individual mount\r\nypmatch $1 auto.net.mac\r\n\r\n\r\n\r\nWith /etc/auto_exec_job looking exactly the same, with net replaced with job.\r\n\r\nWith have scripts that are looking at /net and /job and as such it means that our mounts need to appear as if they are actually located in these locations.  Therefore, we have symlinks.  /net symlinks to /automount/net and similar for job and nfs.\r\n\r\nExample lines from our auto.net.mac mount file:\r\n\r\ntraining -proto=tcp ps1:/mnt/raid1/training\r\nrd17 -proto=tcp ss1a:/mnt/raid1/peach_project/peach_rd17\r\n\r\n\r\n\r\nAt some point in time, a machine will start to panic.  I have attached a couple of examples of the Panic Reports.  Once a machine starts to do this, it appears to become gradually more frequent.  An example of a couple of mahcines Panic Reports related to autofs\r\n\r\n2009-02-26-104056.panic:         com.apple.filesystems.autofs(2.0.1)@0x972000->0x97cfff\r\n2009-03-11-171246.panic:         com.apple.filesystems.autofs(2.0.1)@0x972000->0x97cfff\r\n2009-03-13-093549.panic:         com.apple.filesystems.autofs(2.0.1)@0x71e6c000->0x71e76fff\r\n2009-03-20-231359.panic:         com.apple.filesystems.autofs(2.0.1)@0x972000->0x97cfff\r\n2009-03-25-100950.panic:         com.apple.filesystems.autofs(2.0.1)@0x972000->0x97cfff\r\n2009-03-26-114416.panic:         com.apple.filesystems.autofs(2.0.1)@0x972000->0x97cfff\r\n\r\n2009-02-16-094717.panic:         com.apple.filesystems.autofs(2.0.1)@0x962000->0x96cfff\r\n2009-02-20-095712.panic:         com.apple.filesystems.autofs(2.0.1)@0x962000->0x96cfff\r\n2009-03-17-095325.panic:         com.apple.filesystems.autofs(2.0.1)@0x97f000->0x989fff\r\n2009-03-23-100112.panic:         com.apple.filesystems.autofs(2.0.1)@0x975000->0x97ffff\r\n2009-03-24-141123.panic:         com.apple.filesystems.autofs(2.0.1)@0x975000->0x97ffff\r\n2009-03-25-142809.panic:         com.apple.filesystems.autofs(2.0.1)@0x95c000->0x966fff\r\n\r\nThe machines that were demonstrating this issue where then reconfigured to use mounts.byname instead.\r\n\r\n/etc/auto_master file re-edited back to:\r\n\r\n#\r\n# Automounter master map\r\n#\r\n+auto_master\t\t# Use directory service\r\n# /net\t\t\t-hosts\t\t-nobrowse,nosuid\r\n/automount/nfs\t\t-hosts\t\t-nobrowse,nosuid\r\n/home\t\t\tauto_home\t-nobrowse\r\n/Network/Servers\t-fstab\r\n/-\t\t\t-static\r\n\r\n/etc/auto_exec_net and /etc/auto_exec_job were removed.\r\n\r\nMachines that were demonstrating the autofs crashes that were moved back to mounts.byname no longer panic, but instead now demonstrate a new issue.\r\n\r\nThe automounter feels the need to re-run at what appears to be every so often, a duration which is possibly the duration set in the autofs.conf file (default 3600).  Below is a section of the system.log file, demonstrating the frequency of the automount re-run, on a machine that had the autofs.conf file configured as:\r\nAUTOMOUNT_TIMEOUT=7200\r\n\r\nApr 27 01:25:09 mac99 com.apple.autofsd[50]: automount: no unmounts\r\nApr 27 03:27:18 mac99 com.apple.autofsd[50]: automount: no unmounts\r\nApr 27 05:29:21 mac99 com.apple.autofsd[50]: automount: no unmounts\r\nApr 27 07:31:25 mac99 com.apple.autofsd[50]: automount: no unmounts\r\nApr 27 10:29:28 mac99 com.apple.autofsd[50]: automount: no unmounts\r\nApr 27 11:18:06 localhost com.apple.autofsd[49]: automount: no unmounts\r\nApr 27 11:18:18 mac99 com.apple.autofsd[49]: automount: no unmounts\r\nApr 27 11:18:32 mac99 com.apple.autofsd[49]: automount: no unmounts\r\nApr 27 12:12:53 mac99 com.apple.autofsd[49]: automount: no unmounts\r\nApr 27 14:14:07 mac99 com.apple.autofsd[49]: automount: no unmounts\r\nApr 27 14:14:08 mac99 com.apple.autofsd[49]: automount: no unmounts\r\n\r\nGenerally speaking this is every 2 hours, but not always!  Machine rebooted at 11:18.  Sometimes as noted on the last 2 lines, the automount will re-run twice\r\n\r\nThese re-runs aren't an issue on machines that have only ever used mounts.byname and only appear to be an issue with machines that were configured to autofs, panic'd and then re-configured for mounts.byname\r\n\r\nWhilst this re-run takes place, the machine becomes unusable   This re-run may take as long as 15-20 mins.  In some instances, the re-run has been continually stuck in a loop and hence the machine is continually unusable.\r\n\r\nExpected\r\n\r\nWhen using autofs, no panic would be expected.  Any automount should only appear once.\r\n\r\nActual Result\r\n\r\nUsing a 'df' command, you may see the following:\r\n\r\n/dev/disk0s2                                 244198584     41792120   201894464    18%    /\r\ndevfs                                              211          211           0   100%    /dev\r\nfdesc                                                2            2           0   100%    /dev\r\nmap -hosts                                           0            0           0   100%    /automount/nfs\r\nmap /etc/auto_exec_net                               0            0           0   100%    /automount/net\r\nmap /etc/auto_exec_job                               0            0           0   100%    /automount/job\r\n/dev/disk0s3                                 243264616    230406768    12857848    95%    /Volumes/scratch\r\n/dev/disk1s2                                 487725344    474350944    13374400    98%    /Volumes/images1\r\nhomes:/mnt/homes/accounts                   8178622464   3435513176  4743109288    43%    /automount/net/homes\r\nps27:/mnt/raid1/pop_project/pop            19039731712   7759358544 11280373168    41%    /automount/job/pop\r\nps27:/mnt/raid1/pop_project/pop            19039731712   7759358544 11280373168    41%    /automount/job/pop\r\nss3a:/mnt/raid1/sherlock_project/sherlock  13667274752   8355348864  5311925888    62%    /automount/job/sherlock\r\nss3a:/mnt/raid1/sherlock_project/sherlock  13667274752   8355348864  5311925888    62%    /automount/job/sherlock\r\nss3a:/mnt/raid1/sherlock_project/sherlock  13667274752   8355348864  5311925888    62%    /automount/job/sherlock\r\nps16:/mnt/raid1/art_reference              20487012352  13906452552  6580559800    68%    /automount/net/artref\r\nss1a:/mnt/raid1/peach_project/peach        13667274752  10697009152  2970265600    79%    /automount/job/peach\r\nlust1d:/mnt/delta                         204299740672 187609631616 14580449536    93%    /automount/net/delta\r\n\r\nFrom this you can see that the mount for pop appears twice whilst the mount for sherlock appears 3 times.\r\n\r\nOn a machine that has been reconfigured for mounts.byname we see a similar issue.  As this is so big, I have included it in a file, mounts.byname_df\r\n\r\nWe still have some machines that as of yet haven't started to kernel panic that are configured for autofs, but the machines were configured at different points in time and it is a while for the panics start.  I would suggest that it may only be a matter of time before these machines start acting the same.\r\n\r\nAlthough re-configuring back to mounts.byname removes the panics, we are instead left with machines that become unusable for some period of time, neither of which is ideal.\r\n\r\nMy only option appears to be to re-image the machine, back to an image that was never configured for autofs.\r\n\r\nWe really need to be using autofs, not only due to its nature of only mounting servers that have been accessed, but as we need to use variables in our mount points, which mounts.byname doesn't recognise.\r\n\r\nWe have hundreds of Linux machines that are configured as described for autofs which work without any issues.  I'd really like to be able to say the same about our Apple machines!!!"
    email: seansgm@gmail.com
    modified: "2011-08-28T05:46:59.325376Z"
    number: "6829785"
    number_intvalue: 6829785
    originated: 27-Apr-2009
    parent_number: '&{NULL_VALUE}'
    product: Mac OSX
    product_version: 10.5.6
    reproducible: Sometimes
    resolved: NO
    status: Closed
    title: autofs causing panics
