apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: FB9741207
    labels:
        datastore_id: "4988388042080256"
data:
    classification: ""
    created: "2021-11-05T08:42:06.243544Z"
    description: "We work on a SDK and our users report unfrequent crashes (on iOS15, 15.1 and 15.2) in the code that can be simplified to:\r\n\r\n```\r\nobserver = NotificationCenter.default\r\n    .addObserver(\r\n        forName: .NSProcessInfoPowerStateDidChange,\r\n        object: nil,\r\n        queue: .main\r\n    ) { notification in\r\n        guard let processInfo = notification.object as? ProcessInfo else {\r\n            return\r\n        }\r\n        \r\n        let lmpe = processInfo.isLowPowerModeEnabled // CRASH on _os_unfair_lock_recursive_abort in libsystem_platform.dylib\r\n\r\n        print(lmpe)\r\n    }\r\n```\r\n\r\nIn some circumstances, getting `.isLowPowerModeEnabled` from `ProcessInfo` **within the `. NSProcessInfoPowerStateDidChange` notification callback** causes a dead lock in `libsystem_platform.dylib` and leads to `_os_unfair_lock_recursive_abort` crash.\r\n\r\nUnfortunately, I didn’t succeed in reproducing this issue locally and capturing Apple’s crash report, so I can only rely on backtraces reported by our users (below). Some of them include `WebCore` symbols, which could be a potential external factor causing this crash. I also found this recent change to Low Power Mode management in WebKit (dated Dec 2020), but I’m not sure if this is relevant: https://trac.webkit.org/changeset/270406/webkit.\r\n\r\n```\r\nCrashed: com.apple.main-thread\r\n0  libsystem_platform.dylib       0x60c0 _os_unfair_lock_recursive_abort + 36\r\n1  libsystem_platform.dylib       0xa10 _os_unfair_lock_lock_slow + 304\r\n2  Foundation                     0x29730 -[NSProcessInfo(NSProcessInfoHardwareState) isLowPowerModeEnabled] + 68\r\n3  Datadog                        0x2a680 closure #1 in LowPowerModeMonitor.init(initialProcessInfo:notificationCenter:) + 140 (MobileDevice.swift:140)\r\n4  Datadog                        0x2a720 thunk for @escaping @callee_guaranteed (@in_guaranteed Notification) -> () + 4339345184 (<compiler-generated>:4339345184)\r\n5  Foundation                     0x355b0 -[__NSObserver _doit:] + 348\r\n6  CoreFoundation                 0x2aee8 __CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ + 28\r\n7  CoreFoundation                 0xc6b9c ___CFXRegistrationPost_block_invoke + 52\r\n8  CoreFoundation                 0x99f54 _CFXRegistrationPost + 456\r\n9  CoreFoundation                 0x40d54 _CFXNotificationPost + 716\r\n10 Foundation                     0x1b028 -[NSNotificationCenter postNotificationName:object:userInfo:] + 96\r\n11 Foundation                     0x939d4 NSProcessInfoNotifyPowerState + 188\r\n12 Foundation                     0x29768 -[NSProcessInfo(NSProcessInfoHardwareState) isLowPowerModeEnabled] + 124\r\n13 WebCore                        0x9118 <redacted> + 96\r\n14 WebCore                        0xa8516c WebCore::LowPowerModeNotifier::LowPowerModeNotifier(WTF::Function<void (bool)>&&) + 52\r\n15 WebCore                        0x19aac4c WebCore::Page::Page(WebCore::PageConfiguration&&) + 1848\r\n16 WebKitLegacy                   0x3e34 -[WebView(WebPrivate) _commonInitializationWithFrameName:groupName:] + 3060\r\n17 WebKitLegacy                   0x3214 -[WebView(WebPrivate) _initWithFrame:frameName:groupName:] + 116\r\n18 UIFoundation                   0xdd028 -[NSHTMLReader _loadUsingWebKit] + 832\r\n19 Foundation                     0x3de0c __NSThreadPerformPerform + 232\r\n20 CoreFoundation                 0xbb030 __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 28\r\n21 CoreFoundation                 0xcbcf0 __CFRunLoopDoSource0 + 208\r\n22 CoreFoundation                 0x5ff8 __CFRunLoopDoSources0 + 268\r\n23 CoreFoundation                 0xb804 __CFRunLoopRun + 820\r\n24 CoreFoundation                 0x1f3c8 CFRunLoopRunSpecific + 600\r\n25 GraphicsServices               0x138c GSEventRunModal + 164\r\n26 UIKitCore                      0x51b060 -[UIApplication _run] + 1100\r\n27 UIKitCore                      0x298b8c UIApplicationMain + 2124\r\n```\r\n\r\n```\r\nCrashed: com.apple.main-thread\r\n0  libsystem_platform.dylib       0x8e4c _os_unfair_lock_recursive_abort + 36\r\n1  libsystem_platform.dylib       0x17e4 _os_unfair_lock_lock_slow + 324\r\n2  Foundation                     0x27b08 -[NSProcessInfo(NSProcessInfoHardwareState) isLowPowerModeEnabled] + 64\r\n3  Datadog                        0x2a680 closure #1 in LowPowerModeMonitor.init(initialProcessInfo:notificationCenter:) + 140 (MobileDevice.swift:140)\r\n4  Datadog                        0x2a720 thunk for @escaping @callee_guaranteed (@in_guaranteed Notification) -> () + 4374603552 (<compiler-generated>:4374603552)\r\n5  Foundation                     0x335f8 -[__NSObserver _doit:] + 316\r\n6  CoreFoundation                 0x28c5c __CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ + 20\r\n7  CoreFoundation                 0xbd564 ___CFXRegistrationPost_block_invoke + 48\r\n8  CoreFoundation                 0x92b44 _CFXRegistrationPost + 416\r\n9  CoreFoundation                 0x3d764 _CFXNotificationPost + 696\r\n10 Foundation                     0x19c98 -[NSNotificationCenter postNotificationName:object:userInfo:] + 92\r\n11 Foundation                     0x8d998 NSProcessInfoNotifyPowerState + 184\r\n12 Foundation                     0x27b40 -[NSProcessInfo(NSProcessInfoHardwareState) isLowPowerModeEnabled] + 120\r\n13 Datadog                        0x2a680 closure #1 in LowPowerModeMonitor.init(initialProcessInfo:notificationCenter:) + 140 (MobileDevice.swift:140)\r\n14 Datadog                        0x2a720 thunk for @escaping @callee_guaranteed (@in_guaranteed Notification) -> () + 4374603552 (<compiler-generated>:4374603552)\r\n15 Foundation                     0x335f8 -[__NSObserver _doit:] + 316\r\n16 CoreFoundation                 0x28c5c __CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ + 20\r\n17 CoreFoundation                 0xbd564 ___CFXRegistrationPost_block_invoke + 48\r\n18 Foundation                     0x4e21c __NSBLOCKOPERATION_IS_CALLING_OUT_TO_A_BLOCK__ + 16\r\n19 Foundation                     0x5f6f4 -[NSBlockOperation main] + 100\r\n20 Foundation                     0x39ddc __NSOPERATION_IS_INVOKING_MAIN__ + 20\r\n21 Foundation                     0x49f1c -[NSOperation start] + 780\r\n22 Foundation                     0x4d314 __NSOPERATIONQUEUE_IS_STARTING_AN_OPERATION__ + 20\r\n23 Foundation                     0x5aa2c __NSOQSchedule_f + 180\r\n24 libdispatch.dylib              0x632ec _dispatch_call_block_and_release + 24\r\n25 libdispatch.dylib              0x642f0 _dispatch_client_callout + 16\r\n26 libdispatch.dylib              0x109a0 _dispatch_main_queue_callback_4CF$VARIANT$mp + 936\r\n27 CoreFoundation                 0x4d7f8 __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__ + 12\r\n28 CoreFoundation                 0xb0f8 __CFRunLoopRun + 2528\r\n29 CoreFoundation                 0x1dd8c CFRunLoopRunSpecific + 572\r\n30 GraphicsServices               0x19a0 GSEventRunModal + 160\r\n31 UIKitCore                      0x4edfa8 -[UIApplication _run] + 1080\r\n32 UIKitCore                      0x28222c UIApplicationMain + 2060\r\n```\r\n\r\n```\r\nThread 0 [Crashed]:\r\n\r\n0    libsystem_platform.dylib                 0x1f15920c0     _os_unfair_lock_recursive_abort + 36\r\n1    libsystem_platform.dylib                 0x1f158ca10     _os_unfair_lock_lock_slow + 303\r\n2    Foundation                               0x183211730     -[NSProcessInfo(NSProcessInfoHardwareState) isLowPowerModeEnabled] + 67\r\n3    Datadog                                  0x102bdfa28     closure #1 in LowPowerModeMonitor.init(MobileDevice.swift:140)\r\n4    Datadog                                  0x102bdfac8     thunk for @escaping @callee_guaranteed (<compiler-generated>:0)\r\n5    Foundation                               0x18321d5b0     -[__NSObserver _doit:] + 347\r\n6    CoreFoundation                           0x1819e8ee8     _CFNOTIFICATIONCENTER_IS_CALLING_OUT_TO_AN_OBSERVER__ + 27\r\n7    CoreFoundation                           0x181a84b9c     __CFXRegistrationPost_block_invoke + 51\r\n8    CoreFoundation                           0x181a57f54     _CFXRegistrationPost + 455\r\n9    CoreFoundation                           0x1819fed54     _CFXNotificationPost + 715\r\n10   Foundation                               0x183203028     -[NSNotificationCenter postNotificationName:object:userInfo:] + 95\r\n11   Foundation                               0x18327b9d4     NSProcessInfoNotifyPowerState + 187\r\n12   Foundation                               0x183211768     -[NSProcessInfo(NSProcessInfoHardwareState) isLowPowerModeEnabled] + 123\r\n13   WebCore                                  0x190a48118     -[WebLowPowerModeObserver initWithNotifier:] + 95\r\n14   WebCore                                  0x1914c416c     WebCore::LowPowerModeNotifier::LowPowerModeNotifier(WTF::Function<void (bool)>&&) + 51\r\n15   WebCore                                  0x1923e9c4c     WebCore::Page::Page(WebCore::PageConfiguration&&) + 1847\r\n16   WebKitLegacy                             0x1a550de34     -[WebView(WebPrivate) _commonInitializationWithFrameName:groupName:] + 3059\r\n17   WebKitLegacy                             0x1a550d214     -[WebView(WebPrivate) _initWithFrame:frameName:groupName:] + 115\r\n18   UIFoundation                             0x18c7b9028     -[NSHTMLReader _loadUsingWebKit] + 831\r\n19   UIFoundation                             0x18c7ba15c     -[NSHTMLReader attributedString] + 31\r\n20   UIFoundation                             0x18c7734e8     _NSReadAttributedStringFromURLOrData + 8419\r\n21   UIFoundation                             0x18c771378     -[NSAttributedString(NSAttributedStringUIFoundationAdditions) initWithData:options:documentAttributes:error:] + 155\r\n```\r\n\r\nAll crashes occur on iOS 15 (so far we received reports for iOS 15, 15.1 and 15.2).\r\nSimilar feedback has already been reported in FB9661108.\r\n\r\n---\r\n\r\n**Please list the steps you took to reproduce the issue:**\r\nWith my best efforts, I couldn’t reproduce it locally. I only rely on crash reports reported by our customers.\r\n\r\n**What did you expect to happen?**\r\nObtaining `ProcessInfo.processInfo.isLowPowerModeEnabled` should be thread safe no matter of surrounding code. Reading it from `.NSProcessInfoPowerStateDidChange` notification callback should not lead to crash.\r\n\r\n**What actually happened?**\r\nSometimes, reading `.isLowPowerModeEnabled` from `ProcessInfo` **within the `. NSProcessInfoPowerStateDidChange` notification callback** causes a dead lock in `libsystem_platform.dylib` and leads to `_os_unfair_lock_recursive_abort` crash."
    email: ncreated@gmail.com
    modified: "2021-11-05T08:42:06.243695Z"
    number: FB9741207
    number_intvalue: 9741207
    originated: Nov 5, 2020
    parent_number: '&{NULL_VALUE}'
    product: iOS
    product_version: "15"
    reproducible: Very rare
    resolved: ""
    status: Open
    title: isLowPowerModeEnabled causes a deadlock on iOS 15
