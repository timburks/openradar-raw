apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: FB9020394
    labels:
        datastore_id: "5027684509810688"
data:
    classification: Incorrect/Unexpected Behavior
    created: "2021-02-25T23:48:18.234193Z"
    description: "SETUP: macOS 11.2.1 Big Sur\r\nI)  Productive internal SSD \"mac\", APFS, FileVault off.\r\nII) Backup external HDD \"mac-bk-hdd\", APFS, FileVault on.\r\n\r\nHOW DID I CREATE \"mac-bk-hdd\":\r\na) Clean erase with Disk Utility, then initial Carbon Copy Cloner (CCC) full clone.\r\nb) Boot into \"mac-bk-hdd\" as main user \"sn\", activated FileVault in SysPreferences. Initial encryption started. Suspicion: Frontend triggers backend `fdesetup -user user1` and `-usertoadd user2 user3 …` is omitted for some reason.\r\nc) Boot back to \"mac\". Externally attached \"mac-bk-hdd\". It continued to encrypt in background til done.\r\n\r\nPROBLEM / BUG:\r\n- Booting into clone \"mac-bk-hdd\" via Startup Manager (ALT-key held down during stattup)\r\n- FileVault login screen only shows main user \"sn\". But all other users are missing!\r\n\r\nOBSERVATIONS:\r\n- Decryption login works ok for main user \"sn\" and also with personal recovery key.\r\n- The users which are missing on the FileVault login screen got fully cloned (home directory, open directory entry) and can login/logout normally once the FileVault is decrypted. But they miss a corresponding FileVault Key as `fdesetup list -extended` shows.\r\n- Manual adding FileVault users with i.e. `fdesetup add -usertoadd user2` fails with:\r\nError: Unable to add one or more users to FileVault. (-69594)\r\n\r\nEXPECTED:\r\n- Ideally when cloning, cloned users shall get a FileVault key created on the destination volume too. Ideally automatically or at latest when they log in with a dialogue if credentials need to be asked for fresh key generation.\r\n- And at least manually adding with `fdesetup add -usertoadd` should work.\r\n- Mike Bombich and me had an exchange. He recommended me to file a feedback.\r\n-- The problem is maybe not a bug, but a new intended behavior.\r\n-- If -usertoadd indeed does not function anymore then it should be removed in function and manpage.\r\n-- Of if -usertoadd is forbidden only for users of cloned volumes (does the system know?) then give at least a more descriptive error message. Of course I would pity that, because that means you can no longer get bootable clones with FileVault on them!\r\n\r\n\r\nALL MY FIX ATTEMPTS FAILED: TL;DR:\r\n\r\n0  My first more naive fix attempts with `diskutil updatePreboot` and \"Recovery > Disk Utility First Aid\" led to nothing.\r\n1  Ran CCC sync again from internal SSD \"mac\" -> \"mac-bk-hdd\" to be sure \"everything carried over\".\r\n2  Booted into \"mac-bk-hdd\".\r\n2a Users \"gn\" and \"tn\" again did not get a FileVault key and do not appear in FileVault login screen.\r\n2b Manually logging them in and out changed nothing. Suspicion \"deferred key creation\" ruled out too.\r\n2c `fdesetup add -usertoadd` fails with: Error: Unable to add one or more users to FileVault. (-69594)\r\n2d While booted on clone, freshly created users \"bs1-bs3\" get FileVault key and appear in login screen. All fine!\r\n3  Booted back into internal SSD \"mac\".\r\n3a Created fresh user \"bs4\". Gets FileVault key/ID though FileVault off on \"mac\". Normal behavior.\r\n3b CCC sync again\r\n4  Booted into internal SSD \"mac\".\r\n4a User \"bs4\" from \"mac\" on \"mac-bk-hdd\" gets home directory but again no FileVault key. Users bs1-bs3 which were only present on clone and hence got deleted by sync leave orphaned FileVault keys behind. Bit of a security concern.\r\n4b `sudo fdesetup showdeferralinfo` -> Not found. # No users queued for key creation. Cannot be the cause.\r\n4c `fdesetup add -usertoadd bs4` fails again with Error (-69594).\r\n\r\n\r\nIN DETAIL:\r\n\r\n0) Ran \"diskutil updatePreboot\" and \"Recovery > Disk Utility First Aid\" on \"mac-bk-hdd\"\r\nBoth ran successfully. Nothing changed.\r\n\r\n1b) FileVault status on \"mac\":\r\n➜ ~ sudo fdesetup status\r\nFileVault is Off.\r\n➜ ~ sudo fdesetup list -extended\r\nUUID                                                      TYPE USER\r\nF9████████████████████████████████B6                   OS User gn\r\n44████████████████████████████████14                   OS User sn\r\n34████████████████████████████████25                   OS User ln\r\n\r\n1c) CCC: syncing \"mac\" -> \"mac-bk-hdd\"\r\nHoped that with this new sync any missed data from the first sync may carry over now.\r\n\r\n2) Booted into clone \"mac-bk-hdd\"\r\nXProtectService & sypolicyd run for ca 90-120min together.\r\n- Clearly HDD I/O is the bottleneck, CPU is under-challenged.\r\n- This happens after each boot after having clone-synced!\r\n- Until then system defacto blocked.\r\n- Then Spotlight for 5min, but this does not block the system at least.\r\n- In elder macOS the only extra time cost was kernel cache renewal and Spotlight, after at latest 7-8min you were up and running in your clone.\r\n- Also System Preferences > Security & Privacy > Privacy: Most permissions are forgotten and need to be granted again!\r\n- The idea of a clone to me is to have the same configuration without much waiting and effort.\r\n- To simply check out \"Did my clone work?\" this is way too long!\r\n- Could CCC copy over the \"trust information\" of XProtectService & sypolicyd to avoid the big wait for stuff that was anyhow already checked as safe?\r\n-- Bombich says you at Apple have your reasons for this. It will stay that way most likely. Does it?\r\n\r\n2a) ➜ ~ sudo fdesetup list -extended\r\nUUID                                                      TYPE USER\r\n44████████████████████████████████14                   OS User sn\r\nEB████████████████████████████████AC  Personal Recovery Record\r\nUsers \"gn\" and \"ln\" got no corresponding FileVault key!\r\n\r\n2b) Logging in user \"ln\" which was fresh on original. Run through \"first use wizard\".\r\nLogging in user \"gn\", normal login.\r\nIn both users on logout there was no info/prompt like \"Setting up your FileVault keys now\".\r\n➜ ~ sudo fdesetup showdeferralinfo\r\nNot found.\r\nDeferred FileVault key creation cannot be the problem.\r\nWill try to add users manually.\r\n\r\n2c) ➜ ~ sudo fdesetup add -usertoadd gn\r\nEnter the user name:gn\r\n# Offtopic, but bad UX: Why ask username again if already supplied via argument?\r\nEnter the password for user 'gn':\r\nEnter the password for the added user 'gn':\r\nError: Unable to add one or more users to FileVault. (-69594)\r\n\r\nTried it twice with \"gn\". Then also with \"ln\". Failed all times.\r\nOn purpose entered wrong PW, then failed with another error:\r\nOD user 'gn' could not be authenticated.\r\nSo there's something indeed wrong here!\r\n\r\n2d) Creating new users \"bs1\", bs2\" and \"bs3\" via System Preferences > Users & Groups\r\nChecking whether they got FileVault keys automatically:\r\n\r\n➜ ~ sudo fdesetup list -extended\r\nUUID                                                     TYPE USER\r\n44████████████████████████████████14                   OS User sn\r\nEB████████████████████████████████AC  Personal Recovery Record\r\nA6████████████████████████████████94               OS User bs1\r\n44████████████████████████████████92               OS User bs2\r\n68████████████████████████████████1F               OS User bs3\r\n\r\nAll bs* users were immediately added as FileVault users.\r\nRebooting. All bs* users are shown on FileVault login screen too.\r\nAuthenticating them works too. All fine!\r\n\r\n3) Booting back into internal SSD \"mac\".\r\n\r\n3a) Creating new user \"bs4\" in \"mac\". Logging in as bs4. Running first use wizard.\r\nGot added as FileVault user automatically, as can be seen here:\r\n➜ ~ sudo fdesetup list -extended \r\nUUID                                                      TYPE USER\r\n0E████████████████████████████████F5                   OS User bs4\r\n\r\n3b) Now let's see whether user \"bs4\" gets synced over and gets a FileVault key and whether \"bs1-3\" get erased and optimally get their FileVault key destroyed too.\r\n\r\nCCC: syncing \"mac\" -> \"mac-bk-hdd\"\r\n7850 files, total 16.17 GB.\r\nQuite a lot as I mostly changed nothing besides the new user \"bs4\".\r\nA lot of things go on a system during 1h of idle use. Nevertheless suspiciously much data.\r\n\r\n4) Booting into \"mac-bk-hdd\".\r\n\r\nXProtectService and syspolicyd again ran for 90-120min leaving the system more/less blocked.\r\n\r\n4a) ➜ ~ sudo fdesetup list\r\nUUID                                                      TYPE USER\r\n44████████████████████████████████14                OS User sn # My main user\r\nEB████████████████████████████████AC  Personal Recovery Record # Created during FileVault activation\r\nA6████████████████████████████████94              Unknown User # By UID this is user bs1.\r\n44████████████████████████████████92              Unknown User # By UID this is user bs2.\r\n68████████████████████████████████1F              Unknown User # By UID this is user bs3.\r\n\r\n# Users bs1-bs3 only existed on the clone \"mac-bk-hdd\".\r\n# The next CCC sync:\r\n## Deleted the bs1-3 users. Their FileVault keys remained \"orphaned\" hence \"Unknown User\".\r\n## Either CCC or Apple should have a mechanism to remove those!\r\n## Because at least in theory those users were deleted for a reason, but could potentially still gain access to the backup later.\r\n\r\n4b) sudo fdesetup showdeferralinfo -> Not found. # No users enqueued for key creation. Cannot be the cause.\r\n\r\n4c) `fdesetup add -usertoadd bs4` fails again with same error:\r\n➜ ~ sudo fdesetup add -usertoadd bs4\r\nEnter the user name:bs4\r\nEnter the password for user 'bs4':\r\nEnter the password for the added user 'bs4':\r\nError: Unable to add one or more users to FileVault. (-69594)"
    email: p.org@gmx.at
    modified: "2021-02-25T23:48:18.234345Z"
    number: FB9020394
    number_intvalue: 9020394
    originated: "2021-02-26"
    parent_number: '&{NULL_VALUE}'
    product: Filesystem
    product_version: macOS 11.2.1
    reproducible: Yes
    resolved: ""
    status: Open
    title: FileVault Login Screen of cloned APFS volume only shows main user and misses all other users from original volume
