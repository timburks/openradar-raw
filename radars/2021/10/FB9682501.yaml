apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: FB9682501
    labels:
        datastore_id: "4937474191130624"
data:
    classification: Incorrect/Unexpected Behavior
    created: "2021-10-06T15:51:28.302808Z"
    description: "There are two features in macOS SetupAssistant which do not play well with each together: Remote Management (Automatic Device Enrollment) and Migration Assistant (restoring Mac from TimeMachine backup). This problem is applicable to all versions of macOS but this feedback was tested specifically against macOS 12.0 Monterey Beta 8 21A5534d.\r\n\r\nThere are multiple problems related to these features. In this feedback I am going to illustrate the TimeMachine restore of all files together with Automatic Device Enrollment.\r\n\r\n# Prepare the scenario\r\n\r\nFirst we need to create a Time Machine backup we are going be using later.\r\n\r\n1. If the Mac is in the Apple Business Manager, use the MDM to remove cloud/DEP profile from the ABM so no Automatic Device Enrollment occurs during SetupAssistant\r\n2. Mac has the latest version of macOS Big Sur installed and it is NOT enrolled in the MDM\r\n3. Upgrade the Mac to the latest version of macOS Monterey. Currently Beta 8 21A5534d\r\n4. Initiate the Erase All Content and Settings from System Preferences to get a Mac with fresh macOS Monterey state\r\n5. Proceed through the macOS SetupAssistant\r\n6. Personalizace the user account (wallpaper, data, apps, etc.)\r\n7. Create a TimeMachine backup\r\n\r\nPrepare the Mac for Automatic Device Enrollment.\r\nWe can use the same Mac from which we created the backup or a different one. It does not matter.\r\n\r\n1. Assign MDM DEP/Cloud profile (+ other MDM features) to the Mac we are going to enroll via ADE.\r\n  - Authentication during enrollment: Yes\r\n  - Supervision: Yes\r\n  - SetupAssistant panes to be skipped: NONE\r\n  - Computer account: administrator\r\n  - Managed administrator created by the MDM: NO\r\n2. Initiate the Erase All Content and Settings to get a Mac with fresh macOS Monterey\r\n\r\n\r\n# Steps to reproduce\r\n\r\nNow we try to combine Automated Device Enrollment with Time Machine Restore during SetupAssistant.\r\n\r\n1. Start the Mac with fresh install of macOS Monterey\r\n2. Proceed through the macOS SetupAssistant\r\n3. There is a Remote Management. Let it enroll the Mac into the MDM\r\n4. There is a Migration Assistant pane. Use it to restore the Mac from the Time Machine Backup we created earlier\r\n  - Restore all data. (Users, Apps, Other Files and System Files)\r\n  - Enter the passwords of all users to be migrated\r\n  - Let it do the migration\r\n5. When macOS boots up log into the user account\r\n6. Use MDM to issue any command through the device channel.\r\n\r\n# Expected result\r\n\r\nAt least the device channel MDM commands work. When the Mac gets the Apple push notification it successfully checks in with the MDM and executes any MDM commands it wants it to do.\r\n\r\n# Actual result\r\n\r\nDevice channel MDM commands do not work. Mac gets the Apple push notification but when it tries to connect to the MDM there is this error:\r\n\r\nerror\t11:58:04.571723+0200\tmdmclient\t[ERROR] MDM_Connect: Unable to create MDM identity from persistent reference: -25304 (The specified item is no longer valid. It may have been deleted from the keychain.) for profile: Device Manager (6eff7eec-f566-41d6-bf11-0ee5799b2488:b1759c0f-9d45-4e81-82dd-c2d408a3620a)\\\r\n\r\n# Workaround\r\n\r\nIf user does NOT chose to restore the \"System Files and Folders\" from the TM backup, device channel MDM commands work.\r\n\r\n# Possible reason\r\n\r\nWhen migration assistant restores the \"System Files and Folders\"  from the TM backup it overwrites the system keychain. The results is that Mac is missing the necessary TLS client certificate to authenticate with the MDM thus failing to connect and retrieve any commmands or queries.\r\n\r\n# Possible solutions\r\n\r\nA. Take the possibility of this situation into account. Migration Assistant launched during SetupAssistant could merge the System keychain containing MDM-related items with the System keychain from the backup.\r\n\r\nB. Warn the user what is going to happen = Mac with the enrollment profile installed but broken MDM configuration.\r\n\r\nC. Remove all configuration profiles (even the enrollment profile) and make the user to enroll the Mac again. Perhaps reuse existing Automatic Device Enrollment notification system. (profiles renew -type enrollment)"
    email: michalm.mac@gmail.com
    modified: "2021-10-06T15:51:28.30296Z"
    number: FB9682501
    number_intvalue: 9682501
    originated: "2021-10-06"
    parent_number: '&{NULL_VALUE}'
    product: macOS
    product_version: 12.0 Monterey Beta 8 21A5534d
    reproducible: Always
    resolved: ""
    status: Open
    title: Restoring entire Mac from TimeMachine during SetupAssistant breaks Automatic Device Enrollment
