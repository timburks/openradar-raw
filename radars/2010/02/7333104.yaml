apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "7333104"
    labels:
        datastore_id: "145401"
data:
    classification: Serious Bug
    created: "2010-02-02T11:49:15.390852Z"
    description: "Summary:\r\nAfter upgrading to 10.6, users are complaining that they can't reach certain web sites from IPv6-only networks, or complain that connections to dual-stack (IPv4 + IPv6) web sites are using IPv4 transport instead of IPv6 transport as was the case in 10.5 and earlier, and in all other operating systems.  There is a general complaint that 10.6 is preferring IPv4 over IPv6, when it is supposed to be the other way around (per RFC 3484).\r\n\r\nIn the process of sniffing the traffic, we see that any name query results in 2 DNS queries, one for the \"A\" resource record, and one for the \"AAAA\" record, as expected.  We also see that when we query for the name of a system that operates both IPv4 and IPv6, we get replies for each of those queries, one reply for the IPv4 addresses (\"A\" records) and one reply for the IPv6 addresses (\"AAAA\" records).  However, whatever answer comes in second is usually rejected, as evidenced by a \"UDP Port Unreachable\" ICMP response from the MacOSX 10.6 machine that initiated the query in the first place.\r\n\r\nIn observing the debug output from mDNSResponder, it appears that the first response causes the remaining query to be Canceled, the socket closed, and the OS rejects the message, so mDNSResponder never receives it.\r\n\r\nThe result is that the first reply wins.  If the first reply happens to be the \"A\" record (most often the case), then the \"AAAA\" answer is rejected, and the eventual client connection is made via IPv4.  If the first reply is the \"AAAA\", then that one wins and the connection is made over IPv6.\r\n\r\nHere is an example when the \"A\" worked, but the \"AAAA\" was rejected (lookup for www.kame.net):\r\n\r\n21:01:40.583892 192.168.1.2.62499 > 192.168.1.1.domain: 20561+ A? www.kame.net. (30)\r\n21:01:40.594347 192.168.1.2.55014 > 192.168.1.1.domain: 24513+ AAAA? www.kame.net. (30)\r\n21:01:40.739626 192.168.1.1.domain > 192.168.1.2.62499: 20561 1/0/0 www.kame.net. A 203.178.141.194 (46)\r\n21:01:40.904784 192.168.1.1.domain > 192.168.1.2.55014: 24513 1/0/0 www.kame.net. AAAA 2001:200::8002:203:47ff:fea5:3085 (58)\r\n21:01:40.904812 192.168.1.2 > 192.168.1.1: ICMP 192.168.1.2 udp port 55014 unreachable, length 36\r\n    192.168.1.1.domain > 192.168.1.2.55014: [|domain]\r\n\r\nHere's an example where the \"AAAA\" was first, and the \"A\" was rejected (lookup for www.sixxs.net):\r\n\r\n20:32:53.877307 192.168.1.2.64639 > 192.168.1.1.domain: 63083+ A? www.sixxs.net. (31)\r\n20:32:53.886759 192.168.1.2.63909 > 192.168.1.1.domain: 44461+ AAAA? www.sixxs.net. (31)\r\n20:32:54.056428 192.168.1.1.domain > 192.168.1.2.63909: 44461 2/0/0 www.sixxs.net. CNAME www.m.sixxs.net., www.m.sixxs.net. AAAA 2001:838:1:1:210:dcff:fe20:7c7c (79)\r\n20:32:54.167615 192.168.1.1.domain > 192.168.1.2.64639: 63083 3/0/0 www.sixxs.net. CNAME www.m.sixxs.net., www.m.sixxs.net. A 213.204.193.2, www.m.sixxs.net. A 193.109.122.244 (83)\r\n20:32:54.167658 192.168.1.2 > 192.168.1.1: ICMP 192.168.1.2 udp port 64639 unreachable, length 36\r\n    192.168.1.1.domain > 192.168.1.2.64639: [|domain]\r\n\r\nThe second reply is always rejected with a UDP Port Unreachable.\r\n\r\nHere's the debug output from mDNSResponder for that www.kame.net lookup:\r\n\r\nOct 23 21:01:40 neko mDNSResponder[17]:  43: Error socket 40 created 00000000 00000233\r\nOct 23 21:01:40 neko mDNSResponder[17]:  43: DNSServiceQueryRecord(www.kame.net., Addr, 5000) START\r\nOct 23 21:01:40 neko mDNSResponder[17]:  43: Error socket 40 closed  00000000 00000233 (0)\r\nOct 23 21:01:40 neko mDNSResponder[17]:  43: Error socket 40 created 00000000 00000234\r\nOct 23 21:01:40 neko mDNSResponder[17]:  43: DNSServiceQueryRecord(www.kame.net., AAAA, 5000) START\r\nOct 23 21:01:40 neko mDNSResponder[17]:  43: Error socket 40 closed  00000000 00000234 (0)\r\nOct 23 21:01:40 neko mDNSResponder[17]: -- Sent UDP DNS Query (flags 0100) RCODE: NoErr (0) RD ID: 20561 18 bytes from port 62499 to 192.168.1.1:53 --\r\nOct 23 21:01:40 neko mDNSResponder[17]:  1 Questions\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 www.kame.net. Addr\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 Answers\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 Authorities\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 Additionals\r\nOct 23 21:01:40 neko mDNSResponder[17]: --------------\r\nOct 23 21:01:40 neko mDNSResponder[17]: -- Sent UDP DNS Query (flags 0100) RCODE: NoErr (0) RD ID: 24513 18 bytes from port 55014 to 192.168.1.1:53 --\r\nOct 23 21:01:40 neko mDNSResponder[17]:  1 Questions\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 www.kame.net. AAAA\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 Answers\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 Authorities\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 Additionals\r\nOct 23 21:01:40 neko mDNSResponder[17]: --------------\r\nOct 23 21:01:40 neko mDNSResponder[17]: -- Received UDP DNS Response (flags 8180) RCODE: NoErr (0) RD RA ID: 20561 34 bytes from 192.168.1.1:53 to 192.168.1.2:62499 --\r\nOct 23 21:01:40 neko mDNSResponder[17]:  1 Questions\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 www.kame.net. Addr\r\nOct 23 21:01:40 neko mDNSResponder[17]:  1 Answers\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 TTL    900    4 www.kame.net. Addr 203.178.141.194\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 Authorities\r\nOct 23 21:01:40 neko mDNSResponder[17]:  0 Additionals\r\nOct 23 21:01:40 neko mDNSResponder[17]: --------------\r\nOct 23 21:01:40 neko mDNSResponder[17]:  43: DNSServiceQueryRecord(www.kame.net., Addr) ADD    4 www.kame.net. Addr 203.178.141.194\r\nOct 23 21:01:40 neko mDNSResponder[17]:  43: Cancel 00000000 00000233\r\nOct 23 21:01:40 neko mDNSResponder[17]:  43: DNSServiceQueryRecord(www.kame.net., Addr) STOP\r\nOct 23 21:01:40 neko mDNSResponder[17]:  43: Cancel 00000000 00000234\r\nOct 23 21:01:40 neko mDNSResponder[17]:  43: DNSServiceQueryRecord(www.kame.net., AAAA) STOP\r\n\r\nObserve how after the first answer was received and accepted, all related queries were STOPped/Canceled.  There is no record of ever receiving the second response.\r\n\r\nSteps to Reproduce:\r\n\r\nUse Safari to browse to an IPv6-enabled web site (http://www.kame.net), from a machine that is dual stack and has reachability to the IPv4 Internet and IPv6 Internet, and observe that it is connecting using IPv4 instead of IPv6.   Use \"tcpdump -i en0 -s 1500 icmp or port 53\" to observe the DNS behavior:\r\n\r\n# tcpdump -i en0 -s 1500 icmp or port 53\r\nlistening on en0, link-type EN10MB (Ethernet), capture size 1500 bytes\r\n22:38:45.524982 IP 192.168.1.2.56540 > 192.168.1.1.domain: 3163+ A? www.kame.net. (30)\r\n22:38:45.534432 IP 192.168.1.2.63324 > 192.168.1.1.domain: 41675+ AAAA? www.kame.net. (30)\r\n22:38:45.578476 IP 192.168.1.1.domain > 192.168.1.2.56540: 3163 1/0/0 A 203.178.141.194 (46)\r\n22:38:45.754904 IP 192.168.1.1.domain > 192.168.1.2.63324: 41675 1/0/0 AAAA 2001:200::8002:203:47ff:fea5:3085 (58)\r\n22:38:45.754943 IP 192.168.1.2 > 192.168.1.1: ICMP 192.168.1.2 udp port 63324 unreachable, length 36\r\n\r\nSee how the \"AAAA\" reply is rejected.\r\n\r\nExpected Results:\r\n\r\nThe \"AAAA\" should not be rejected, and the browser should receive the AAAA record, and connect to the web site using IPv6.\r\n\r\nActual Results:\r\n\r\nThe \"AAAA\" is rejected, so the browser never knows the IPv6 address, and connects using IPv4.\r\n\r\nRegression:\r\n\r\nThis problem did not occur in 10.5 or any previous version of MacOSX that had IPv6 support.  It only appears after upgrade to 10.6.  It is not fixed in 10.6.1.\r\n\r\nNotes:\r\n\r\nWe have a large research and engineering network that is dual-stack everywhere (all systems, all networks), and we received complaints from all users that upgraded to 10.6.  Since this impacts us so seriously, we've had to tell all Mac users to NOT upgrade to 10.6 until this issue is resolved.  We have not found a workaround."
    email: ron@spawar.navy.mil
    modified: "2011-08-28T05:43:56.169262Z"
    number: "7333104"
    number_intvalue: 7333104
    originated: 23-Oct-2009 10:54 PM
    parent_number: "7327894"
    product: Mac OS X
    product_version: "10.6"
    reproducible: Yes
    resolved: No
    status: Duplicate/7327894
    title: MacOSX 10.6 Rejected DNS responses causing IPv6 failures
