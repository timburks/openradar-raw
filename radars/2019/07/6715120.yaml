apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "6715120"
    labels:
        datastore_id: "4942425986433024"
data:
    classification: Incorrect/Unexpected Behavior
    created: "2019-07-18T19:36:50.043688Z"
    description: "Summary:\r\n\r\nWe see some weird network behavior and frequently stalling video playback for the same remote video file on the same connection depending on whether we create the AVPlayerItem from AVURLAsset or from an AVMutableComposition. The playback performance issues our users experience while using AVMutableComposition has caused us to temporarily disable closed captions for some videos available within our app on iOS only, which is an accessibility issue.\r\n\r\nDetails:\r\n\r\nWe use AVMutableComposition in order to play remote video and subtitles assets simultaneously within our app. Videos (.mp4) and subtitles (.vtt) are stored remotely and accessed via https requests to a CDN. Using HLS playlists is not an option at this time. \r\n\r\nWhen using AVMutableComposition, regardless of whether we add a subtitle track to it, we see LOTS of requests for ~64k chunks of the video file as AVPlayer requests sequential byte ranges. Requests made by Core Media for the 64k byte ranges does not adjust over time, as it does when playing the video using AVURLAsset only.  In a high latency environment, or with a high bitrate video, the playback is choppy as the chunks are not received fast enough to keep up with playback and the experience is terrible. We can play the same video from the same url just fine, if we do not add it as a track to the AVMutableComposition but play it directly. In this case the network requests made for byte ranges of the video are increased to much larger chunks as the video is played. This is illustrated below.\r\n\r\nThe issue described below occurs whether or not subtitle track is added to the AVMutableComposition, so for reproduction purposes, the subtitles have been left out.\r\n\r\nReproduction:\r\n\r\nThis issue is reproducible 100% of the time on both simulator and devices. The attached Xcode project contains a simple application which demonstrates the issue. We're using a fairly high bitrate video to demonstrate the issue: https://a0.muscache.com/v/a8/22/a822ce79-9cd8-53fc-842d-6264755e1e9e/a822ce799cd853fc842d6264755e1e9e.mp4\r\n\r\nSteps \r\n1 - Open and Run the attached project (AVCompositionBugDemo.xcodeproj) or clone https://github.com/alexcorre/AVCompositionBugDemo\r\n2 - Tap the top \"Play Video\" button\r\n3 - Start watching the video\r\n4 - Using the tool of your choice, inspect the network traffic requesting byte ranges of the video. For convenience we've included a HTTP archive (play_video.har) with some traffic observed when running this in the simulator.\r\n5 - Note the requested byte range increases and the number of requests is small (order of 10 to play the first 10 seconds or so of video)\r\n6 - Close the player modal\r\n7 - Tap the bottom \"Play video using AVMutableComposition\" button\r\n8 - Start watching the video\r\n9 - Using the tool of your choice, inspect the network traffic requesting byte ranges of the video. For convenience we've included an HTTP archive (play_video_with_composition.har) with some traffic observer while running this in the simulator. \r\n\r\nExpected behavior: \r\nI would expect to see the same number of requests and increasing byte range size as the first case. \r\n\r\nActual behavior:\r\nI see the byte range value stays at 64k throughout playback, causing hundreds or thousands of requests for small byte ranges of this file. Even on a high speed wifi connection, playback of this video is extremely choppy, only for the AVMutableComposition case. The requests in question are made with user agent: AppleCoreMedia/1.0.0.16E226 (iPhone; U; CPU OS 12_2 like Mac OS X; en_us)\r\n\r\nConclusion:\r\nIt appears to be a bug that the network behavior changes so drastically to play the same exact video, when AVMutableComposition is used. This network behavior is what we believe causes bad experience and choppy playback for high bitrate videos that would otherwise play fine on a good connection. Any information on this would be helpful.\r\n\r\nVersion/Build:\r\nXcode Version 10.2.1 (10E1001)\r\niPhone XS Simulator Version 10.2.1 (SimulatorApp-880.5 CoreSimulator-587.35)"
    email: alexcorre513@gmail.com
    modified: "2019-07-18T19:36:50.043844Z"
    number: "6715120"
    number_intvalue: 6715120
    originated: 7/17/19
    parent_number: '&{NULL_VALUE}'
    product: AVKit
    product_version: ""
    reproducible: Always
    resolved: ""
    status: Open
    title: Using AVMutableComposition in AVPlayer causes non-optimal network requests during progressive download
