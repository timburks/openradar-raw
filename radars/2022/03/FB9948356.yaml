apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: FB9948356
    labels:
        datastore_id: "5588217663324160"
data:
    classification: Incorrect/Unexpected Behavior
    created: "2022-03-07T19:58:46.035901Z"
    description: "# Intro\r\n\r\nWe currently work on Wi-Fi transition from SSID: OLDWIFI (WPA2 Personal) to SSID: NEWWIFI (WPA2 Enterprise EAP-TTLS with PAP).\r\nWe want to use EAP-TTLS with PAP inner authentication method so our user can use Okta credentials to authenticate when connecting to Wi-Fi.\r\nmacOS won't connect to EAP-TTLS with PAP by default unless explicitly configured in configuration profile. We provide the configuration profile via MDM (VMware Workspace ONE UEM).\r\n\r\n# Problem\r\n\r\nWhen user want to connect to NEWWIFI (EAP-TTLS with PAP) for the first time, prompt for password appears after long 6 seconds. This happens because macOS connects to NEWWIFI 3 times but asks for the credentials only during the 3rd attempt. See ttls_longwait.mov. Not ideal user experience.\r\n\r\nSame behavior occurs with both SYSTEM and USER scoped configuration profile.\r\n\r\n# Steps to reproduce\r\n\r\n1. Send SYSTEM scope configuration profile wifi_system_scope.mobileconfig or (USER scope configuration profile wifi_user_scope.mobileconfig) to managed Macs via MDM (Profiles can be installed manually for the purpose of this bug report).\r\n2. Profile is delivered and configuration applied.\r\n3. If the profile is SYSTEM scope macOS will automatically try to connect to NEWWIFI, fail and reconnect back to OLDWIFI. FB9947906\r\n4. User opens the Wi-Fi menu and clicks on the NEWWIFI SSID.\r\n\r\n# Expected result\r\n\r\nmacOS prompts the user for credentials within reasonable time frame (3 seconds?).\r\n\r\n# Actual result\r\n\r\nIt takes about 6 seconds before credentials prompt appears.\r\n\r\nHere is why:\r\n\r\n1. macOS tries to connect to NEWWIFI for the first time. Does not prompt for credentials:\r\n\r\n2022-03-04 16:43:19.038582+0100 0x7be2     Default     0x0                  3765   0    eapolclient: [com.apple.eapol:Client] en0: 802.1X User Mode\r\n2022-03-04 16:43:19.892771+0100 0x7be2     Default     0x0                  3765   0    eapolclient: [com.apple.eapol:Client] Authenticating: can't prompt for missing properties (\r\n    UserPassword\r\n)\r\n2022-03-04 16:43:19.893871+0100 0x7be2     Info        0x0                  3765   0    eapolclient: [com.apple.eapol:Client] State=Held Status=UserInputNotPossible (15):\r\n\r\n2. macOS tries to connect to NEWWIFI for the second time. Does not prompt for credentials:\r\n\r\n2022-03-04 16:43:21.003193+0100 0x7c21     Default     0x0                  3767   0    eapolclient: [com.apple.eapol:Client] en0: 802.1X System Mode\r\n2022-03-04 16:43:21.380395+0100 0x7c21     Default     0x0                  3767   0    eapolclient: [com.apple.eapol:Client] Acquired: cannot prompt for missing user name\r\n2022-03-04 16:43:21.413920+0100 0x7c21     Info        0x0                  3767   0    eapolclient: [com.apple.eapol:Client] State=Held Status=UserInputNotPossible (15):\r\n\r\n2. macOS tries to connect to NEWWIFI for the third time. Finally prompts for credentials:\r\n\r\n2022-03-04 16:43:22.549605+0100 0x7c39     Default     0x0                  3769   0    eapolclient: [com.apple.eapol:Client] en0: 802.1X User Mode\r\n2022-03-04 16:43:23.373531+0100 0x7c39     Info        0x0                  3769   0    eapolclient: [com.apple.eapol:Client] Authenticating: user input required for properties (\r\n    UserPassword\r\n)\r\n2022-03-04 16:43:23.373737+0100 0x7c39     Info        0x0                  3769   0    eapolclient: [com.apple.eapol:Client] State=Authenticating Status=UserInputRequired (3):\r\n\r\nI thinks this is way too much connection attempts especially since the username is provided by the configuration profile (\"cannot prompt for missing user name\" message is particularly weird).\r\n\r\n\r\n\r\n# Affected systems\r\nBoth M1 and Intel MacBook Pro running macOS 12 Monterey. Tested with\r\n- MacBookPro14,1 running 12.2.1 (21D62)\r\n  Test occured at 2022-03-04 15:46:34 CET\r\n- MacBookPro17,1 running 12.3 Beta 5 (21E5227a)\r\n  Test occurred (System scope profile) at 2022-03-04 14:03:44 CET\r\n  Test occurred (User scope profile) at 2022-03-04 16:43:19. CET\r\n\r\nTo provide more detailed logs we turned on extended logging via sudo wdutil log +wifi +eapol."
    email: michalm.mac@gmail.com
    modified: "2022-03-07T19:58:46.03606Z"
    number: FB9948356
    number_intvalue: 9948356
    originated: "2022-03-07"
    parent_number: '&{NULL_VALUE}'
    product: macOS
    product_version: "12.3"
    reproducible: Always
    resolved: ""
    status: Open
    title: First Wi-Fi connection to EAP-TTLS with PAP takes too long and prompts for password on 3rd attempt
