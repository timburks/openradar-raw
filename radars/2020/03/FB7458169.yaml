apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: FB7458169
    labels:
        datastore_id: "4945077122105344"
data:
    classification: ""
    created: "2020-03-11T19:50:23.239545Z"
    description: "For a huge project that has more than 500 targets (like 660), given warning is printed in a terminal just after opening the project in Xcode: \r\n```\r\nDetails:  Over 500 root items in navigable item coordinator: <DVTStackBacktrace: 0x7fcad8700660>\r\nObject:   <IDENavigableItemCoordinator: 0x7fcadeb51a20>\r\nMethod:   -_rootNavigableItemsWithRepresentedObjects:\r\nThread:   <NSThread: 0x7fcb03705950>{number = 1, name = main}\r\nPlease file a bug at https://feedbackassistant.apple.com with this warning message and any useful information you can provide.\r\n```\r\n\r\nOne issue that we observe and can potentially be caused by that is partial indexing persitance storage. Every time we reopen the Xcode project, and expect reusing previously generated index, indexing drains a CPU extensively. Although Xcode shows in the UI that indexing after reopen takes about 2 minutes (intializing datastore &  Indexing files), CPU usage is around 500-700% for the next 5 minutes (for a huge project).\r\n\r\nI tried to gather sourcekit logs (enabled using `SOURCEKIT_LOGGING=3` env) and see that after `indexer.callback.on-did-index-workspace` event, some extra communication (most likely related to indexing) happens, like:\r\n\r\n```\r\n2019-11-20 19:58:29.454 Xcode[42672:35682797] SourceKit-client: [2:notification:244023:1487.0000] {\r\n  key.notification: indexer.callback,\r\n  key.indexer.arg.indexer-token: 3,\r\n  key.indexer.callback.kind: indexer.callback.on-did-index-workspace\r\n}\r\n2019-11-20 19:58:29.455 Xcode[42672:35682797] SourceKit-client: [2:request:775:1487.0010] [1313] {\r\n  key.request: source.request.indexer.set-throttle-factor,\r\n  key.indexer.arg.throttle-factor: 1.000000e+00,\r\n  key.indexer.arg.indexer-token: 3\r\n}\r\n2019-11-20 19:58:29.455 Xcode[42672:35683197] SourceKit-client: [2:response:244023:1487.0012] [1313] {\r\n}\r\n2019-11-20 19:58:29.805 Xcode[42672:35683197] SourceKit-client: [2:callback-reply:244023:1487.3504] {\r\n  key.indexer.arg.indexable.settings: \"<DATA>\"\r\n}\r\n2019-11-20 19:58:29.805 Xcode[42672:35683197] SourceKit-client: [2:callback-info:112191:1487.3511] {\r\n  key.callback: indexer.callback,\r\n  key.indexer.arg.indexer-token: 3,\r\n  key.indexer.arg.indexable.id: \"/Users/xxxxxx.xcodeproj/SomeTarget1Tests-150E864630B54E819D0225E2\",\r\n  key.indexer.callback.kind: indexer.callback.settings-for-indexable\r\n}\r\n2019-11-20 19:58:29.823 Xcode[42672:35683197] SourceKit-client: [2:notification:112191:1487.3692] {\r\n  key.notification: indexer.callback,\r\n  key.indexer.arg.indexer-token: 3,\r\n  key.indexer.callback.kind: notification.index.unit-tests-did-change\r\n}\r\n2019-11-20 19:58:32.093 Xcode[42672:35682797] SourceKit-client: [2:callback-reply:112191:1489.6383] {\r\n  key.indexer.arg.indexable.settings: \"<DATA>\"\r\n}\r\n2019-11-20 19:58:32.093 Xcode[42672:35682797] SourceKit-client: [2:callback-info:244023:1489.6390] {\r\n  key.callback: indexer.callback,\r\n  key.indexer.arg.indexer-token: 3,\r\n  key.indexer.arg.indexable.id: \"/Users/xxxxxx.xcodeproj/SomeTarget2Tests-6513A858D802FE4E1691FD7E\",\r\n  key.indexer.callback.kind: indexer.callback.settings-for-indexable\r\n}\r\n...\r\n```\r\n\r\n*Known workarounds:*\r\n* I tried to remove some test targets (and let only 300 of them) ->  reindexing doesn't occur after reopening the project and no mentioned warning is printed just after opening the project (:tada:)\r\n* reindexing issue doesn't occur when Legacy Build System is enabled, even for 600 targets project\r\n\r\n\r\nXcode: Version 11.1 (11A1027)\r\nOS: 10.14.6 (18G103)\r\nMacBook Pro (15-inch, 2019)\r\n2,4 GHz Intel Core i9\r\n16 GB 2400 MHz DDR4\r\nPlease list the steps you took to reproduce the issue:\r\n* Open attached project on Xcode with enabled sourcekit logs (`SOURCEKIT_LOGGING=3 /Applications/Xcode.app/Contents/MacOS/Xcode`)\r\n* Observe first warning: \r\n```\r\n2019-11-20 20:19:09.419 Xcode[42672:35650514] [MT] DVTAssertions: Warning in /Library/Caches/com.apple.xbs/Sources/IDEFrameworks/IDEFrameworks-15405/IDEKit/NavigableItems/IDENavigableItem.m:1230\r\nDetails:  No match from <IDEKeyDrivenNavigableItem 0x7fdeb3f59950: (supports Any NSObject, represents: <Xcode3EditingGroup: 0x7fdeb3f5f9b0>)> to <Xcode3Target:0x7fdedd1635d0:LotTargets copy 660>. Iterating the whole tree might have taken a significant amount of time.\r\nObject:   <IDEKeyDrivenNavigableItem_Xcode3EditingGroup_Any: 0x7fdeb3f59950>\r\nMethod:   -_descendantItemForRepresentedObject:stopAtClass:\r\nThread:   <NSThread: 0x7fdeeec06700>{number = 1, name = main}\r\nPlease file a bug at https://feedbackassistant.apple.com with this warning message and any useful information you can provide.\r\n2019-11-20 20:19:09.605 Xcode[42672:35650514] [MT] DVTAssertions: Warning in /Library/Caches/com.apple.xbs/Sources/IDEFrameworks/IDEFrameworks-15405/IDEKit/NavigableItems/IDENavigableItemCoordinator.m:206\r\nDetails:  Over 500 root items in navigable item coordinator: <DVTStackBacktrace: 0x7fdebabdc820>\r\nObject:   <IDENavigableItemCoordinator: 0x7fdebabdcec0>\r\nMethod:   -_rootNavigableItemsWithRepresentedObjects:\r\nThread:   <NSThread: 0x7fdeeec06700>{number = 1, name = main}\r\nPlease file a bug at https://feedbackassistant.apple.com with this warning message and any useful information you can provide.\r\n2019-11-20 20:19:09.754 Xcode[42672:35650514] [MT] DVTAssertions: Warning in /Library/Caches/com.apple.xbs/Sources/IDEFrameworks/IDEFrameworks-15405/IDEKit/NavigableItems/IDENavigableItem.m:1230\r\nDetails:  No match from <IDEKeyDrivenNavigableItem 0x7fdeb3f59950: (supports Any NSObject, represents: <Xcode3EditingGroup: 0x7fdeb3f5f9b0>)> to <Xcode3Target:0x7fdedd1635d0:LotTargets copy 660>. Iterating the whole tree might have taken a significant amount of time.\r\nObject:   <IDEKeyDrivenNavigableItem_Xcode3EditingGroup_Any: 0x7fdeb3f59950>\r\nMethod:   -_descendantItemForRepresentedObject:stopAtClass:\r\nThread:   <NSThread: 0x7fdeeec06700>{number = 1, name = main}\r\nPlease file a bug at https://feedbackassistant.apple.com with this warning message and any useful information you can provide.\r\n```\r\n* wait until Xcode indicates finished indexing and wait until CPU becomes idle (on MacBookPro 15, i9 takes around 3 minutes)\r\n* reopen given project\r\n* wait until Xcode indicates finished indexing \r\n* observe CPU usage (around 200% on my machine) \r\n* Look for sourcekit logs that suggests some indexing\r\n```\r\n2019-11-20 20:22:04.732 Xcode[42672:35701281] SourceKit-client: [2:notification:649811:2902.2782] {\r\n  key.notification: indexer.callback,\r\n  key.indexer.arg.indexer-token: 6,\r\n  key.indexer.callback.kind: indexer.callback.on-did-index-workspace\r\n}\r\n2019-11-20 20:22:04.734 Xcode[42672:35701281] SourceKit-client: [2:request:775:2902.2793] [185425] {\r\n  key.request: source.request.indexer.set-throttle-factor,\r\n  key.indexer.arg.throttle-factor: 1.000000e+00,\r\n  key.indexer.arg.indexer-token: 6\r\n}\r\n2019-11-20 20:22:04.734 Xcode[42672:35701281] SourceKit-client: [2:response:649811:2902.2795] [185425] {\r\n}\r\nd2019-11-20 20:22:05.703 Xcode[42672:35701354] SourceKit-client: [2:callback-info:649811:2903.2493] {\r\n  key.callback: indexer.callback,\r\n  key.indexer.arg.indexer-token: 6,\r\n  key.indexer.arg.indexable.id: \"/tmp/LotTargets/LotTargets.xcodeproj/LotTargetsTests copy 23-36B0DC5E2385C98500F0B9DE\",\r\n  key.indexer.callback.kind: indexer.callback.settings-for-indexable\r\n}\r\n...\r\n```\r\nWhat did you expect to happen?\r\n1. I expect no extra reindexing happens every time I reopen Xcode project. \r\n2. UI should inform that indexing still happens and its progress\r\nWhat actually happened?\r\n1. Extensive CPU usage after each project reopens\r\n2. Xcode shows in a UI that it is no longer indexing, what is not true"
    email: bartoszp@spotify.com
    modified: "2020-03-11T19:50:23.239696Z"
    number: FB7458169
    number_intvalue: 7458169
    originated: 20/11/2019
    parent_number: '&{NULL_VALUE}'
    product: Xcode
    product_version: "11.1"
    reproducible: 100%
    resolved: ""
    status: Open
    title: Reindexing source when more than 500 Xcode targets in a project
