apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: FB7537097
    labels:
        datastore_id: "4955844437344256"
data:
    classification: Crash
    created: "2020-01-20T00:37:16.849937Z"
    description: "I’m trying to create an NSCollectionView using the new NSCollectionViewDiffableDataSource on macOS.\r\n\r\nI am dynamically loading/changing the sections and items over an API so the sections will potentially change with every update. My section and item identifier models are Hashable with UUIDs as recommended in the WWDC video.\r\n\r\nI get a crash when I try to apply a snapshot and animate the changes in the recommended way.\r\n\r\nYou can see a StackOverflow question that has exactly the same problem as me and includes a sample project: https://stackoverflow.com/questions/58792252/appending-sections-in-nscollectionviewdiffabledatasource\r\n\r\nBut this is the gist of it:\r\n\r\n```swift\r\n    private func updateDataSource(sections: [Section]) {\r\n        var snapshot = NSDiffableDataSourceSnapshot<Section, Item>()\r\n        for section in sections {\r\n            snapshot.appendSections([section])\r\n            snapshot.appendItems(section.items, toSection: section)\r\n        }\r\n        self.dataSource.apply(snapshot, animatingDifferences: true)\r\n    }\r\n```\r\n\r\nI get a crash on the line where I apply the snapshot:\r\n\r\n```\r\n2020-01-15 21:53:10.623388+0000 Lux-Mac[28949:943873] [General] An uncaught exception was raised\r\n2020-01-15 21:53:10.623441+0000 Lux-Mac[28949:943873] [General] -[NSCollectionView insertSections:] Section index 1 out of bounds\r\n2020-01-15 21:53:10.623532+0000 Lux-Mac[28949:943873] [General] (\r\n\t0   CoreFoundation                      0x00007fff336518ab __exceptionPreprocess + 250\r\n\t1   libobjc.A.dylib                     0x00007fff69729805 objc_exception_throw + 48\r\n\t2   CoreFoundation                      0x00007fff33651701 +[NSException raise:format:] + 189\r\n\t3   UIFoundation                        0x00007fff64273d93 -[_NSCollectionViewCore insertSections:] + 267\r\n\t4   UIFoundation                        0x00007fff6423db2e -[_NSDiffableDataSourceViewUpdater _performNSCollectionViewInsertUpdate:] + 222\r\n\t5   UIFoundation                        0x00007fff6423d903 -[_NSDiffableDataSourceViewUpdater _performViewUpdates:] + 594\r\n\t6   AppKit                              0x00007fff3110086c __58-[NSCollectionView performBatchUpdates:completionHandler:]_block_invoke + 21\r\n\t7   UIFoundation                        0x00007fff6427ec1d -[_NSCollectionViewCore _performBatchUpdates:completion:invalidationContext:tentativelyForReordering:animator:] + 323\r\n\t8   UIFoundation                        0x00007fff6427eab7 -[_NSCollectionViewCore _performBatchUpdates:completion:invalidationContext:tentativelyForReordering:] + 90\r\n\t9   UIFoundation                        0x00007fff6427ea3a -[_NSCollectionViewCore _performBatchUpdates:completion:invalidationContext:] + 74\r\n\t10  UIFoundation                        0x00007fff6427e98f -[_NSCollectionViewCore performBatchUpdates:completion:] + 53\r\n\t11  AppKit                              0x00007fff31100778 -[NSCollectionView performBatchUpdates:completionHandler:] + 282\r\n\t12  UIFoundation                        0x00007fff6423d0ce -[_NSDiffableDataSourceViewUpdater _performUpdateWithCollectionViewUpdateItems:dataSourceSnapshotter:updateHandler:completion:] + 528\r\n\t13  UIFoundation                        0x00007fff6429a41e -[__NSDiffableDataSource _commitNewDataSource:withViewUpdates:completion:] + 265\r\n\t14  UIFoundation                        0x00007fff64294e35 __66-[__NSDiffableDataSource applyDifferencesFromSnapshot:completion:]_block_invoke.259 + 190\r\n\t15  UIFoundation                        0x00007fff6429514e __66-[__NSDiffableDataSource applyDifferencesFromSnapshot:completion:]_block_invoke.284 + 170\r\n\t16  libdispatch.dylib                   0x000000010088078f _dispatch_client_callout + 8\r\n\t17  libdispatch.dylib                   0x00000001008914cb _dispatch_lane_barrier_sync_invoke_and_complete + 135\r\n\t18  UIFoundation                        0x00007fff642948a9 -[__NSDiffableDataSource applyDifferencesFromSnapshot:completion:] + 842\r\n\t19  UIFoundation                        0x00007fff64322d8f +[_NSUIAnimator performWithAnimation:] + 90\r\n\t20  UIFoundation                        0x00007fff64295ab5 -[__NSDiffableDataSource applyDifferencesFromSnapshot:animatingDifferences:completion:] + 158\r\n\t21  libswiftAppKit.dylib                0x00007fff69ec4bb3 $s6AppKit34NSCollectionViewDiffableDataSourceC5apply_20animatingDifferences10completionyAA010NSDiffablefG8SnapshotVyxq_G_SbyycSgtF + 211\r\n\t22  Lux-Mac                             0x0000000100014fdc $s7Lux_Mac25YearBrowserViewControllerC16updateDataSource33_EF98DAE265F06E6EB66B46FEA4E9CD66LL_9animatingySayAA0C0VG_SbtF + 3196\r\n\t23  Lux-Mac                             0x00000001000141df $s7Lux_Mac25YearBrowserViewControllerC04loadE0yyFySayAA0C0VGcfU_ + 63\r\n\t24  Lux-Mac                             0x000000010001425f $sSay7Lux_Mac4YearVGIegg_ADIegn_TR + 15\r\n\t25  Combine                             0x00007fff327f3083 $s7Combine11SubscribersO4SinkC7receiveyAC6DemandVxF + 35\r\n\t26  Combine                             0x00007fff327f32c0 $s7Combine11SubscribersO4SinkCy_xq_GAA10SubscriberA2aGP7receiveyAC6DemandV5InputQzFTW + 16\r\n\t27  Combine                             0x00007fff328274a8 $s7Combine10PublishersO9ReceiveOnV5Inner33_1178A6B2012BC46DB46053E713A746B4LLC7receiveyAA11SubscribersO6DemandV6OutputQzFyycfU_ + 248\r\n\t28  Combine                             0x00007fff3282a4b1 $s7Combine10PublishersO9ReceiveOnV5Inner33_1178A6B2012BC46DB46053E713A746B4LLC7receive10completionyAA11SubscribersO10CompletionOy_7FailureQzG_tFyycfU_TATm + 49\r\n\t29  libswiftFoundation.dylib            0x00007fff6a5ddfa9 $sIeg_IeyB_TR + 25\r\n\t30  CoreFoundation                      0x00007fff335d57ab __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__ + 12\r\n\t31  CoreFoundation                      0x00007fff335d56ed __CFRunLoopDoBlocks + 379\r\n\t32  CoreFoundation                      0x00007fff335d4d30 __CFRunLoopRun + 2792\r\n\t33  CoreFoundation                      0x00007fff335d3bd3 CFRunLoopRunSpecific + 499\r\n\t34  HIToolbox                           0x00007fff3212a65d RunCurrentEventLoopInMode + 292\r\n\t35  HIToolbox                           0x00007fff3212a2a9 ReceiveNextEventCommon + 356\r\n\t36  HIToolbox                           0x00007fff3212a127 _BlockUntilNextEventMatchingListInModeWithFilter + 64\r\n\t37  AppKit                              0x00007fff3079beb4 _DPSNextEvent + 990\r\n\t38  AppKit                              0x00007fff3079a690 -[NSApplication(NSEvent) _nextEventMatchingEventMask:untilDate:inMode:dequeue:] + 1352\r\n\t39  AppKit                              0x00007fff3078c3ae -[NSApplication run] + 658\r\n\t40  AppKit                              0x00007fff3075e775 NSApplicationMain + 777\r\n\t41  Lux-Mac                             0x000000010002c94d main + 13\r\n\t42  libdyld.dylib                       0x00007fff6aa977fd start + 1\r\n\t43  ???                                 0x0000000000000003 0x0 + 3\r\n)\r\n2020-01-15 21:53:10.624371+0000 Lux-Mac[28949:943873] *** Terminating app due to uncaught exception 'NSRangeException', reason: '-[NSCollectionView insertSections:] Section index 1 out of bounds'\r\n*** First throw call stack:\r\n(\r\n\t0   CoreFoundation                      0x00007fff336518ab __exceptionPreprocess + 250\r\n\t1   libobjc.A.dylib                     0x00007fff69729805 objc_exception_throw + 48\r\n\t2   CoreFoundation                      0x00007fff33651701 +[NSException raise:format:] + 189\r\n\t3   UIFoundation                        0x00007fff64273d93 -[_NSCollectionViewCore insertSections:] + 267\r\n\t4   UIFoundation                        0x00007fff6423db2e -[_NSDiffableDataSourceViewUpdater _performNSCollectionViewInsertUpdate:] + 222\r\n\t5   UIFoundation                        0x00007fff6423d903 -[_NSDiffableDataSourceViewUpdater _performViewUpdates:] + 594\r\n\t6   AppKit                              0x00007fff3110086c __58-[NSCollectionView performBatchUpdates:completionHandler:]_block_invoke + 21\r\n\t7   UIFoundation                        0x00007fff6427ec1d -[_NSCollectionViewCore _performBatchUpdates:completion:invalidationContext:tentativelyForReordering:animator:] + 323\r\n\t8   UIFoundation                        0x00007fff6427eab7 -[_NSCollectionViewCore _performBatchUpdates:completion:invalidationContext:tentativelyForReordering:] + 90\r\n\t9   UIFoundation                        0x00007fff6427ea3a -[_NSCollectionViewCore _performBatchUpdates:completion:invalidationContext:] + 74\r\n\t10  UIFoundation                        0x00007fff6427e98f -[_NSCollectionViewCore performBatchUpdates:completion:] + 53\r\n\t11  AppKit                              0x00007fff31100778 -[NSCollectionView performBatchUpdates:completionHandler:] + 282\r\n\t12  UIFoundation                        0x00007fff6423d0ce -[_NSDiffableDataSourceViewUpdater _performUpdateWithCollectionViewUpdateItems:dataSourceSnapshotter:updateHandler:completion:] + 528\r\n\t13  UIFoundation                        0x00007fff6429a41e -[__NSDiffableDataSource _commitNewDataSource:withViewUpdates:completion:] + 265\r\n\t14  UIFoundation                        0x00007fff64294e35 __66-[__NSDiffableDataSource applyDifferencesFromSnapshot:completion:]_block_invoke.259 + 190\r\n\t15  UIFoundation                        0x00007fff6429514e __66-[__NSDiffableDataSource applyDifferencesFromSnapshot:completion:]_block_invoke.284 + 170\r\n\t16  libdispatch.dylib                   0x000000010088078f _dispatch_client_callout + 8\r\n\t17  libdispatch.dylib                   0x00000001008914cb _dispatch_lane_barrier_sync_invoke_and_complete + 135\r\n\t18  UIFoundation                        0x00007fff642948a9 -[__NSDiffableDataSource applyDifferencesFromSnapshot:completion:] + 842\r\n\t19  UIFoundation                        0x00007fff64322d8f +[_NSUIAnimator performWithAnimation:] + 90\r\n\t20  UIFoundation                        0x00007fff64295ab5 -[__NSDiffableDataSource applyDifferencesFromSnapshot:animatingDifferences:completion:] + 158\r\n\t21  libswiftAppKit.dylib                0x00007fff69ec4bb3 $s6AppKit34NSCollectionViewDiffableDataSourceC5apply_20animatingDifferences10completionyAA010NSDiffablefG8SnapshotVyxq_G_SbyycSgtF + 211\r\n\t22  Lux-Mac                             0x0000000100014fdc $s7Lux_Mac25YearBrowserViewControllerC16updateDataSource33_EF98DAE265F06E6EB66B46FEA4E9CD66LL_9animatingySayAA0C0VG_SbtF + 3196\r\n\t23  Lux-Mac                             0x00000001000141df $s7Lux_Mac25YearBrowserViewControllerC04loadE0yyFySayAA0C0VGcfU_ + 63\r\n\t24  Lux-Mac                             0x000000010001425f $sSay7Lux_Mac4YearVGIegg_ADIegn_TR + 15\r\n\t25  Combine                             0x00007fff327f3083 $s7Combine11SubscribersO4SinkC7receiveyAC6DemandVxF + 35\r\n\t26  Combine                             0x00007fff327f32c0 $s7Combine11SubscribersO4SinkCy_xq_GAA10SubscriberA2aGP7receiveyAC6DemandV5InputQzFTW + 16\r\n\t27  Combine                             0x00007fff328274a8 $s7Combine10PublishersO9ReceiveOnV5Inner33_1178A6B2012BC46DB46053E713A746B4LLC7receiveyAA11SubscribersO6DemandV6OutputQzFyycfU_ + 248\r\n\t28  Combine                             0x00007fff3282a4b1 $s7Combine10PublishersO9ReceiveOnV5Inner33_1178A6B2012BC46DB46053E713A746B4LLC7receive10completionyAA11SubscribersO10CompletionOy_7FailureQzG_tFyycfU_TATm + 49\r\n\t29  libswiftFoundation.dylib            0x00007fff6a5ddfa9 $sIeg_IeyB_TR + 25\r\n\t30  CoreFoundation                      0x00007fff335d57ab __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__ + 12\r\n\t31  CoreFoundation                      0x00007fff335d56ed __CFRunLoopDoBlocks + 379\r\n\t32  CoreFoundation                      0x00007fff335d4d30 __CFRunLoopRun + 2792\r\n\t33  CoreFoundation                      0x00007fff335d3bd3 CFRunLoopRunSpecific + 499\r\n\t34  HIToolbox                           0x00007fff3212a65d RunCurrentEventLoopInMode + 292\r\n\t35  HIToolbox                           0x00007fff3212a2a9 ReceiveNextEventCommon + 356\r\n\t36  HIToolbox                           0x00007fff3212a127 _BlockUntilNextEventMatchingListInModeWithFilter + 64\r\n\t37  AppKit                              0x00007fff3079beb4 _DPSNextEvent + 990\r\n\t38  AppKit                              0x00007fff3079a690 -[NSApplication(NSEvent) _nextEventMatchingEventMask:untilDate:inMode:dequeue:] + 1352\r\n\t39  AppKit                              0x00007fff3078c3ae -[NSApplication run] + 658\r\n\t40  AppKit                              0x00007fff3075e775 NSApplicationMain + 777\r\n\t41  Lux-Mac                             0x000000010002c94d main + 13\r\n\t42  libdyld.dylib                       0x00007fff6aa977fd start + 1\r\n\t43  ???                                 0x0000000000000003 0x0 + 3\r\n)\r\nlibc++abi.dylib: terminating with uncaught exception of type NSException\r\n```\r\n\r\nI do not get a crash if I don’t animate the changes, or if I don’t change the sections between snapshots.\r\n\r\nI have ported the code to iOS/UIKit and it works fine, so this looks like a bug in the macOS implementation of NSCollectionViewDiffableDataSource."
    email: dcutting@gmail.com
    modified: "2020-01-20T00:37:16.850114Z"
    number: FB7537097
    number_intvalue: 7537097
    originated: 15/Jan/2020
    parent_number: '&{NULL_VALUE}'
    product: AppKit
    product_version: Catalina
    reproducible: Yes
    resolved: ""
    status: Open
    title: NSCollectionViewDiffableDataSource crashes when applying snapshot with different sections to previous snapshot
