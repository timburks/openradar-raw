apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: FB8940785
    labels:
        datastore_id: "5004853772288000"
data:
    classification: Incorrect/Unexpected Behavior
    created: "2020-12-15T10:56:04.68322Z"
    description: "Basic Information\r\nWhich area are you seeing an issue with?\r\nInstallation/Setup/Migration/Recovery\r\nPlease provide a descriptive title for your feedback:\r\nInstallEnterpriseApplication package install gets cancelled when Setup Assistant is completed too quickly\r\nWhat type of issue are you reporting?\r\nIncorrect/Unexpected Behavior\r\nDetails\r\nWhat does the installation/setup/migration/recovery issue you are seeing involve?\r\nFirst boot after installation\r\nWhat build of macOS were you upgrading from?\r\nNone. Fresh install of 11.1 (20C69)\r\nWhat time was it when this last occurred? (Example: 12:00 pm EST 02/14/2018)\r\n10:00 am CET 12/15/2020\r\nDescription\r\nPlease describe the issue and what steps we can take to reproduce it:\r\n# Problem\r\n\r\nWe are testing Automated Device Enrollment with macOS 11.X Big Sur. Our MDM sends two InstallEnterpriseApplication commands right after the enrollment (before DeviceConfigured command) in the Remote Management pane of the Setup Assistant. Goal is to install two packages (33MB and 98MB). \r\n\r\nWe encountered a problem where package installation gets cancelled and not a single one of these packages is installed.\r\n\r\n# Reproducibility\r\n\r\nI can reproduce this issue at will on a physical Mac (MacBook Air I am reporting from) or VMware Fusion VM. Issue occurs on both macOS public releases:\r\n\r\n- 11.1 (20C69)\r\n- 11.0.1 (20850)\r\n\r\n# Steps to reproduce\r\n\r\nThere are video attachments where I reproduce this.\r\n\r\n1. Prepare DEP cloud profile for device. All SetupAssistant panes are to be skipped except for the Create Computer Account and Location Services steps.\r\n2. Erase the Mac and install macOS 11.1 (20C69) or 11.0.1 (20850). \r\n3. Boot up the Mac. Setup Assistant in presented.\r\n4. Set Country or Region to Czechia (This might be very important since it initiates the locale change (to cs_CZ))\r\n5. Hit \"Continue on Written\" and Spoken languages pane\r\n6. Hit \"Not Now\" on Accessibility pane\r\n7. Hit \"Continue\" on Remote Management pane. Classic (HTTP DIGEST) authentication is required\r\n8. On Create a Computer Account pane all fields (except Hint) are prefilled (usernames from MDM, password by SetupAssistant since it knows it from previous step). Hit \"Continue\" (It is important to Hit continue as quickly as possible since the problem is time sensitive)\r\n9. Location service pane is presented. Enable the location services and continue.\r\n10. User is automatically logged into his account\r\n\r\nNote: In my testing the problem occurs when I complete these steps as quickly as possible. Especially the step (8) Create c Computer Account. More on that later in Leads section.\r\n\r\n# Expected result\r\n\r\nBoth packages sent via InstallEnterpriseApplication command get installed\r\n\r\n# Actual result\r\n\r\n1. Packages sent via InstallEnterpriseApplication are successfully downloaded to the cache directory /var/folder/zz/<randomstring>/C/com.apple.appstore/<UUID>/<UUID>.pkg,\r\n2. Installation of first package is started. See in the /var/log/install.log:\r\n\r\n> 2020-12-15 01:18:32-08 MacBook-Air installd[433]: PackageKit: ----- Begin install -----\r\n> 2020-12-15 01:18:32-08 MacBook-Air installd[433]: PackageKit: request=PKInstallRequest <1 packages, destination=/, MDMManagedAppInstall=YES>\r\n> 2020-12-15 01:18:32-08 MacBook-Air installd[433]: PackageKit: packages=(\r\n\t    \"PKLeopardPackage <id=cz.logicworks.installapplications-logicworks-testing, version=2.2.0, url=file:///var/folders/zz/zyxvpxvq6csfxvn_n0000044000011/C/com.apple.appstore/07D77A4E-40E8-45B3-9D67-757C0D6E18D4/85225076-2ec7-42e2-ac93-cdd816d0dcdd.pkg#InstallApplications_LogicworksTesting-2.2.0.pkg>\"\r\n\r\n3. Installation of the first package gets cancelled. /var/log/install.log says:\r\n\r\n> 2020-12-15 10:19:15+01 Johns-MacBook-Air installd[433]: PackageKit: Cleared responsibility for install from 775.\r\n> 2020-12-15 10:19:15+01 Johns-MacBook-Air installd[433]: PackageKit: Failed to get responsibility for client 775. Will skip Installer.app check.\r\n> 2020-12-15 10:19:16+01 Johns-MacBook-Air installd[433]: PackageKit: ----- Cancelled install -----\r\n\r\n4. Installation of the second package is not even attempted. No mention of it in install.log.\r\n\r\n# Workaround\r\n\r\n- (100%) Do not complete the Create a Computer Account pane and wait until packages are installed. \r\n- (Most of time) Do ~10 second pause before completing the Create a Computer Account pane. Packages usually get installed if user does not advance quickly through this pane quickly. \r\n\r\n# Leads\r\n## appstored stopped due to locale change\r\n\r\nI think this is a root cause of the problem. At least if I read logs correctly.\r\n\r\nThere is this error in the system log:\r\n> 2020-12-15 01:18:50.185966-0800 0x20db     Error       0x0                  775    14   appstored: [com.apple.appstored:Daemon] Received locale change, stopping appstored\r\n\r\nWhen this happens during the early stage of the package install, install gets canceled. \"Received locale change, stopping appstored\" happens right after the Create a Computer Account pane. If there is a another pane after the Create a Computer Account for example Location Services problem happens during the transition in between these two.\r\n\r\nWhen you compare /var/log/install.log and appstored output to system log you can see PID (775) is the same in both logs.\r\n\r\nLet’s recap what’s happening\r\n\r\n1. On Remote Management pane, Mac receives the InstallEnterpriseApplication commands and begins downloading the packages in the background and then installs them. appstored is critical process involved in this.\r\n2. Right after Create computer account pane locale change is initiated which results in stopping the appstored.\r\n3. If timing is correct (user is very fast) package install is cancelled possible due to the appstored stopping.\r\n\r\n## Software update\r\n\r\nmacOS is also installing MRT and XProtect packages during the Setup Assistant. In my testing I leave them to be installed before the MDM enrolment on Remote Management pane so these installs don’t interfere.\r\nFile Uploads\r\n11.0.1_install_works_with_different_user_timing.mov\r\n97.49 MB Dec 15, 2020 at 10:59 AM\r\nsysdiagnose_2020.12.15_10-33-26+0100_macOS_MacBookAir8-1_20C69.tar.gz\r\n115.59 MB Dec 15, 2020 at 10:59 AM\r\n11.0.1_install_gets_cancelled.mov\r\n84.86 MB Dec 15, 2020 at 10:59 AM\r\n11.1_install_gets_cancelled.mov\r\n84.25 MB Dec 15, 2020 at 10:59 AM\r\nall_log.txt\r\n49.11 MB Dec 15, 2020 at 10:59 AM\r\nSystem_Profile_full.spx\r\n4.21 MB Dec 15, 2020 at 10:59 AM\r\nManaged Applications.zip\r\n2.03 KB Dec 15, 2020 at 10:59 AM\r\nappstored_log.txt\r\n145.96 KB Dec 15, 2020 at 10:59 AM\r\ninstall.log\r\n165.67 KB Dec 15, 2020 at 10:59 AM"
    email: michalm.mac@gmail.com
    modified: "2021-10-06T15:56:11.829306Z"
    number: FB8940785
    number_intvalue: 8940785
    originated: 15.12.2020
    parent_number: '&{NULL_VALUE}'
    product: macOS
    product_version: 11.1 (20C69)
    reproducible: Always
    resolved: Potential fix identified - In macOS 11.4
    status: Closed
    title: InstallEnterpriseApplication package install gets cancelled when Setup Assistant is completed too quickly
