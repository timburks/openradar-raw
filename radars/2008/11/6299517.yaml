apiVersion: openapi/v1alpha1
kind: Radar
metadata:
    name: "6299517"
    labels:
        datastore_id: "687"
data:
    classification: Crash/Hang/Data Loss
    created: "2008-11-24T10:31:51.576522Z"
    description: "16-Oct-2008 04:46 PM Jonas Witt:\r\nSummary:\r\n\r\nCFURLConnection sometimes crashes our app in a backtrace similar to this one: \r\n\r\nThread 13 Crashed:\r\n0   libobjc.A.dylib               \t0x91605688 objc_msgSend + 24\r\n1   com.apple.CFNetwork           \t0x91df2dde createNotificationName + 111\r\n2   com.apple.CFNetwork           \t0x91df31cc __PrivateCookieStorageDeallocate + 47\r\n3   com.apple.CoreFoundation      \t0x955cf788 _CFRelease + 216\r\n4   com.apple.CFNetwork           \t0x91df3166 __CFHTTPCookieStorageDeallocate + 21\r\n5   com.apple.CoreFoundation      \t0x955cf788 _CFRelease + 216\r\n6   com.apple.CFNetwork           \t0x91da80da _CFURLRequestDeallocate + 149\r\n7   com.apple.CoreFoundation      \t0x955cf788 _CFRelease + 216\r\n8   com.apple.CFNetwork           \t0x91df4ba0 __CFCachedURLResponse::~__CFCachedURLResponse() + 100\r\n9   com.apple.CoreFoundation      \t0x955cf788 _CFRelease + 216\r\n10  com.apple.CFNetwork           \t0x91df5120 __CFURLCacheNode::~__CFURLCacheNode() + 48\r\n11  com.apple.CFNetwork           \t0x91da9b69 __CFURLCache::CopyResponseForRequest(_CFURLRequest const*) + 599\r\n12  com.apple.CFNetwork           \t0x91da8eae _CFURLConnectionSendCallbacks + 1037\r\n13  com.apple.CFNetwork           \t0x91da8a25 muxerSourcePerform + 283\r\n14  com.apple.CoreFoundation      \t0x955cd615 CFRunLoopRunSpecific + 3141\r\n15  com.apple.CoreFoundation      \t0x955cdcf8 CFRunLoopRunInMode + 88\r\n16  de.metaquark.appfresh         \t0x0003d7b4 -[IUConnectionTask workerReturnError:] + 569\r\n17  de.metaquark.appfresh         \t0x0001ad16 -[IUTask dispatchTask:] + 340\r\n18  com.apple.Foundation          \t0x903bebad -[NSThread main] + 45\r\n19  com.apple.Foundation          \t0x903be754 __NSThread__main__ + 308\r\n20  libSystem.B.dylib             \t0x932426f5 _pthread_start + 321\r\n21  libSystem.B.dylib             \t0x932425b2 thread_start + 34\r\n\r\nIn code like this:\r\n\r\n- (BOOL)workerReturnError:(NSError**)error\r\n{\r\n\t...\r\n\tconnection = [[NSURLConnection alloc] initWithRequest:request delegate:self];\r\n\r\n\tthreadRunning = YES;\r\n\twhile (!needToCancel && threadRunning)\r\n\t\tCFRunLoopRunInMode(kCFRunLoopDefaultMode, 1, YES);\r\n\t...\r\n}\r\n\r\nWhere we have a method detached using NSThread running an NSURLConnection and waiting for callbacks to that object before returning from that method.\r\n\r\nSteps to Reproduce:\r\n\r\n* That crash is not easily reproducible, and occurrs roughly 1 in 100 times running our app - on our machines, on our customer's machines, ...\r\n\r\nExpected Results:\r\n\r\n* CFURLConnection shouldn't crash when deallocating its cookie storage.\r\n\r\nActual Results:\r\n\r\n* CFURLConnection crashes when used in a proper way (as far as I can tell)\r\n\r\nRegression:\r\n\r\n* Unknown\r\n\r\nNotes:\r\n\r\nAttached are 3 crash logs that illustrate the problem\r\n\r\n\r\n\r\n\r\n'Archive.zip' and 'rho.zip' were successfully uploaded\r\n\r\n18-Oct-2008 05:59 AM Jonas Witt:\r\nWhen run with NSZombieEnabled, I get the following right before the crash:\r\n\r\n*** -[CFURL _cfurl]: message sent to deallocated instance 0x876c40\r\n\r\nBut as far as I have checked, my code has never created or touched an object at that address.\r\n\r\nIs there any know workaround for this issue?\r\n\r\n18-Oct-2008 09:16 AM Jonas Witt:\r\nAnother note: I am now in a situation where I can run a headless subset of my application's code in gdb and reproduce this problem with near certainty. I'd love to provide more information or perform debugging if requested.\r\n\r\n19-Oct-2008 06:50 AM Jonas Witt:\r\nI tried two things to get rid of the cookie handling in the hope that this would fix the crash:\r\n\r\n1) set -[NSMutableURLRequest setHTTPShouldHandleCookies:] to NO on my requests\r\n\r\n2) modify +[NSHTTPCookieStorage sharedHTTPCookieStorage] to return nil\r\n\r\nNeither did help. I couldn't get hold of the underlying CFNetwork cookie stuff yet, since it's not public."
    email: jonas.witt@gmail.com
    modified: "2011-08-28T05:49:34.345614Z"
    number: "6299517"
    number_intvalue: 6299517
    originated: 16-Oct-2008
    parent_number: "6273822"
    product: Mac OS X
    product_version: 10.5.5
    reproducible: Yes
    resolved: ""
    status: Duplicate/6273822
    title: CFNetwork __PrivateCookieStorageDeallocate() crash
